#!/usr/bin/env python3
"""
SynchroGaea Server  v3
  App  TCP  → :9999
  Web  UI   → http://0.0.0.0:8080
  WebSocket → :8765

Requires: pip install websockets
"""

import asyncio
import struct
import threading
import json
import sys
import ssl
import tempfile
import os
import time
import hashlib
import getpass
import base64
from http.server import HTTPServer, BaseHTTPRequestHandler
from datetime import datetime

class _EventTime:
    def __str__(self):
        return datetime.now().strftime("%Y-%m-%d %H:%M:%S")

EVENT_TIME = _EventTime()

RESET   = "\033[0m"
BOLD    = "\033[1m"
GREEN   = "\033[92m"
CYAN    = "\033[96m"
YELLOW  = "\033[93m"
MAGENTA = "\033[95m"
RED     = "\033[91m"

TCP_PORT  = 9999
HTTP_PORT = 8080
WS_PORT   = 8765
MAX_PAYLOAD = 64_000_000 #16_000_000
TCP_READER_LIMIT = 128 * 1024
_ws_clients: set   = set()
_android_writer    = None
_FRAME_HDR  = bytes([1])
_AUDIO_HDR  = bytes([2])
_LOG_HDR    = bytes([255])
_BANNED_IPS = {}
HTML = """<!DOCTYPE html>
<html lang="en">
<head>
<!-- <script src="https://cdn.jsdelivr.net/npm/jmuxer@2.1.0/dist/jmuxer.min.js"></script> -->
<script type="text/javascript">
(function() {
    var b64Data = "KGZ1bmN0aW9uIChnbG9iYWwsIGZhY3RvcnkpIHsKICB0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcgPyBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkocmVxdWlyZSgnc3RyZWFtJykpIDoKICB0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQgPyBkZWZpbmUoWydzdHJlYW0nXSwgZmFjdG9yeSkgOgogIChnbG9iYWwgPSB0eXBlb2YgZ2xvYmFsVGhpcyAhPT0gJ3VuZGVmaW5lZCcgPyBnbG9iYWxUaGlzIDogZ2xvYmFsIHx8IHNlbGYsIGdsb2JhbC5KTXV4ZXIgPSBmYWN0b3J5KGdsb2JhbC5zdHJlYW0pKTsKfSkodGhpcywgKGZ1bmN0aW9uIChzdHJlYW0pIHsgJ3VzZSBzdHJpY3QnOwoKICBmdW5jdGlvbiBfYXJyYXlMaWtlVG9BcnJheShyLCBhKSB7CiAgICAobnVsbCA9PSBhIHx8IGEgPiByLmxlbmd0aCkgJiYgKGEgPSByLmxlbmd0aCk7CiAgICBmb3IgKHZhciBlID0gMCwgbiA9IEFycmF5KGEpOyBlIDwgYTsgZSsrKSBuW2VdID0gcltlXTsKICAgIHJldHVybiBuOwogIH0KICBmdW5jdGlvbiBfYXJyYXlXaXRoSG9sZXMocikgewogICAgaWYgKEFycmF5LmlzQXJyYXkocikpIHJldHVybiByOwogIH0KICBmdW5jdGlvbiBfYXJyYXlXaXRob3V0SG9sZXMocikgewogICAgaWYgKEFycmF5LmlzQXJyYXkocikpIHJldHVybiBfYXJyYXlMaWtlVG9BcnJheShyKTsKICB9CiAgZnVuY3Rpb24gX2Fzc2VydFRoaXNJbml0aWFsaXplZChlKSB7CiAgICBpZiAodm9pZCAwID09PSBlKSB0aHJvdyBuZXcgUmVmZXJlbmNlRXJyb3IoInRoaXMgaGFzbid0IGJlZW4gaW5pdGlhbGlzZWQgLSBzdXBlcigpIGhhc24ndCBiZWVuIGNhbGxlZCIpOwogICAgcmV0dXJuIGU7CiAgfQogIGZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhhLCBuKSB7CiAgICBpZiAoIShhIGluc3RhbmNlb2YgbikpIHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOwogIH0KICBmdW5jdGlvbiBfZGVmaW5lUHJvcGVydGllcyhlLCByKSB7CiAgICBmb3IgKHZhciB0ID0gMDsgdCA8IHIubGVuZ3RoOyB0KyspIHsKICAgICAgdmFyIG8gPSByW3RdOwogICAgICBvLmVudW1lcmFibGUgPSBvLmVudW1lcmFibGUgfHwgITEsIG8uY29uZmlndXJhYmxlID0gITAsICJ2YWx1ZSIgaW4gbyAmJiAoby53cml0YWJsZSA9ICEwKSwgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIF90b1Byb3BlcnR5S2V5KG8ua2V5KSwgbyk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIF9jcmVhdGVDbGFzcyhlLCByLCB0KSB7CiAgICByZXR1cm4gciAmJiBfZGVmaW5lUHJvcGVydGllcyhlLnByb3RvdHlwZSwgciksIHQgJiYgX2RlZmluZVByb3BlcnRpZXMoZSwgdCksIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCAicHJvdG90eXBlIiwgewogICAgICB3cml0YWJsZTogITEKICAgIH0pLCBlOwogIH0KICBmdW5jdGlvbiBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlcihyLCBlKSB7CiAgICB2YXIgdCA9ICJ1bmRlZmluZWQiICE9IHR5cGVvZiBTeW1ib2wgJiYgcltTeW1ib2wuaXRlcmF0b3JdIHx8IHJbIkBAaXRlcmF0b3IiXTsKICAgIGlmICghdCkgewogICAgICBpZiAoQXJyYXkuaXNBcnJheShyKSB8fCAodCA9IF91bnN1cHBvcnRlZEl0ZXJhYmxlVG9BcnJheShyKSkgfHwgZSAmJiByICYmICJudW1iZXIiID09IHR5cGVvZiByLmxlbmd0aCkgewogICAgICAgIHQgJiYgKHIgPSB0KTsKICAgICAgICB2YXIgbiA9IDAsCiAgICAgICAgICBGID0gZnVuY3Rpb24gKCkge307CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHM6IEYsCiAgICAgICAgICBuOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBuID49IHIubGVuZ3RoID8gewogICAgICAgICAgICAgIGRvbmU6ICEwCiAgICAgICAgICAgIH0gOiB7CiAgICAgICAgICAgICAgZG9uZTogITEsCiAgICAgICAgICAgICAgdmFsdWU6IHJbbisrXQogICAgICAgICAgICB9OwogICAgICAgICAgfSwKICAgICAgICAgIGU6IGZ1bmN0aW9uIChyKSB7CiAgICAgICAgICAgIHRocm93IHI7CiAgICAgICAgICB9LAogICAgICAgICAgZjogRgogICAgICAgIH07CiAgICAgIH0KICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiSW52YWxpZCBhdHRlbXB0IHRvIGl0ZXJhdGUgbm9uLWl0ZXJhYmxlIGluc3RhbmNlLlxuSW4gb3JkZXIgdG8gYmUgaXRlcmFibGUsIG5vbi1hcnJheSBvYmplY3RzIG11c3QgaGF2ZSBhIFtTeW1ib2wuaXRlcmF0b3JdKCkgbWV0aG9kLiIpOwogICAgfQogICAgdmFyIG8sCiAgICAgIGEgPSAhMCwKICAgICAgdSA9ICExOwogICAgcmV0dXJuIHsKICAgICAgczogZnVuY3Rpb24gKCkgewogICAgICAgIHQgPSB0LmNhbGwocik7CiAgICAgIH0sCiAgICAgIG46IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgciA9IHQubmV4dCgpOwogICAgICAgIHJldHVybiBhID0gci5kb25lLCByOwogICAgICB9LAogICAgICBlOiBmdW5jdGlvbiAocikgewogICAgICAgIHUgPSAhMCwgbyA9IHI7CiAgICAgIH0sCiAgICAgIGY6IGZ1bmN0aW9uICgpIHsKICAgICAgICB0cnkgewogICAgICAgICAgYSB8fCBudWxsID09IHQucmV0dXJuIHx8IHQucmV0dXJuKCk7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGlmICh1KSB0aHJvdyBvOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9CiAgZnVuY3Rpb24gX2NyZWF0ZVN1cGVyKHQpIHsKICAgIHZhciByID0gX2lzTmF0aXZlUmVmbGVjdENvbnN0cnVjdCgpOwogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGUsCiAgICAgICAgbyA9IF9nZXRQcm90b3R5cGVPZih0KTsKICAgICAgaWYgKHIpIHsKICAgICAgICB2YXIgcyA9IF9nZXRQcm90b3R5cGVPZih0aGlzKS5jb25zdHJ1Y3RvcjsKICAgICAgICBlID0gUmVmbGVjdC5jb25zdHJ1Y3QobywgYXJndW1lbnRzLCBzKTsKICAgICAgfSBlbHNlIGUgPSBvLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiBfcG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCBlKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eShlLCByLCB0KSB7CiAgICByZXR1cm4gKHIgPSBfdG9Qcm9wZXJ0eUtleShyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByLCB7CiAgICAgIHZhbHVlOiB0LAogICAgICBlbnVtZXJhYmxlOiAhMCwKICAgICAgY29uZmlndXJhYmxlOiAhMCwKICAgICAgd3JpdGFibGU6ICEwCiAgICB9KSA6IGVbcl0gPSB0LCBlOwogIH0KICBmdW5jdGlvbiBfZ2V0UHJvdG90eXBlT2YodCkgewogICAgcmV0dXJuIF9nZXRQcm90b3R5cGVPZiA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiA/IE9iamVjdC5nZXRQcm90b3R5cGVPZi5iaW5kKCkgOiBmdW5jdGlvbiAodCkgewogICAgICByZXR1cm4gdC5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKHQpOwogICAgfSwgX2dldFByb3RvdHlwZU9mKHQpOwogIH0KICBmdW5jdGlvbiBfaW5oZXJpdHModCwgZSkgewogICAgaWYgKCJmdW5jdGlvbiIgIT0gdHlwZW9mIGUgJiYgbnVsbCAhPT0gZSkgdGhyb3cgbmV3IFR5cGVFcnJvcigiU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24iKTsKICAgIHQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShlICYmIGUucHJvdG90eXBlLCB7CiAgICAgIGNvbnN0cnVjdG9yOiB7CiAgICAgICAgdmFsdWU6IHQsCiAgICAgICAgd3JpdGFibGU6ICEwLAogICAgICAgIGNvbmZpZ3VyYWJsZTogITAKICAgICAgfQogICAgfSksIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0LCAicHJvdG90eXBlIiwgewogICAgICB3cml0YWJsZTogITEKICAgIH0pLCBlICYmIF9zZXRQcm90b3R5cGVPZih0LCBlKTsKICB9CiAgZnVuY3Rpb24gX2lzTmF0aXZlUmVmbGVjdENvbnN0cnVjdCgpIHsKICAgIHRyeSB7CiAgICAgIHZhciB0ID0gIUJvb2xlYW4ucHJvdG90eXBlLnZhbHVlT2YuY2FsbChSZWZsZWN0LmNvbnN0cnVjdChCb29sZWFuLCBbXSwgZnVuY3Rpb24gKCkge30pKTsKICAgIH0gY2F0Y2ggKHQpIHt9CiAgICByZXR1cm4gKF9pc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiAhIXQ7CiAgICB9KSgpOwogIH0KICBmdW5jdGlvbiBfaXRlcmFibGVUb0FycmF5KHIpIHsKICAgIGlmICgidW5kZWZpbmVkIiAhPSB0eXBlb2YgU3ltYm9sICYmIG51bGwgIT0gcltTeW1ib2wuaXRlcmF0b3JdIHx8IG51bGwgIT0gclsiQEBpdGVyYXRvciJdKSByZXR1cm4gQXJyYXkuZnJvbShyKTsKICB9CiAgZnVuY3Rpb24gX2l0ZXJhYmxlVG9BcnJheUxpbWl0KHIsIGwpIHsKICAgIHZhciB0ID0gbnVsbCA9PSByID8gbnVsbCA6ICJ1bmRlZmluZWQiICE9IHR5cGVvZiBTeW1ib2wgJiYgcltTeW1ib2wuaXRlcmF0b3JdIHx8IHJbIkBAaXRlcmF0b3IiXTsKICAgIGlmIChudWxsICE9IHQpIHsKICAgICAgdmFyIGUsCiAgICAgICAgbiwKICAgICAgICBpLAogICAgICAgIHUsCiAgICAgICAgYSA9IFtdLAogICAgICAgIGYgPSAhMCwKICAgICAgICBvID0gITE7CiAgICAgIHRyeSB7CiAgICAgICAgaWYgKGkgPSAodCA9IHQuY2FsbChyKSkubmV4dCwgMCA9PT0gbCkgewogICAgICAgICAgaWYgKE9iamVjdCh0KSAhPT0gdCkgcmV0dXJuOwogICAgICAgICAgZiA9ICExOwogICAgICAgIH0gZWxzZSBmb3IgKDsgIShmID0gKGUgPSBpLmNhbGwodCkpLmRvbmUpICYmIChhLnB1c2goZS52YWx1ZSksIGEubGVuZ3RoICE9PSBsKTsgZiA9ICEwKTsKICAgICAgfSBjYXRjaCAocikgewogICAgICAgIG8gPSAhMCwgbiA9IHI7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGlmICghZiAmJiBudWxsICE9IHQucmV0dXJuICYmICh1ID0gdC5yZXR1cm4oKSwgT2JqZWN0KHUpICE9PSB1KSkgcmV0dXJuOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpZiAobykgdGhyb3cgbjsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGE7CiAgICB9CiAgfQogIGZ1bmN0aW9uIF9ub25JdGVyYWJsZVJlc3QoKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJJbnZhbGlkIGF0dGVtcHQgdG8gZGVzdHJ1Y3R1cmUgbm9uLWl0ZXJhYmxlIGluc3RhbmNlLlxuSW4gb3JkZXIgdG8gYmUgaXRlcmFibGUsIG5vbi1hcnJheSBvYmplY3RzIG11c3QgaGF2ZSBhIFtTeW1ib2wuaXRlcmF0b3JdKCkgbWV0aG9kLiIpOwogIH0KICBmdW5jdGlvbiBfbm9uSXRlcmFibGVTcHJlYWQoKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJJbnZhbGlkIGF0dGVtcHQgdG8gc3ByZWFkIG5vbi1pdGVyYWJsZSBpbnN0YW5jZS5cbkluIG9yZGVyIHRvIGJlIGl0ZXJhYmxlLCBub24tYXJyYXkgb2JqZWN0cyBtdXN0IGhhdmUgYSBbU3ltYm9sLml0ZXJhdG9yXSgpIG1ldGhvZC4iKTsKICB9CiAgZnVuY3Rpb24gX3Bvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odCwgZSkgewogICAgaWYgKGUgJiYgKCJvYmplY3QiID09IHR5cGVvZiBlIHx8ICJmdW5jdGlvbiIgPT0gdHlwZW9mIGUpKSByZXR1cm4gZTsKICAgIGlmICh2b2lkIDAgIT09IGUpIHRocm93IG5ldyBUeXBlRXJyb3IoIkRlcml2ZWQgY29uc3RydWN0b3JzIG1heSBvbmx5IHJldHVybiBvYmplY3Qgb3IgdW5kZWZpbmVkIik7CiAgICByZXR1cm4gX2Fzc2VydFRoaXNJbml0aWFsaXplZCh0KTsKICB9CiAgZnVuY3Rpb24gX3NldFByb3RvdHlwZU9mKHQsIGUpIHsKICAgIHJldHVybiBfc2V0UHJvdG90eXBlT2YgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgPyBPYmplY3Quc2V0UHJvdG90eXBlT2YuYmluZCgpIDogZnVuY3Rpb24gKHQsIGUpIHsKICAgICAgcmV0dXJuIHQuX19wcm90b19fID0gZSwgdDsKICAgIH0sIF9zZXRQcm90b3R5cGVPZih0LCBlKTsKICB9CiAgZnVuY3Rpb24gX3NsaWNlZFRvQXJyYXkociwgZSkgewogICAgcmV0dXJuIF9hcnJheVdpdGhIb2xlcyhyKSB8fCBfaXRlcmFibGVUb0FycmF5TGltaXQociwgZSkgfHwgX3Vuc3VwcG9ydGVkSXRlcmFibGVUb0FycmF5KHIsIGUpIHx8IF9ub25JdGVyYWJsZVJlc3QoKTsKICB9CiAgZnVuY3Rpb24gX3RvQ29uc3VtYWJsZUFycmF5KHIpIHsKICAgIHJldHVybiBfYXJyYXlXaXRob3V0SG9sZXMocikgfHwgX2l0ZXJhYmxlVG9BcnJheShyKSB8fCBfdW5zdXBwb3J0ZWRJdGVyYWJsZVRvQXJyYXkocikgfHwgX25vbkl0ZXJhYmxlU3ByZWFkKCk7CiAgfQogIGZ1bmN0aW9uIF90b1ByaW1pdGl2ZSh0LCByKSB7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogICAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICAgIHZhciBpID0gZS5jYWxsKHQsIHIgfHwgImRlZmF1bHQiKTsKICAgICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICAgIH0KICAgIHJldHVybiAoInN0cmluZyIgPT09IHIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwogIH0KICBmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleSh0KSB7CiAgICB2YXIgaSA9IF90b1ByaW1pdGl2ZSh0LCAic3RyaW5nIik7CiAgICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwogIH0KICBmdW5jdGlvbiBfdHlwZW9mKG8pIHsKICAgICJAYmFiZWwvaGVscGVycyAtIHR5cGVvZiI7CgogICAgcmV0dXJuIF90eXBlb2YgPSAiZnVuY3Rpb24iID09IHR5cGVvZiBTeW1ib2wgJiYgInN5bWJvbCIgPT0gdHlwZW9mIFN5bWJvbC5pdGVyYXRvciA/IGZ1bmN0aW9uIChvKSB7CiAgICAgIHJldHVybiB0eXBlb2YgbzsKICAgIH0gOiBmdW5jdGlvbiAobykgewogICAgICByZXR1cm4gbyAmJiAiZnVuY3Rpb24iID09IHR5cGVvZiBTeW1ib2wgJiYgby5jb25zdHJ1Y3RvciA9PT0gU3ltYm9sICYmIG8gIT09IFN5bWJvbC5wcm90b3R5cGUgPyAic3ltYm9sIiA6IHR5cGVvZiBvOwogICAgfSwgX3R5cGVvZihvKTsKICB9CiAgZnVuY3Rpb24gX3Vuc3VwcG9ydGVkSXRlcmFibGVUb0FycmF5KHIsIGEpIHsKICAgIGlmIChyKSB7CiAgICAgIGlmICgic3RyaW5nIiA9PSB0eXBlb2YgcikgcmV0dXJuIF9hcnJheUxpa2VUb0FycmF5KHIsIGEpOwogICAgICB2YXIgdCA9IHt9LnRvU3RyaW5nLmNhbGwocikuc2xpY2UoOCwgLTEpOwogICAgICByZXR1cm4gIk9iamVjdCIgPT09IHQgJiYgci5jb25zdHJ1Y3RvciAmJiAodCA9IHIuY29uc3RydWN0b3IubmFtZSksICJNYXAiID09PSB0IHx8ICJTZXQiID09PSB0ID8gQXJyYXkuZnJvbShyKSA6ICJBcmd1bWVudHMiID09PSB0IHx8IC9eKD86VWl8SSludCg/Ojh8MTZ8MzIpKD86Q2xhbXBlZCk/QXJyYXkkLy50ZXN0KHQpID8gX2FycmF5TGlrZVRvQXJyYXkociwgYSkgOiB2b2lkIDA7CiAgICB9CiAgfQoKICB2YXIgbG9nZ2VyOwogIHZhciBlcnJvckxvZ2dlcjsKICBmdW5jdGlvbiBzZXRMb2dnZXIobG9nLCBlcnIpIHsKICAgIC8qZXNsaW50LWRpc2FibGUgKi8KICAgIGxvZ2dlciA9IGxvZzsKICAgIGVycm9yTG9nZ2VyID0gZXJyOwogICAgLyplc2xpbnQtZW5hYmxlICovCiAgfQogIGZ1bmN0aW9uIGxvZyhtZXNzYWdlKSB7CiAgICBpZiAobG9nZ2VyKSB7CiAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBvcHRpb25hbFBhcmFtcyA9IG5ldyBBcnJheShfbGVuID4gMSA/IF9sZW4gLSAxIDogMCksIF9rZXkgPSAxOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgICAgb3B0aW9uYWxQYXJhbXNbX2tleSAtIDFdID0gYXJndW1lbnRzW19rZXldOwogICAgICB9CiAgICAgIGxvZ2dlci5hcHBseSh2b2lkIDAsIFttZXNzYWdlXS5jb25jYXQob3B0aW9uYWxQYXJhbXMpKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gZXJyb3IobWVzc2FnZSkgewogICAgaWYgKGVycm9yTG9nZ2VyKSB7CiAgICAgIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgb3B0aW9uYWxQYXJhbXMgPSBuZXcgQXJyYXkoX2xlbjIgPiAxID8gX2xlbjIgLSAxIDogMCksIF9rZXkyID0gMTsgX2tleTIgPCBfbGVuMjsgX2tleTIrKykgewogICAgICAgIG9wdGlvbmFsUGFyYW1zW19rZXkyIC0gMV0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICB9CiAgICAgIGVycm9yTG9nZ2VyLmFwcGx5KHZvaWQgMCwgW21lc3NhZ2VdLmNvbmNhdChvcHRpb25hbFBhcmFtcykpOwogICAgfQogIH0KCiAgdmFyIEV2ZW50ID0gLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIEV2ZW50KHR5cGUpIHsKICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIEV2ZW50KTsKICAgICAgdGhpcy5saXN0ZW5lciA9IHt9OwogICAgICB0aGlzLnR5cGUgPSB0eXBlIHwgJyc7CiAgICB9CiAgICBfY3JlYXRlQ2xhc3MoRXZlbnQsIFt7CiAgICAgIGtleTogIm9uIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIG9uKGV2ZW50LCBmbikgewogICAgICAgIGlmICghdGhpcy5saXN0ZW5lcltldmVudF0pIHsKICAgICAgICAgIHRoaXMubGlzdGVuZXJbZXZlbnRdID0gW107CiAgICAgICAgfQogICAgICAgIHRoaXMubGlzdGVuZXJbZXZlbnRdLnB1c2goZm4pOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIm9mZiIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBvZmYoZXZlbnQsIGZuKSB7CiAgICAgICAgaWYgKHRoaXMubGlzdGVuZXJbZXZlbnRdKSB7CiAgICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmxpc3RlbmVyW2V2ZW50XS5pbmRleE9mKGZuKTsKICAgICAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgICAgIHRoaXMubGlzdGVuZXJbZXZlbnRdLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIm9mZkFsbCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBvZmZBbGwoKSB7CiAgICAgICAgdGhpcy5saXN0ZW5lciA9IHt9OwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImRpc3BhdGNoIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGRpc3BhdGNoKGV2ZW50KSB7CiAgICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGRhdGEgPSBuZXcgQXJyYXkoX2xlbiA+IDEgPyBfbGVuIC0gMSA6IDApLCBfa2V5ID0gMTsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgICAgZGF0YVtfa2V5IC0gMV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLmxpc3RlbmVyW2V2ZW50XSkgewogICAgICAgICAgdGhpcy5saXN0ZW5lcltldmVudF0ubWFwKGZ1bmN0aW9uIChlYWNoKSB7CiAgICAgICAgICAgIGVhY2guYXBwbHkobnVsbCwgZGF0YSk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBFdmVudDsKICB9KCk7CgogIC8qKgogICAqIEdlbmVyYXRlIE1QNCBCb3gKICAgKiB0YWtlbiBmcm9tOiBodHRwczovL2dpdGh1Yi5jb20vZGFpbHltb3Rpb24vaGxzLmpzCiAgICovCgogIHZhciBNUDQgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gTVA0KCkgewogICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgTVA0KTsKICAgIH0KICAgIF9jcmVhdGVDbGFzcyhNUDQsIG51bGwsIFt7CiAgICAgIGtleTogImluaXQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gaW5pdCgpIHsKICAgICAgICBNUDQudHlwZXMgPSB7CiAgICAgICAgICBhdmMxOiBbXSwKICAgICAgICAgIC8vIGNvZGluZ25hbWUKICAgICAgICAgIGF2Y0M6IFtdLAogICAgICAgICAgYnRydDogW10sCiAgICAgICAgICBkaW5mOiBbXSwKICAgICAgICAgIGRyZWY6IFtdLAogICAgICAgICAgZXNkczogW10sCiAgICAgICAgICBmdHlwOiBbXSwKICAgICAgICAgIGhkbHI6IFtdLAogICAgICAgICAgaGV2MTogW10sCiAgICAgICAgICBodmNDOiBbXSwKICAgICAgICAgIG1kYXQ6IFtdLAogICAgICAgICAgbWRoZDogW10sCiAgICAgICAgICBtZGlhOiBbXSwKICAgICAgICAgIG1maGQ6IFtdLAogICAgICAgICAgbWluZjogW10sCiAgICAgICAgICBtb29mOiBbXSwKICAgICAgICAgIG1vb3Y6IFtdLAogICAgICAgICAgbXA0YTogW10sCiAgICAgICAgICBtdmV4OiBbXSwKICAgICAgICAgIG12aGQ6IFtdLAogICAgICAgICAgc2R0cDogW10sCiAgICAgICAgICBzdGJsOiBbXSwKICAgICAgICAgIHN0Y286IFtdLAogICAgICAgICAgc3RzYzogW10sCiAgICAgICAgICBzdHNkOiBbXSwKICAgICAgICAgIHN0c3o6IFtdLAogICAgICAgICAgc3R0czogW10sCiAgICAgICAgICB0ZmR0OiBbXSwKICAgICAgICAgIHRmaGQ6IFtdLAogICAgICAgICAgdHJhZjogW10sCiAgICAgICAgICB0cmFrOiBbXSwKICAgICAgICAgIHRydW46IFtdLAogICAgICAgICAgdHJleDogW10sCiAgICAgICAgICB0a2hkOiBbXSwKICAgICAgICAgIHZtaGQ6IFtdLAogICAgICAgICAgc21oZDogW10KICAgICAgICB9OwogICAgICAgIHZhciBpOwogICAgICAgIGZvciAoaSBpbiBNUDQudHlwZXMpIHsKICAgICAgICAgIGlmIChNUDQudHlwZXMuaGFzT3duUHJvcGVydHkoaSkpIHsKICAgICAgICAgICAgTVA0LnR5cGVzW2ldID0gW2kuY2hhckNvZGVBdCgwKSwgaS5jaGFyQ29kZUF0KDEpLCBpLmNoYXJDb2RlQXQoMiksIGkuY2hhckNvZGVBdCgzKV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciB2aWRlb0hkbHIgPSBuZXcgVWludDhBcnJheShbMHgwMCwKICAgICAgICAvLyB2ZXJzaW9uIDAKICAgICAgICAweDAwLCAweDAwLCAweDAwLAogICAgICAgIC8vIGZsYWdzCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwKICAgICAgICAvLyBwcmVfZGVmaW5lZAogICAgICAgIDB4NzYsIDB4NjksIDB4NjQsIDB4NjUsCiAgICAgICAgLy8gaGFuZGxlcl90eXBlOiAndmlkZScKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDAwLAogICAgICAgIC8vIHJlc2VydmVkCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwKICAgICAgICAvLyByZXNlcnZlZAogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsCiAgICAgICAgLy8gcmVzZXJ2ZWQKICAgICAgICAweDU2LCAweDY5LCAweDY0LCAweDY1LCAweDZmLCAweDQ4LCAweDYxLCAweDZlLCAweDY0LCAweDZjLCAweDY1LCAweDcyLCAweDAwIC8vIG5hbWU6ICdWaWRlb0hhbmRsZXInCiAgICAgICAgXSk7CiAgICAgICAgdmFyIGF1ZGlvSGRsciA9IG5ldyBVaW50OEFycmF5KFsweDAwLAogICAgICAgIC8vIHZlcnNpb24gMAogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsCiAgICAgICAgLy8gZmxhZ3MKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDAwLAogICAgICAgIC8vIHByZV9kZWZpbmVkCiAgICAgICAgMHg3MywgMHg2ZiwgMHg3NSwgMHg2ZSwKICAgICAgICAvLyBoYW5kbGVyX3R5cGU6ICdzb3VuJwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsCiAgICAgICAgLy8gcmVzZXJ2ZWQKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDAwLAogICAgICAgIC8vIHJlc2VydmVkCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwKICAgICAgICAvLyByZXNlcnZlZAogICAgICAgIDB4NTMsIDB4NmYsIDB4NzUsIDB4NmUsIDB4NjQsIDB4NDgsIDB4NjEsIDB4NmUsIDB4NjQsIDB4NmMsIDB4NjUsIDB4NzIsIDB4MDAgLy8gbmFtZTogJ1NvdW5kSGFuZGxlcicKICAgICAgICBdKTsKICAgICAgICBNUDQuSERMUl9UWVBFUyA9IHsKICAgICAgICAgIHZpZGVvOiB2aWRlb0hkbHIsCiAgICAgICAgICBhdWRpbzogYXVkaW9IZGxyCiAgICAgICAgfTsKICAgICAgICB2YXIgZHJlZiA9IG5ldyBVaW50OEFycmF5KFsweDAwLAogICAgICAgIC8vIHZlcnNpb24gMAogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsCiAgICAgICAgLy8gZmxhZ3MKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDAxLAogICAgICAgIC8vIGVudHJ5X2NvdW50CiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwYywKICAgICAgICAvLyBlbnRyeV9zaXplCiAgICAgICAgMHg3NSwgMHg3MiwgMHg2YywgMHgyMCwKICAgICAgICAvLyAndXJsJyB0eXBlCiAgICAgICAgMHgwMCwKICAgICAgICAvLyB2ZXJzaW9uIDAKICAgICAgICAweDAwLCAweDAwLCAweDAxIC8vIGVudHJ5X2ZsYWdzCiAgICAgICAgXSk7CiAgICAgICAgdmFyIHN0Y28gPSBuZXcgVWludDhBcnJheShbMHgwMCwKICAgICAgICAvLyB2ZXJzaW9uCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwKICAgICAgICAvLyBmbGFncwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAgLy8gZW50cnlfY291bnQKICAgICAgICBdKTsKICAgICAgICBNUDQuU1RUUyA9IE1QNC5TVFNDID0gTVA0LlNUQ08gPSBzdGNvOwogICAgICAgIE1QNC5TVFNaID0gbmV3IFVpbnQ4QXJyYXkoWzB4MDAsCiAgICAgICAgLy8gdmVyc2lvbgogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsCiAgICAgICAgLy8gZmxhZ3MKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDAwLAogICAgICAgIC8vIHNhbXBsZV9zaXplCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCAvLyBzYW1wbGVfY291bnQKICAgICAgICBdKTsKICAgICAgICBNUDQuVk1IRCA9IG5ldyBVaW50OEFycmF5KFsweDAwLAogICAgICAgIC8vIHZlcnNpb24KICAgICAgICAweDAwLCAweDAwLCAweDAxLAogICAgICAgIC8vIGZsYWdzCiAgICAgICAgMHgwMCwgMHgwMCwKICAgICAgICAvLyBncmFwaGljc21vZGUKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwIC8vIG9wY29sb3IKICAgICAgICBdKTsKICAgICAgICBNUDQuU01IRCA9IG5ldyBVaW50OEFycmF5KFsweDAwLAogICAgICAgIC8vIHZlcnNpb24KICAgICAgICAweDAwLCAweDAwLCAweDAwLAogICAgICAgIC8vIGZsYWdzCiAgICAgICAgMHgwMCwgMHgwMCwKICAgICAgICAvLyBiYWxhbmNlCiAgICAgICAgMHgwMCwgMHgwMCAvLyByZXNlcnZlZAogICAgICAgIF0pOwogICAgICAgIE1QNC5TVFNEID0gbmV3IFVpbnQ4QXJyYXkoWzB4MDAsCiAgICAgICAgLy8gdmVyc2lvbiAwCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwKICAgICAgICAvLyBmbGFncwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDFdKTsgLy8gZW50cnlfY291bnQKCiAgICAgICAgdmFyIG1ham9yQnJhbmQgPSBuZXcgVWludDhBcnJheShbMTA1LCAxMTUsIDExMSwgMTA5XSk7IC8vIGlzb20KICAgICAgICB2YXIgYXZjMUJyYW5kID0gbmV3IFVpbnQ4QXJyYXkoWzk3LCAxMTgsIDk5LCA0OV0pOyAvLyBhdmMxCiAgICAgICAgdmFyIG1pbm9yVmVyc2lvbiA9IG5ldyBVaW50OEFycmF5KFswLCAwLCAwLCAxXSk7CiAgICAgICAgTVA0LkZUWVAgPSBNUDQuYm94KE1QNC50eXBlcy5mdHlwLCBtYWpvckJyYW5kLCBtaW5vclZlcnNpb24sIG1ham9yQnJhbmQsIGF2YzFCcmFuZCk7CiAgICAgICAgTVA0LkRJTkYgPSBNUDQuYm94KE1QNC50eXBlcy5kaW5mLCBNUDQuYm94KE1QNC50eXBlcy5kcmVmLCBkcmVmKSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiYm94IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGJveCh0eXBlKSB7CiAgICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIHBheWxvYWQgPSBuZXcgQXJyYXkoX2xlbiA+IDEgPyBfbGVuIC0gMSA6IDApLCBfa2V5ID0gMTsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgICAgcGF5bG9hZFtfa2V5IC0gMV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgICAgfQogICAgICAgIHZhciBzaXplID0gOCwKICAgICAgICAgIGkgPSBwYXlsb2FkLmxlbmd0aCwKICAgICAgICAgIGxlbiA9IGksCiAgICAgICAgICByZXN1bHQ7CiAgICAgICAgLy8gY2FsY3VsYXRlIHRoZSB0b3RhbCBzaXplIHdlIG5lZWQgdG8gYWxsb2NhdGUKICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICBzaXplICs9IHBheWxvYWRbaV0uYnl0ZUxlbmd0aDsKICAgICAgICB9CiAgICAgICAgcmVzdWx0ID0gbmV3IFVpbnQ4QXJyYXkoc2l6ZSk7CiAgICAgICAgcmVzdWx0WzBdID0gc2l6ZSA+PiAyNCAmIDB4ZmY7CiAgICAgICAgcmVzdWx0WzFdID0gc2l6ZSA+PiAxNiAmIDB4ZmY7CiAgICAgICAgcmVzdWx0WzJdID0gc2l6ZSA+PiA4ICYgMHhmZjsKICAgICAgICByZXN1bHRbM10gPSBzaXplICYgMHhmZjsKICAgICAgICByZXN1bHQuc2V0KHR5cGUsIDQpOwogICAgICAgIC8vIGNvcHkgdGhlIHBheWxvYWQgaW50byB0aGUgcmVzdWx0CiAgICAgICAgZm9yIChpID0gMCwgc2l6ZSA9IDg7IGkgPCBsZW47ICsraSkgewogICAgICAgICAgLy8gY29weSBwYXlsb2FkW2ldIGFycmF5IEAgb2Zmc2V0IHNpemUKICAgICAgICAgIHJlc3VsdC5zZXQocGF5bG9hZFtpXSwgc2l6ZSk7CiAgICAgICAgICBzaXplICs9IHBheWxvYWRbaV0uYnl0ZUxlbmd0aDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJoZGxyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGhkbHIodHlwZSkgewogICAgICAgIHJldHVybiBNUDQuYm94KE1QNC50eXBlcy5oZGxyLCBNUDQuSERMUl9UWVBFU1t0eXBlXSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAibWRhdCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBtZGF0KGRhdGEpIHsKICAgICAgICByZXR1cm4gTVA0LmJveChNUDQudHlwZXMubWRhdCwgZGF0YSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAibWRoZCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBtZGhkKHRpbWVzY2FsZSwgZHVyYXRpb24pIHsKICAgICAgICByZXR1cm4gTVA0LmJveChNUDQudHlwZXMubWRoZCwgbmV3IFVpbnQ4QXJyYXkoWzB4MDAsCiAgICAgICAgLy8gdmVyc2lvbiAwCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwKICAgICAgICAvLyBmbGFncwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDIsCiAgICAgICAgLy8gY3JlYXRpb25fdGltZQogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDMsCiAgICAgICAgLy8gbW9kaWZpY2F0aW9uX3RpbWUKICAgICAgICB0aW1lc2NhbGUgPj4gMjQgJiAweEZGLCB0aW1lc2NhbGUgPj4gMTYgJiAweEZGLCB0aW1lc2NhbGUgPj4gOCAmIDB4RkYsIHRpbWVzY2FsZSAmIDB4RkYsCiAgICAgICAgLy8gdGltZXNjYWxlCiAgICAgICAgZHVyYXRpb24gPj4+IDI0ICYgMHhGRiwgZHVyYXRpb24gPj4+IDE2ICYgMHhGRiwgZHVyYXRpb24gPj4+IDggJiAweEZGLCBkdXJhdGlvbiAmIDB4RkYsCiAgICAgICAgLy8gZHVyYXRpb24KICAgICAgICAweDU1LCAweGM0LAogICAgICAgIC8vICd1bmQnIGxhbmd1YWdlICh1bmRldGVybWluZWQpCiAgICAgICAgMHgwMCwgMHgwMF0pKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJtZGlhIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIG1kaWEodHJhY2spIHsKICAgICAgICByZXR1cm4gTVA0LmJveChNUDQudHlwZXMubWRpYSwgTVA0Lm1kaGQodHJhY2sudGltZXNjYWxlLCB0cmFjay5kdXJhdGlvbiksIE1QNC5oZGxyKHRyYWNrLnR5cGUpLCBNUDQubWluZih0cmFjaykpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIm1maGQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gbWZoZChzZXF1ZW5jZU51bWJlcikgewogICAgICAgIHJldHVybiBNUDQuYm94KE1QNC50eXBlcy5tZmhkLCBuZXcgVWludDhBcnJheShbMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwKICAgICAgICAvLyBmbGFncwogICAgICAgIHNlcXVlbmNlTnVtYmVyID4+IDI0LCBzZXF1ZW5jZU51bWJlciA+PiAxNiAmIDB4RkYsIHNlcXVlbmNlTnVtYmVyID4+IDggJiAweEZGLCBzZXF1ZW5jZU51bWJlciAmIDB4RkYgLy8gc2VxdWVuY2VfbnVtYmVyCiAgICAgICAgXSkpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIm1pbmYiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gbWluZih0cmFjaykgewogICAgICAgIGlmICh0cmFjay50eXBlID09PSAnYXVkaW8nKSB7CiAgICAgICAgICByZXR1cm4gTVA0LmJveChNUDQudHlwZXMubWluZiwgTVA0LmJveChNUDQudHlwZXMuc21oZCwgTVA0LlNNSEQpLCBNUDQuRElORiwgTVA0LnN0YmwodHJhY2spKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIE1QNC5ib3goTVA0LnR5cGVzLm1pbmYsIE1QNC5ib3goTVA0LnR5cGVzLnZtaGQsIE1QNC5WTUhEKSwgTVA0LkRJTkYsIE1QNC5zdGJsKHRyYWNrKSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIm1vb2YiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gbW9vZihzbiwgYmFzZU1lZGlhRGVjb2RlVGltZSwgdHJhY2spIHsKICAgICAgICByZXR1cm4gTVA0LmJveChNUDQudHlwZXMubW9vZiwgTVA0Lm1maGQoc24pLCBNUDQudHJhZih0cmFjaywgYmFzZU1lZGlhRGVjb2RlVGltZSkpOwogICAgICB9CiAgICAgIC8qKgogICAgICAgKiBAcGFyYW0gdHJhY2tzLi4uIChvcHRpb25hbCkge2FycmF5fSB0aGUgdHJhY2tzIGFzc29jaWF0ZWQgd2l0aCB0aGlzIG1vdmllCiAgICAgICAqLwogICAgfSwgewogICAgICBrZXk6ICJtb292IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIG1vb3YodHJhY2tzLCBkdXJhdGlvbiwgdGltZXNjYWxlKSB7CiAgICAgICAgdmFyIGkgPSB0cmFja3MubGVuZ3RoLAogICAgICAgICAgYm94ZXMgPSBbXTsKICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICBib3hlc1tpXSA9IE1QNC50cmFrKHRyYWNrc1tpXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBNUDQuYm94LmFwcGx5KG51bGwsIFtNUDQudHlwZXMubW9vdiwgTVA0Lm12aGQodGltZXNjYWxlLCBkdXJhdGlvbildLmNvbmNhdChib3hlcykuY29uY2F0KE1QNC5tdmV4KHRyYWNrcykpKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJtdmV4IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIG12ZXgodHJhY2tzKSB7CiAgICAgICAgdmFyIGkgPSB0cmFja3MubGVuZ3RoLAogICAgICAgICAgYm94ZXMgPSBbXTsKICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICBib3hlc1tpXSA9IE1QNC50cmV4KHRyYWNrc1tpXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBNUDQuYm94LmFwcGx5KG51bGwsIFtNUDQudHlwZXMubXZleF0uY29uY2F0KGJveGVzKSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAibXZoZCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBtdmhkKHRpbWVzY2FsZSwgZHVyYXRpb24pIHsKICAgICAgICB2YXIgYnl0ZXMgPSBuZXcgVWludDhBcnJheShbMHgwMCwKICAgICAgICAvLyB2ZXJzaW9uIDAKICAgICAgICAweDAwLCAweDAwLCAweDAwLAogICAgICAgIC8vIGZsYWdzCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMSwKICAgICAgICAvLyBjcmVhdGlvbl90aW1lCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMiwKICAgICAgICAvLyBtb2RpZmljYXRpb25fdGltZQogICAgICAgIHRpbWVzY2FsZSA+PiAyNCAmIDB4RkYsIHRpbWVzY2FsZSA+PiAxNiAmIDB4RkYsIHRpbWVzY2FsZSA+PiA4ICYgMHhGRiwgdGltZXNjYWxlICYgMHhGRiwKICAgICAgICAvLyB0aW1lc2NhbGUKICAgICAgICBkdXJhdGlvbiA+Pj4gMjQgJiAweEZGLCBkdXJhdGlvbiA+Pj4gMTYgJiAweEZGLCBkdXJhdGlvbiA+Pj4gOCAmIDB4RkYsIGR1cmF0aW9uICYgMHhGRiwKICAgICAgICAvLyBkdXJhdGlvbgogICAgICAgIDB4MDAsIDB4MDEsIDB4MDAsIDB4MDAsCiAgICAgICAgLy8gMS4wIHJhdGUKICAgICAgICAweDAxLCAweDAwLAogICAgICAgIC8vIDEuMCB2b2x1bWUKICAgICAgICAweDAwLCAweDAwLAogICAgICAgIC8vIHJlc2VydmVkCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwKICAgICAgICAvLyByZXNlcnZlZAogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsCiAgICAgICAgLy8gcmVzZXJ2ZWQKICAgICAgICAweDAwLCAweDAxLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAxLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDQwLCAweDAwLCAweDAwLCAweDAwLAogICAgICAgIC8vIHRyYW5zZm9ybWF0aW9uOiB1bml0eSBtYXRyaXgKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLAogICAgICAgIC8vIHByZV9kZWZpbmVkCiAgICAgICAgMHhmZiwgMHhmZiwgMHhmZiwgMHhmZiAvLyBuZXh0X3RyYWNrX0lECiAgICAgICAgXSk7CiAgICAgICAgcmV0dXJuIE1QNC5ib3goTVA0LnR5cGVzLm12aGQsIGJ5dGVzKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzZHRwIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNkdHAodHJhY2spIHsKICAgICAgICB2YXIgc2FtcGxlcyA9IHRyYWNrLnNhbXBsZXMgfHwgW10sCiAgICAgICAgICBieXRlcyA9IG5ldyBVaW50OEFycmF5KDQgKyBzYW1wbGVzLmxlbmd0aCksCiAgICAgICAgICBmbGFncywKICAgICAgICAgIGk7CiAgICAgICAgLy8gbGVhdmUgdGhlIGZ1bGwgYm94IGhlYWRlciAoNCBieXRlcykgYWxsIHplcm8KICAgICAgICAvLyB3cml0ZSB0aGUgc2FtcGxlIHRhYmxlCiAgICAgICAgZm9yIChpID0gMDsgaSA8IHNhbXBsZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGZsYWdzID0gc2FtcGxlc1tpXS5mbGFnczsKICAgICAgICAgIGJ5dGVzW2kgKyA0XSA9IGZsYWdzLmRlcGVuZHNPbiA8PCA0IHwgZmxhZ3MuaXNEZXBlbmRlZE9uIDw8IDIgfCBmbGFncy5oYXNSZWR1bmRhbmN5OwogICAgICAgIH0KICAgICAgICByZXR1cm4gTVA0LmJveChNUDQudHlwZXMuc2R0cCwgYnl0ZXMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInN0YmwiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc3RibCh0cmFjaykgewogICAgICAgIHJldHVybiBNUDQuYm94KE1QNC50eXBlcy5zdGJsLCBNUDQuc3RzZCh0cmFjayksIE1QNC5ib3goTVA0LnR5cGVzLnN0dHMsIE1QNC5TVFRTKSwgTVA0LmJveChNUDQudHlwZXMuc3RzYywgTVA0LlNUU0MpLCBNUDQuYm94KE1QNC50eXBlcy5zdHN6LCBNUDQuU1RTWiksIE1QNC5ib3goTVA0LnR5cGVzLnN0Y28sIE1QNC5TVENPKSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiYXZjMSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBhdmMxKHRyYWNrKSB7CiAgICAgICAgdmFyIHNwcyA9IFtdLAogICAgICAgICAgcHBzID0gW10sCiAgICAgICAgICBpLAogICAgICAgICAgZGF0YSwKICAgICAgICAgIGxlbjsKICAgICAgICAvLyBhc3NlbWJsZSB0aGUgU1BTcwoKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdHJhY2suc3BzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBkYXRhID0gdHJhY2suc3BzW2ldOwogICAgICAgICAgbGVuID0gZGF0YS5ieXRlTGVuZ3RoOwogICAgICAgICAgc3BzLnB1c2gobGVuID4+PiA4ICYgMHhGRik7CiAgICAgICAgICBzcHMucHVzaChsZW4gJiAweEZGKTsKICAgICAgICAgIHNwcyA9IHNwcy5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoZGF0YSkpOyAvLyBTUFMKICAgICAgICB9CgogICAgICAgIC8vIGFzc2VtYmxlIHRoZSBQUFNzCiAgICAgICAgZm9yIChpID0gMDsgaSA8IHRyYWNrLnBwcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgZGF0YSA9IHRyYWNrLnBwc1tpXTsKICAgICAgICAgIGxlbiA9IGRhdGEuYnl0ZUxlbmd0aDsKICAgICAgICAgIHBwcy5wdXNoKGxlbiA+Pj4gOCAmIDB4RkYpOwogICAgICAgICAgcHBzLnB1c2gobGVuICYgMHhGRik7CiAgICAgICAgICBwcHMgPSBwcHMuY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGRhdGEpKTsKICAgICAgICB9CiAgICAgICAgdmFyIGF2Y2MgPSBNUDQuYm94KE1QNC50eXBlcy5hdmNDLCBuZXcgVWludDhBcnJheShbMHgwMSwKICAgICAgICAgIC8vIHZlcnNpb24KICAgICAgICAgIHNwc1szXSwKICAgICAgICAgIC8vIHByb2ZpbGUKICAgICAgICAgIHNwc1s0XSwKICAgICAgICAgIC8vIHByb2ZpbGUgY29tcGF0CiAgICAgICAgICBzcHNbNV0sCiAgICAgICAgICAvLyBsZXZlbAogICAgICAgICAgMHhmYyB8IDMsCiAgICAgICAgICAvLyBsZW5ndGhTaXplTWludXNPbmUsIGhhcmQtY29kZWQgdG8gNCBieXRlcwogICAgICAgICAgMHhFMCB8IHRyYWNrLnNwcy5sZW5ndGggLy8gM2JpdCByZXNlcnZlZCAoMTExKSArIG51bU9mU2VxdWVuY2VQYXJhbWV0ZXJTZXRzCiAgICAgICAgICBdLmNvbmNhdChzcHMpLmNvbmNhdChbdHJhY2sucHBzLmxlbmd0aCAvLyBudW1PZlBpY3R1cmVQYXJhbWV0ZXJTZXRzCiAgICAgICAgICBdKS5jb25jYXQocHBzKSkpLAogICAgICAgICAgLy8gIlBQUyIKICAgICAgICAgIHdpZHRoID0gdHJhY2sud2lkdGgsCiAgICAgICAgICBoZWlnaHQgPSB0cmFjay5oZWlnaHQ7CiAgICAgICAgLy8gY29uc29sZS5sb2coJ2F2Y2M6JyArIEhleC5oZXhEdW1wKGF2Y2MpKTsKICAgICAgICByZXR1cm4gTVA0LmJveChNUDQudHlwZXMuYXZjMSwgbmV3IFVpbnQ4QXJyYXkoWzB4MDAsIDB4MDAsIDB4MDAsCiAgICAgICAgLy8gcmVzZXJ2ZWQKICAgICAgICAweDAwLCAweDAwLCAweDAwLAogICAgICAgIC8vIHJlc2VydmVkCiAgICAgICAgMHgwMCwgMHgwMSwKICAgICAgICAvLyBkYXRhX3JlZmVyZW5jZV9pbmRleAogICAgICAgIDB4MDAsIDB4MDAsCiAgICAgICAgLy8gcHJlX2RlZmluZWQKICAgICAgICAweDAwLCAweDAwLAogICAgICAgIC8vIHJlc2VydmVkCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwKICAgICAgICAvLyBwcmVfZGVmaW5lZAogICAgICAgIHdpZHRoID4+IDggJiAweEZGLCB3aWR0aCAmIDB4ZmYsCiAgICAgICAgLy8gd2lkdGgKICAgICAgICBoZWlnaHQgPj4gOCAmIDB4RkYsIGhlaWdodCAmIDB4ZmYsCiAgICAgICAgLy8gaGVpZ2h0CiAgICAgICAgMHgwMCwgMHg0OCwgMHgwMCwgMHgwMCwKICAgICAgICAvLyBob3JpenJlc29sdXRpb24KICAgICAgICAweDAwLCAweDQ4LCAweDAwLCAweDAwLAogICAgICAgIC8vIHZlcnRyZXNvbHV0aW9uCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwKICAgICAgICAvLyByZXNlcnZlZAogICAgICAgIDB4MDAsIDB4MDEsCiAgICAgICAgLy8gZnJhbWVfY291bnQKICAgICAgICAweDEyLCAweDYyLCAweDY5LCAweDZFLCAweDY1LAogICAgICAgIC8vIGJpbmVscHJvLnJ1CiAgICAgICAgMHg2QywgMHg3MCwgMHg3MiwgMHg2RiwgMHgyRSwgMHg3MiwgMHg3NSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwKICAgICAgICAvLyBjb21wcmVzc29ybmFtZQogICAgICAgIDB4MDAsIDB4MTgsCiAgICAgICAgLy8gZGVwdGggPSAyNAogICAgICAgIDB4MTEsIDB4MTFdKSwKICAgICAgICAvLyBwcmVfZGVmaW5lZCA9IC0xCiAgICAgICAgYXZjYywgTVA0LmJveChNUDQudHlwZXMuYnRydCwgbmV3IFVpbnQ4QXJyYXkoWzB4MDAsIDB4MWMsIDB4OWMsIDB4ODAsCiAgICAgICAgLy8gYnVmZmVyU2l6ZURCCiAgICAgICAgMHgwMCwgMHgyZCwgMHhjNiwgMHhjMCwKICAgICAgICAvLyBtYXhCaXRyYXRlCiAgICAgICAgMHgwMCwgMHgyZCwgMHhjNiwgMHhjMF0pKSAvLyBhdmdCaXRyYXRlCiAgICAgICAgKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJoZXYxIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGhldjEodHJhY2spIHsKICAgICAgICB2YXIgdnBzID0gW10sCiAgICAgICAgICBzcHMgPSBbXSwKICAgICAgICAgIHBwcyA9IFtdLAogICAgICAgICAgZGF0YSwKICAgICAgICAgIGxlbjsKCiAgICAgICAgLy8gYXNzZW1ibGUgdGhlIFZQU3MKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8ICgoKF90cmFjayR2cHMgPSB0cmFjay52cHMpID09PSBudWxsIHx8IF90cmFjayR2cHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF90cmFjayR2cHMubGVuZ3RoKSB8fCAwKTsgaSsrKSB7CiAgICAgICAgICB2YXIgX3RyYWNrJHZwczsKICAgICAgICAgIGRhdGEgPSB0cmFjay52cHNbaV07CiAgICAgICAgICBsZW4gPSBkYXRhLmJ5dGVMZW5ndGg7CiAgICAgICAgICB2cHMucHVzaChsZW4gPj4+IDggJiAweEZGLCBsZW4gJiAweEZGKTsKICAgICAgICAgIHZwcyA9IHZwcy5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoZGF0YSkpOwogICAgICAgIH0KCiAgICAgICAgLy8gYXNzZW1ibGUgdGhlIFNQU3MKICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKCgoX3RyYWNrJHNwcyA9IHRyYWNrLnNwcykgPT09IG51bGwgfHwgX3RyYWNrJHNwcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3RyYWNrJHNwcy5sZW5ndGgpIHx8IDApOyBfaSsrKSB7CiAgICAgICAgICB2YXIgX3RyYWNrJHNwczsKICAgICAgICAgIGRhdGEgPSB0cmFjay5zcHNbX2ldOwogICAgICAgICAgbGVuID0gZGF0YS5ieXRlTGVuZ3RoOwogICAgICAgICAgc3BzLnB1c2gobGVuID4+PiA4ICYgMHhGRiwgbGVuICYgMHhGRik7CiAgICAgICAgICBzcHMgPSBzcHMuY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGRhdGEpKTsKICAgICAgICB9CgogICAgICAgIC8vIGFzc2VtYmxlIHRoZSBQUFNzCiAgICAgICAgZm9yICh2YXIgX2kyID0gMDsgX2kyIDwgKCgoX3RyYWNrJHBwcyA9IHRyYWNrLnBwcykgPT09IG51bGwgfHwgX3RyYWNrJHBwcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3RyYWNrJHBwcy5sZW5ndGgpIHx8IDApOyBfaTIrKykgewogICAgICAgICAgdmFyIF90cmFjayRwcHM7CiAgICAgICAgICBkYXRhID0gdHJhY2sucHBzW19pMl07CiAgICAgICAgICBsZW4gPSBkYXRhLmJ5dGVMZW5ndGg7CiAgICAgICAgICBwcHMucHVzaChsZW4gPj4+IDggJiAweEZGLCBsZW4gJiAweEZGKTsKICAgICAgICAgIHBwcyA9IHBwcy5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoZGF0YSkpOwogICAgICAgIH0KICAgICAgICB2YXIgX3RyYWNrJGh2Y0MgPSB0cmFjay5odmNDLAogICAgICAgICAgcHJvZmlsZV9zcGFjZSA9IF90cmFjayRodmNDLnByb2ZpbGVfc3BhY2UsCiAgICAgICAgICB0aWVyX2ZsYWcgPSBfdHJhY2skaHZjQy50aWVyX2ZsYWcsCiAgICAgICAgICBwcm9maWxlX2lkYyA9IF90cmFjayRodmNDLnByb2ZpbGVfaWRjLAogICAgICAgICAgcHJvZmlsZV9jb21wYXRpYmlsaXR5X2ZsYWdzID0gX3RyYWNrJGh2Y0MucHJvZmlsZV9jb21wYXRpYmlsaXR5X2ZsYWdzLAogICAgICAgICAgY29uc3RyYWludF9pbmRpY2F0b3JfZmxhZ3MgPSBfdHJhY2skaHZjQy5jb25zdHJhaW50X2luZGljYXRvcl9mbGFncywKICAgICAgICAgIGxldmVsX2lkYyA9IF90cmFjayRodmNDLmxldmVsX2lkYywKICAgICAgICAgIGNocm9tYV9mb3JtYXRfaWRjID0gX3RyYWNrJGh2Y0MuY2hyb21hX2Zvcm1hdF9pZGM7CiAgICAgICAgdmFyIGh2Y2MgPSBNUDQuYm94KE1QNC50eXBlcy5odmNDLCBuZXcgVWludDhBcnJheShbMHgwMSwKICAgICAgICAvLyBjb25maWd1cmF0aW9uVmVyc2lvbgogICAgICAgIHByb2ZpbGVfc3BhY2UgPDwgNiB8IHRpZXJfZmxhZyA8PCA1IHwgcHJvZmlsZV9pZGMsIHByb2ZpbGVfY29tcGF0aWJpbGl0eV9mbGFncyA+PiAyNCAmIDB4RkYsIHByb2ZpbGVfY29tcGF0aWJpbGl0eV9mbGFncyA+PiAxNiAmIDB4RkYsIHByb2ZpbGVfY29tcGF0aWJpbGl0eV9mbGFncyA+PiA4ICYgMHhGRiwgcHJvZmlsZV9jb21wYXRpYmlsaXR5X2ZsYWdzICYgMHhGRl0uY29uY2F0KF90b0NvbnN1bWFibGVBcnJheShjb25zdHJhaW50X2luZGljYXRvcl9mbGFncyksIFtsZXZlbF9pZGMsIDB4RjAsIDB4MDAsCiAgICAgICAgLy8gbWluX3NwYXRpYWxfc2VnbWVudGF0aW9uX2lkYyA9IDAKICAgICAgICAweEZDIHwgMCwKICAgICAgICAvLyBwYXJhbGxlbGlzbVR5cGUgPSAwCiAgICAgICAgMHhGQyB8IGNocm9tYV9mb3JtYXRfaWRjLAogICAgICAgIC8vIGNocm9tYUZvcm1hdCAoZnJvbSBTUFMpCiAgICAgICAgMHhGOCB8IDAsCiAgICAgICAgLy8gYml0RGVwdGhMdW1hTWludXM4ID0gMCAoOC1iaXQpCiAgICAgICAgMHhGOCB8IDAsCiAgICAgICAgLy8gYml0RGVwdGhDaHJvbWFNaW51czggPSAwCiAgICAgICAgMHgwMCwgMHgwMCwKICAgICAgICAvLyBhdmdGcmFtZVJhdGUgPSAwCiAgICAgICAgMHgwMywKICAgICAgICAvLyBjb25zdGFudEZyYW1lUmF0ZSA9IDAsIG51bVRlbXBvcmFsTGF5ZXJzID0gMCwgbGVuZ3RoU2l6ZU1pbnVzT25lID0gMyAoQUtBIDQpCiAgICAgICAgMHgwMywKICAgICAgICAvLyBudW1PZkFycmF5cwoKICAgICAgICAweDIwLAogICAgICAgIC8vIGFycmF5X2NvbXBsZXRlbmVzcyArIE5BTF91bml0X3R5cGUgKDMyID0gVlBTKQogICAgICAgIDB4MDAsIDB4MDFdLCBfdG9Db25zdW1hYmxlQXJyYXkodnBzKSwgWzB4MjEsCiAgICAgICAgLy8gTkFMX3VuaXRfdHlwZSAoMzMgPSBTUFMpCiAgICAgICAgMHgwMCwgMHgwMV0sIF90b0NvbnN1bWFibGVBcnJheShzcHMpLCBbMHgyMiwKICAgICAgICAvLyBOQUxfdW5pdF90eXBlICgzNCA9IFBQUykKICAgICAgICAweDAwLCAweDAxXSwgX3RvQ29uc3VtYWJsZUFycmF5KHBwcykpKSk7CiAgICAgICAgdmFyIHdpZHRoID0gdHJhY2sud2lkdGg7CiAgICAgICAgdmFyIGhlaWdodCA9IHRyYWNrLmhlaWdodDsKICAgICAgICByZXR1cm4gTVA0LmJveChNUDQudHlwZXMuaGV2MSwgbmV3IFVpbnQ4QXJyYXkoWzB4MDAsIDB4MDAsIDB4MDAsCiAgICAgICAgLy8gcmVzZXJ2ZWQKICAgICAgICAweDAwLCAweDAwLCAweDAwLAogICAgICAgIC8vIHJlc2VydmVkCiAgICAgICAgMHgwMCwgMHgwMSwKICAgICAgICAvLyBkYXRhX3JlZmVyZW5jZV9pbmRleAogICAgICAgIDB4MDAsIDB4MDAsCiAgICAgICAgLy8gcHJlX2RlZmluZWQKICAgICAgICAweDAwLCAweDAwLAogICAgICAgIC8vIHJlc2VydmVkCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwKICAgICAgICAvLyBwcmVfZGVmaW5lZAogICAgICAgIHdpZHRoID4+IDggJiAweEZGLCB3aWR0aCAmIDB4ZmYsIGhlaWdodCA+PiA4ICYgMHhGRiwgaGVpZ2h0ICYgMHhmZiwgMHgwMCwgMHg0OCwgMHgwMCwgMHgwMCwKICAgICAgICAvLyBob3JpenJlc29sdXRpb24KICAgICAgICAweDAwLCAweDQ4LCAweDAwLCAweDAwLAogICAgICAgIC8vIHZlcnRyZXNvbHV0aW9uCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwKICAgICAgICAvLyByZXNlcnZlZAogICAgICAgIDB4MDAsIDB4MDEsCiAgICAgICAgLy8gZnJhbWVfY291bnQKICAgICAgICAweDEyLCAweDYyLCAweDY5LCAweDZFLCAweDY1LAogICAgICAgIC8vICdiaW5lbHByby5ydScKICAgICAgICAweDZDLCAweDcwLCAweDcyLCAweDZGLCAweDJFLCAweDcyLCAweDc1LCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLAogICAgICAgIC8vIGNvbXByZXNzb3JuYW1lIHBhZGRpbmcKICAgICAgICAweDAwLCAweDE4LAogICAgICAgIC8vIGRlcHRoID0gMjQKICAgICAgICAweDExLCAweDExIC8vIHByZV9kZWZpbmVkID0gLTEKICAgICAgICBdKSwgaHZjYywgTVA0LmJveChNUDQudHlwZXMuYnRydCwgbmV3IFVpbnQ4QXJyYXkoWzB4MDAsIDB4MWMsIDB4OWMsIDB4ODAsCiAgICAgICAgLy8gYnVmZmVyU2l6ZURCCiAgICAgICAgMHgwMCwgMHgyZCwgMHhjNiwgMHhjMCwKICAgICAgICAvLyBtYXhCaXRyYXRlCiAgICAgICAgMHgwMCwgMHgyZCwgMHhjNiwgMHhjMCAvLyBhdmdCaXRyYXRlCiAgICAgICAgXSkpKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJlc2RzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGVzZHModHJhY2spIHsKICAgICAgICB2YXIgY29uZmlnbGVuID0gdHJhY2suY29uZmlnLmJ5dGVMZW5ndGg7CiAgICAgICAgdmFyIGRhdGEgPSBuZXcgVWludDhBcnJheSgyNiArIGNvbmZpZ2xlbiArIDMpOwogICAgICAgIGRhdGEuc2V0KFsweDAwLAogICAgICAgIC8vIHZlcnNpb24gMAogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsCiAgICAgICAgLy8gZmxhZ3MKCiAgICAgICAgMHgwMywKICAgICAgICAvLyBkZXNjcmlwdG9yX3R5cGUKICAgICAgICAweDE3ICsgY29uZmlnbGVuLAogICAgICAgIC8vIGxlbmd0aAogICAgICAgIDB4MDAsIDB4MDEsCiAgICAgICAgLy8gZXNfaWQKICAgICAgICAweDAwLAogICAgICAgIC8vIHN0cmVhbV9wcmlvcml0eQoKICAgICAgICAweDA0LAogICAgICAgIC8vIGRlc2NyaXB0b3JfdHlwZQogICAgICAgIDB4MGYgKyBjb25maWdsZW4sCiAgICAgICAgLy8gbGVuZ3RoCiAgICAgICAgMHg0MCwKICAgICAgICAvLyBjb2RlYyA6IG1wZWc0X2F1ZGlvCiAgICAgICAgMHgxNSwKICAgICAgICAvLyBzdHJlYW1fdHlwZQogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsCiAgICAgICAgLy8gYnVmZmVyX3NpemUKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDAwLAogICAgICAgIC8vIG1heEJpdHJhdGUKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDAwLAogICAgICAgIC8vIGF2Z0JpdHJhdGUKCiAgICAgICAgMHgwNSwKICAgICAgICAvLyBkZXNjcmlwdG9yX3R5cGUKICAgICAgICBjb25maWdsZW5dKTsKICAgICAgICBkYXRhLnNldCh0cmFjay5jb25maWcsIDI2KTsKICAgICAgICBkYXRhLnNldChbMHgwNiwgMHgwMSwgMHgwMl0sIDI2ICsgY29uZmlnbGVuKTsKICAgICAgICAvLyByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIC8vICAgICAweDAwLCAvLyB2ZXJzaW9uIDAKICAgICAgICAvLyAgICAgMHgwMCwgMHgwMCwgMHgwMCwgLy8gZmxhZ3MKICAgICAgICAvLwogICAgICAgIC8vICAgICAweDAzLCAvLyBkZXNjcmlwdG9yX3R5cGUKICAgICAgICAvLyAgICAgMHgxNytjb25maWdsZW4sIC8vIGxlbmd0aAogICAgICAgIC8vICAgICAweDAwLCAweDAxLCAvL2VzX2lkCiAgICAgICAgLy8gICAgIDB4MDAsIC8vIHN0cmVhbV9wcmlvcml0eQogICAgICAgIC8vCiAgICAgICAgLy8gICAgIDB4MDQsIC8vIGRlc2NyaXB0b3JfdHlwZQogICAgICAgIC8vICAgICAweDBmK2NvbmZpZ2xlbiwgLy8gbGVuZ3RoCiAgICAgICAgLy8gICAgIDB4NDAsIC8vY29kZWMgOiBtcGVnNF9hdWRpbwogICAgICAgIC8vICAgICAweDE1LCAvLyBzdHJlYW1fdHlwZQogICAgICAgIC8vICAgICAweDAwLCAweDAwLCAweDAwLCAvLyBidWZmZXJfc2l6ZQogICAgICAgIC8vICAgICAweDAwLCAweDAwLCAweDAwLCAweDAwLCAvLyBtYXhCaXRyYXRlCiAgICAgICAgLy8gICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIC8vIGF2Z0JpdHJhdGUKICAgICAgICAvLwogICAgICAgIC8vICAgICAweDA1IC8vIGRlc2NyaXB0b3JfdHlwZQogICAgICAgIC8vIF0uY29uY2F0KFtjb25maWdsZW5dKS5jb25jYXQodHJhY2suY29uZmlnKS5jb25jYXQoWzB4MDYsIDB4MDEsIDB4MDJdKSk7IC8vIEdBU3BlY2lmaWNDb25maWcpKTsgLy8gbGVuZ3RoICsgYXVkaW8gY29uZmlnIGRlc2NyaXB0b3IKICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJtcDRhIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIG1wNGEodHJhY2spIHsKICAgICAgICB2YXIgYXVkaW9zYW1wbGVyYXRlID0gdHJhY2suYXVkaW9zYW1wbGVyYXRlOwogICAgICAgIHJldHVybiBNUDQuYm94KE1QNC50eXBlcy5tcDRhLCBuZXcgVWludDhBcnJheShbMHgwMCwgMHgwMCwgMHgwMCwKICAgICAgICAvLyByZXNlcnZlZAogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsCiAgICAgICAgLy8gcmVzZXJ2ZWQKICAgICAgICAweDAwLCAweDAxLAogICAgICAgIC8vIGRhdGFfcmVmZXJlbmNlX2luZGV4CiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwKICAgICAgICAvLyByZXNlcnZlZAogICAgICAgIDB4MDAsIHRyYWNrLmNoYW5uZWxDb3VudCwKICAgICAgICAvLyBjaGFubmVsY291bnQKICAgICAgICAweDAwLCAweDEwLAogICAgICAgIC8vIHNhbXBsZVNpemU6MTZiaXRzCiAgICAgICAgMHgwMCwgMHgwMCwKICAgICAgICAvLyBwcmVfZGVmaW5lZAogICAgICAgIDB4MDAsIDB4MDAsCiAgICAgICAgLy8gcmVzZXJ2ZWQyCiAgICAgICAgYXVkaW9zYW1wbGVyYXRlID4+IDggJiAweEZGLCBhdWRpb3NhbXBsZXJhdGUgJiAweGZmLAogICAgICAgIC8vCiAgICAgICAgMHgwMCwgMHgwMF0pLCBNUDQuYm94KE1QNC50eXBlcy5lc2RzLCBNUDQuZXNkcyh0cmFjaykpKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzdHNkIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHN0c2QodHJhY2spIHsKICAgICAgICBpZiAodHJhY2sudHlwZSA9PT0gJ2F1ZGlvJykgewogICAgICAgICAgcmV0dXJuIE1QNC5ib3goTVA0LnR5cGVzLnN0c2QsIE1QNC5TVFNELCBNUDQubXA0YSh0cmFjaykpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAodHJhY2suY29kZWMuc3RhcnRzV2l0aCgnaHZjMScpKSB7CiAgICAgICAgICAgIHJldHVybiBNUDQuYm94KE1QNC50eXBlcy5zdHNkLCBNUDQuU1RTRCwgTVA0LmhldjEodHJhY2spKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBNUDQuYm94KE1QNC50eXBlcy5zdHNkLCBNUDQuU1RTRCwgTVA0LmF2YzEodHJhY2spKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAidGtoZCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiB0a2hkKHRyYWNrKSB7CiAgICAgICAgdmFyIGlkID0gdHJhY2suaWQsCiAgICAgICAgICBkdXJhdGlvbiA9IHRyYWNrLmR1cmF0aW9uLAogICAgICAgICAgd2lkdGggPSB0cmFjay53aWR0aCwKICAgICAgICAgIGhlaWdodCA9IHRyYWNrLmhlaWdodCwKICAgICAgICAgIHZvbHVtZSA9IHRyYWNrLnZvbHVtZTsKICAgICAgICByZXR1cm4gTVA0LmJveChNUDQudHlwZXMudGtoZCwgbmV3IFVpbnQ4QXJyYXkoWzB4MDAsCiAgICAgICAgLy8gdmVyc2lvbiAwCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwNywKICAgICAgICAvLyBmbGFncwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsCiAgICAgICAgLy8gY3JlYXRpb25fdGltZQogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsCiAgICAgICAgLy8gbW9kaWZpY2F0aW9uX3RpbWUKICAgICAgICBpZCA+PiAyNCAmIDB4RkYsIGlkID4+IDE2ICYgMHhGRiwgaWQgPj4gOCAmIDB4RkYsIGlkICYgMHhGRiwKICAgICAgICAvLyB0cmFja19JRAogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsCiAgICAgICAgLy8gcmVzZXJ2ZWQKICAgICAgICBkdXJhdGlvbiA+Pj4gMjQgJiAweEZGLCBkdXJhdGlvbiA+Pj4gMTYgJiAweEZGLCBkdXJhdGlvbiA+Pj4gOCAmIDB4RkYsIGR1cmF0aW9uICYgMHhGRiwKICAgICAgICAvLyBkdXJhdGlvbgogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsCiAgICAgICAgLy8gcmVzZXJ2ZWQKICAgICAgICAweDAwLCAweDAwLAogICAgICAgIC8vIGxheWVyCiAgICAgICAgMHgwMCwgMHgwMCwKICAgICAgICAvLyBhbHRlcm5hdGVfZ3JvdXAKICAgICAgICB2b2x1bWUgPj4gMCAmIDB4ZmYsIHZvbHVtZSAlIDEgKiAxMCA+PiAwICYgMHhmZiwKICAgICAgICAvLyB0cmFjayB2b2x1bWUgLy8gRklYTUUKICAgICAgICAweDAwLCAweDAwLAogICAgICAgIC8vIHJlc2VydmVkCiAgICAgICAgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHg0MCwgMHgwMCwgMHgwMCwgMHgwMCwKICAgICAgICAvLyB0cmFuc2Zvcm1hdGlvbjogdW5pdHkgbWF0cml4CiAgICAgICAgd2lkdGggPj4gOCAmIDB4RkYsIHdpZHRoICYgMHhGRiwgMHgwMCwgMHgwMCwKICAgICAgICAvLyB3aWR0aAogICAgICAgIGhlaWdodCA+PiA4ICYgMHhGRiwgaGVpZ2h0ICYgMHhGRiwgMHgwMCwgMHgwMCAvLyBoZWlnaHQKICAgICAgICBdKSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAidHJhZiIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiB0cmFmKHRyYWNrLCBiYXNlTWVkaWFEZWNvZGVUaW1lKSB7CiAgICAgICAgdmFyIHNhbXBsZURlcGVuZGVuY3lUYWJsZSA9IE1QNC5zZHRwKHRyYWNrKSwKICAgICAgICAgIGlkID0gdHJhY2suaWQ7CiAgICAgICAgcmV0dXJuIE1QNC5ib3goTVA0LnR5cGVzLnRyYWYsIE1QNC5ib3goTVA0LnR5cGVzLnRmaGQsIG5ldyBVaW50OEFycmF5KFsweDAwLAogICAgICAgIC8vIHZlcnNpb24gMAogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsCiAgICAgICAgLy8gZmxhZ3MKICAgICAgICBpZCA+PiAyNCwgaWQgPj4gMTYgJiAwWEZGLCBpZCA+PiA4ICYgMFhGRiwgaWQgJiAweEZGIC8vIHRyYWNrX0lECiAgICAgICAgXSkpLCBNUDQuYm94KE1QNC50eXBlcy50ZmR0LCBuZXcgVWludDhBcnJheShbMHgwMCwKICAgICAgICAvLyB2ZXJzaW9uIDAKICAgICAgICAweDAwLCAweDAwLCAweDAwLAogICAgICAgIC8vIGZsYWdzCiAgICAgICAgYmFzZU1lZGlhRGVjb2RlVGltZSA+PiAyNCwgYmFzZU1lZGlhRGVjb2RlVGltZSA+PiAxNiAmIDBYRkYsIGJhc2VNZWRpYURlY29kZVRpbWUgPj4gOCAmIDBYRkYsIGJhc2VNZWRpYURlY29kZVRpbWUgJiAweEZGIC8vIGJhc2VNZWRpYURlY29kZVRpbWUKICAgICAgICBdKSksIE1QNC50cnVuKHRyYWNrLCBzYW1wbGVEZXBlbmRlbmN5VGFibGUubGVuZ3RoICsgMTYgKwogICAgICAgIC8vIHRmaGQKICAgICAgICAxNiArCiAgICAgICAgLy8gdGZkdAogICAgICAgIDggKwogICAgICAgIC8vIHRyYWYgaGVhZGVyCiAgICAgICAgMTYgKwogICAgICAgIC8vIG1maGQKICAgICAgICA4ICsKICAgICAgICAvLyBtb29mIGhlYWRlcgogICAgICAgIDgpLAogICAgICAgIC8vIG1kYXQgaGVhZGVyCiAgICAgICAgc2FtcGxlRGVwZW5kZW5jeVRhYmxlKTsKICAgICAgfQoKICAgICAgLyoqCiAgICAgICAqIEdlbmVyYXRlIGEgdHJhY2sgYm94LgogICAgICAgKiBAcGFyYW0gdHJhY2sge29iamVjdH0gYSB0cmFjayBkZWZpbml0aW9uCiAgICAgICAqIEByZXR1cm4ge1VpbnQ4QXJyYXl9IHRoZSB0cmFjayBib3gKICAgICAgICovCiAgICB9LCB7CiAgICAgIGtleTogInRyYWsiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gdHJhayh0cmFjaykgewogICAgICAgIHRyYWNrLmR1cmF0aW9uID0gdHJhY2suZHVyYXRpb24gfHwgMHhmZmZmZmZmZjsKICAgICAgICByZXR1cm4gTVA0LmJveChNUDQudHlwZXMudHJhaywgTVA0LnRraGQodHJhY2spLCBNUDQubWRpYSh0cmFjaykpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInRyZXgiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gdHJleCh0cmFjaykgewogICAgICAgIHZhciBpZCA9IHRyYWNrLmlkOwogICAgICAgIHJldHVybiBNUDQuYm94KE1QNC50eXBlcy50cmV4LCBuZXcgVWludDhBcnJheShbMHgwMCwKICAgICAgICAvLyB2ZXJzaW9uIDAKICAgICAgICAweDAwLCAweDAwLCAweDAwLAogICAgICAgIC8vIGZsYWdzCiAgICAgICAgaWQgPj4gMjQsIGlkID4+IDE2ICYgMFhGRiwgaWQgPj4gOCAmIDBYRkYsIGlkICYgMHhGRiwKICAgICAgICAvLyB0cmFja19JRAogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDEsCiAgICAgICAgLy8gZGVmYXVsdF9zYW1wbGVfZGVzY3JpcHRpb25faW5kZXgKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDAwLAogICAgICAgIC8vIGRlZmF1bHRfc2FtcGxlX2R1cmF0aW9uCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwKICAgICAgICAvLyBkZWZhdWx0X3NhbXBsZV9zaXplCiAgICAgICAgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMSAvLyBkZWZhdWx0X3NhbXBsZV9mbGFncwogICAgICAgIF0pKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJ0cnVuIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHRydW4odHJhY2ssIG9mZnNldCkgewogICAgICAgIHZhciBzYW1wbGVzID0gdHJhY2suc2FtcGxlcyB8fCBbXSwKICAgICAgICAgIGxlbiA9IHNhbXBsZXMubGVuZ3RoLAogICAgICAgICAgYXJyYXlsZW4gPSAxMiArIDE2ICogbGVuLAogICAgICAgICAgYXJyYXkgPSBuZXcgVWludDhBcnJheShhcnJheWxlbiksCiAgICAgICAgICBpLAogICAgICAgICAgc2FtcGxlLAogICAgICAgICAgZHVyYXRpb24sCiAgICAgICAgICBzaXplLAogICAgICAgICAgZmxhZ3MsCiAgICAgICAgICBjdHM7CiAgICAgICAgb2Zmc2V0ICs9IDggKyBhcnJheWxlbjsKICAgICAgICBhcnJheS5zZXQoWzB4MDAsCiAgICAgICAgLy8gdmVyc2lvbiAwCiAgICAgICAgMHgwMCwgMHgwZiwgMHgwMSwKICAgICAgICAvLyBmbGFncwogICAgICAgIGxlbiA+Pj4gMjQgJiAweEZGLCBsZW4gPj4+IDE2ICYgMHhGRiwgbGVuID4+PiA4ICYgMHhGRiwgbGVuICYgMHhGRiwKICAgICAgICAvLyBzYW1wbGVfY291bnQKICAgICAgICBvZmZzZXQgPj4+IDI0ICYgMHhGRiwgb2Zmc2V0ID4+PiAxNiAmIDB4RkYsIG9mZnNldCA+Pj4gOCAmIDB4RkYsIG9mZnNldCAmIDB4RkYgLy8gZGF0YV9vZmZzZXQKICAgICAgICBdLCAwKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIHNhbXBsZSA9IHNhbXBsZXNbaV07CiAgICAgICAgICBkdXJhdGlvbiA9IHNhbXBsZS5kdXJhdGlvbjsKICAgICAgICAgIHNpemUgPSBzYW1wbGUuc2l6ZTsKICAgICAgICAgIGZsYWdzID0gc2FtcGxlLmZsYWdzOwogICAgICAgICAgY3RzID0gc2FtcGxlLmN0czsKICAgICAgICAgIGFycmF5LnNldChbZHVyYXRpb24gPj4+IDI0ICYgMHhGRiwgZHVyYXRpb24gPj4+IDE2ICYgMHhGRiwgZHVyYXRpb24gPj4+IDggJiAweEZGLCBkdXJhdGlvbiAmIDB4RkYsCiAgICAgICAgICAvLyBzYW1wbGVfZHVyYXRpb24KICAgICAgICAgIHNpemUgPj4+IDI0ICYgMHhGRiwgc2l6ZSA+Pj4gMTYgJiAweEZGLCBzaXplID4+PiA4ICYgMHhGRiwgc2l6ZSAmIDB4RkYsCiAgICAgICAgICAvLyBzYW1wbGVfc2l6ZQogICAgICAgICAgZmxhZ3MuaXNMZWFkaW5nIDw8IDIgfCBmbGFncy5kZXBlbmRzT24sIGZsYWdzLmlzRGVwZW5kZWRPbiA8PCA2IHwgZmxhZ3MuaGFzUmVkdW5kYW5jeSA8PCA0IHwgZmxhZ3MucGFkZGluZ1ZhbHVlIDw8IDEgfCBmbGFncy5pc05vblN5bmMsIGZsYWdzLmRlZ3JhZFByaW8gJiAweEYwIDw8IDgsIGZsYWdzLmRlZ3JhZFByaW8gJiAweDBGLAogICAgICAgICAgLy8gc2FtcGxlX2ZsYWdzCiAgICAgICAgICBjdHMgPj4+IDI0ICYgMHhGRiwgY3RzID4+PiAxNiAmIDB4RkYsIGN0cyA+Pj4gOCAmIDB4RkYsIGN0cyAmIDB4RkYgLy8gc2FtcGxlX2NvbXBvc2l0aW9uX3RpbWVfb2Zmc2V0CiAgICAgICAgICBdLCAxMiArIDE2ICogaSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBNUDQuYm94KE1QNC50eXBlcy50cnVuLCBhcnJheSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiaW5pdFNlZ21lbnQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gaW5pdFNlZ21lbnQodHJhY2tzLCBkdXJhdGlvbiwgdGltZXNjYWxlKSB7CiAgICAgICAgaWYgKCFNUDQudHlwZXMpIHsKICAgICAgICAgIE1QNC5pbml0KCk7CiAgICAgICAgfQogICAgICAgIHZhciBtb3ZpZSA9IE1QNC5tb292KHRyYWNrcywgZHVyYXRpb24sIHRpbWVzY2FsZSksCiAgICAgICAgICByZXN1bHQ7CiAgICAgICAgcmVzdWx0ID0gbmV3IFVpbnQ4QXJyYXkoTVA0LkZUWVAuYnl0ZUxlbmd0aCArIG1vdmllLmJ5dGVMZW5ndGgpOwogICAgICAgIHJlc3VsdC5zZXQoTVA0LkZUWVApOwogICAgICAgIHJlc3VsdC5zZXQobW92aWUsIE1QNC5GVFlQLmJ5dGVMZW5ndGgpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBNUDQ7CiAgfSgpOwoKICB2YXIgQUFDUGFyc2VyID0gLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIEFBQ1BhcnNlcigpIHsKICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIEFBQ1BhcnNlcik7CiAgICB9CiAgICBfY3JlYXRlQ2xhc3MoQUFDUGFyc2VyLCBudWxsLCBbewogICAgICBrZXk6ICJzYW1wbGluZ1JhdGVNYXAiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gWzk2MDAwLCA4ODIwMCwgNjQwMDAsIDQ4MDAwLCA0NDEwMCwgMzIwMDAsIDI0MDAwLCAyMjA1MCwgMTYwMDAsIDEyMDAwLCAxMTAyNSwgODAwMCwgNzM1MF07CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0SGVhZGVyTGVuZ3RoIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldEhlYWRlckxlbmd0aChkYXRhKSB7CiAgICAgICAgcmV0dXJuIGRhdGFbMV0gJiAweDAxID8gNyA6IDk7IC8vIHdpdGhvdXQgQ1JDIDcgYW5kIHdpdGggQ1JDIDkgUmVmczogaHR0cHM6Ly93aWtpLm11bHRpbWVkaWEuY3gvaW5kZXgucGhwP3RpdGxlPUFEVFMKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJnZXRGcmFtZUxlbmd0aCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRGcmFtZUxlbmd0aChkYXRhKSB7CiAgICAgICAgcmV0dXJuIChkYXRhWzNdICYgMHgwMykgPDwgMTEgfCBkYXRhWzRdIDw8IDMgfCAoZGF0YVs1XSAmIDB4RTApID4+PiA1OyAvLyAxMyBiaXRzIGxlbmd0aCByZWY6IGh0dHBzOi8vd2lraS5tdWx0aW1lZGlhLmN4L2luZGV4LnBocD90aXRsZT1BRFRTCiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiaXNBQUNQYXR0ZXJuIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGlzQUFDUGF0dGVybihkYXRhKSB7CiAgICAgICAgcmV0dXJuIGRhdGFbMF0gPT09IDB4ZmYgJiYgKGRhdGFbMV0gJiAweGYwKSA9PT0gMHhmMCAmJiAoZGF0YVsxXSAmIDB4MDYpID09PSAweDAwOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImV4dHJhY3RBQUMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZXh0cmFjdEFBQyhidWZmZXIpIHsKICAgICAgICB2YXIgaSA9IDAsCiAgICAgICAgICBsZW5ndGggPSBidWZmZXIuYnl0ZUxlbmd0aCwKICAgICAgICAgIHNsaWNlcyA9IFtdLAogICAgICAgICAgaGVhZGVyTGVuZ3RoLAogICAgICAgICAgZnJhbWVMZW5ndGg7CiAgICAgICAgaWYgKCFBQUNQYXJzZXIuaXNBQUNQYXR0ZXJuKGJ1ZmZlcikpIHsKICAgICAgICAgIGVycm9yKCdJbnZhbGlkIEFEVFMgYXVkaW8gZm9ybWF0Jyk7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB2YWxpZDogZmFsc2UKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGhlYWRlckxlbmd0aCA9IEFBQ1BhcnNlci5nZXRIZWFkZXJMZW5ndGgoYnVmZmVyKTsKICAgICAgICB2YXIgaGVhZGVyID0gYnVmZmVyLnN1YmFycmF5KDAsIGhlYWRlckxlbmd0aCk7CiAgICAgICAgd2hpbGUgKGkgPCBsZW5ndGgpIHsKICAgICAgICAgIGZyYW1lTGVuZ3RoID0gQUFDUGFyc2VyLmdldEZyYW1lTGVuZ3RoKGJ1ZmZlcik7CiAgICAgICAgICBzbGljZXMucHVzaChidWZmZXIuc3ViYXJyYXkoaGVhZGVyTGVuZ3RoLCBmcmFtZUxlbmd0aCkpOwogICAgICAgICAgYnVmZmVyID0gYnVmZmVyLnNsaWNlKGZyYW1lTGVuZ3RoKTsKICAgICAgICAgIGkgKz0gZnJhbWVMZW5ndGg7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICB2YWxpZDogdHJ1ZSwKICAgICAgICAgIGhlYWRlcjogaGVhZGVyLAogICAgICAgICAgc2xpY2VzOiBzbGljZXMKICAgICAgICB9OwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gQUFDUGFyc2VyOwogIH0oKTsKCiAgdmFyIHRyYWNrX2lkID0gMTsKICB2YXIgQmFzZVJlbXV4ZXIgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKF9FdmVudCkgewogICAgX2luaGVyaXRzKEJhc2VSZW11eGVyLCBfRXZlbnQpOwogICAgdmFyIF9zdXBlciA9IF9jcmVhdGVTdXBlcihCYXNlUmVtdXhlcik7CiAgICBmdW5jdGlvbiBCYXNlUmVtdXhlcigpIHsKICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIEJhc2VSZW11eGVyKTsKICAgICAgcmV0dXJuIF9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogICAgX2NyZWF0ZUNsYXNzKEJhc2VSZW11eGVyLCBbewogICAgICBrZXk6ICJmbHVzaCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBmbHVzaCgpIHsKICAgICAgICB0aGlzLm1wNHRyYWNrLmxlbiA9IDA7CiAgICAgICAgdGhpcy5tcDR0cmFjay5zYW1wbGVzID0gW107CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiaXNSZWFkeSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBpc1JlYWR5KCkgewogICAgICAgIGlmICghdGhpcy5yZWFkeVRvRGVjb2RlIHx8ICF0aGlzLnNhbXBsZXMubGVuZ3RoKSByZXR1cm4gbnVsbDsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfV0sIFt7CiAgICAgIGtleTogImdldFRyYWNrSUQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0VHJhY2tJRCgpIHsKICAgICAgICByZXR1cm4gdHJhY2tfaWQrKzsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEJhc2VSZW11eGVyOwogIH0oRXZlbnQpOwoKICB2YXIgQUFDUmVtdXhlciA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoX0Jhc2VSZW11eGVyKSB7CiAgICBfaW5oZXJpdHMoQUFDUmVtdXhlciwgX0Jhc2VSZW11eGVyKTsKICAgIHZhciBfc3VwZXIgPSBfY3JlYXRlU3VwZXIoQUFDUmVtdXhlcik7CiAgICBmdW5jdGlvbiBBQUNSZW11eGVyKHRpbWVzY2FsZSwgZHVyYXRpb24sIGZyYW1lRHVyYXRpb24pIHsKICAgICAgdmFyIF90aGlzOwogICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgQUFDUmVtdXhlcik7CiAgICAgIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcywgJ0FBQ1JlbXV4ZXInKTsKICAgICAgX3RoaXMuZnJhbWVEdXJhdGlvbiA9IGZyYW1lRHVyYXRpb247CiAgICAgIF90aGlzLnJlYWR5VG9EZWNvZGUgPSBmYWxzZTsKICAgICAgX3RoaXMuaGVhZGVyID0gbnVsbDsKICAgICAgX3RoaXMubmV4dER0cyA9IDA7CiAgICAgIF90aGlzLmR0cyA9IDA7CiAgICAgIF90aGlzLm1wNHRyYWNrID0gewogICAgICAgIGlkOiBCYXNlUmVtdXhlci5nZXRUcmFja0lEKCksCiAgICAgICAgdHlwZTogJ2F1ZGlvJywKICAgICAgICBjaGFubmVsQ291bnQ6IDAsCiAgICAgICAgbGVuOiAwLAogICAgICAgIGZyYWdtZW50ZWQ6IHRydWUsCiAgICAgICAgdGltZXNjYWxlOiB0aW1lc2NhbGUsCiAgICAgICAgZHVyYXRpb246IGR1cmF0aW9uLAogICAgICAgIHNhbXBsZXM6IFtdLAogICAgICAgIGNvbmZpZzogJycsCiAgICAgICAgY29kZWM6ICcnCiAgICAgIH07CiAgICAgIF90aGlzLnNhbXBsZXMgPSBbXTsKICAgICAgcmV0dXJuIF90aGlzOwogICAgfQogICAgX2NyZWF0ZUNsYXNzKEFBQ1JlbXV4ZXIsIFt7CiAgICAgIGtleTogInJlc2V0VHJhY2siLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVzZXRUcmFjaygpIHsKICAgICAgICB0aGlzLnJlYWR5VG9EZWNvZGUgPSBmYWxzZTsKICAgICAgICB0aGlzLmhlYWRlciA9IG51bGw7CiAgICAgICAgdGhpcy5tcDR0cmFjay5jb2RlYyA9ICcnOwogICAgICAgIHRoaXMubXA0dHJhY2suY2hhbm5lbENvdW50ID0gJyc7CiAgICAgICAgdGhpcy5tcDR0cmFjay5jb25maWcgPSAnJzsKICAgICAgICB0aGlzLm1wNHRyYWNrLnRpbWVzY2FsZSA9IHRoaXMudGltZXNjYWxlOwogICAgICAgIHRoaXMubmV4dER0cyA9IDA7CiAgICAgICAgdGhpcy5kdHMgPSAwOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImZlZWQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZmVlZChkYXRhLCBkdXJhdGlvbikgewogICAgICAgIHZhciBfQUFDUGFyc2VyJGV4dHJhY3RBQUMgPSBBQUNQYXJzZXIuZXh0cmFjdEFBQyhkYXRhKSwKICAgICAgICAgIHZhbGlkID0gX0FBQ1BhcnNlciRleHRyYWN0QUFDLnZhbGlkLAogICAgICAgICAgaGVhZGVyID0gX0FBQ1BhcnNlciRleHRyYWN0QUFDLmhlYWRlciwKICAgICAgICAgIHNsaWNlcyA9IF9BQUNQYXJzZXIkZXh0cmFjdEFBQy5zbGljZXM7CiAgICAgICAgaWYgKCF0aGlzLmhlYWRlcikgdGhpcy5oZWFkZXIgPSBoZWFkZXI7CiAgICAgICAgaWYgKHZhbGlkICYmIHNsaWNlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICB0aGlzLnJlbXV4KHRoaXMuZ2V0QXVkaW9GcmFtZXMoc2xpY2VzLCBkdXJhdGlvbikpOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGVycm9yKCdGYWlsZWQgdG8gZXh0cmFjdCBhdWRpbyBkYXRhIGZyb206JywgZGF0YSk7CiAgICAgICAgICB0aGlzLmRpc3BhdGNoKCdvdXRPZkRhdGEnKTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0QXVkaW9GcmFtZXMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0QXVkaW9GcmFtZXMoYWFjRnJhbWVzLCBkdXJhdGlvbikgewogICAgICAgIHZhciBmcmFtZXMgPSBbXSwKICAgICAgICAgIGZkID0gMCwKICAgICAgICAgIHR0ID0gMDsKICAgICAgICB2YXIgX2l0ZXJhdG9yID0gX2NyZWF0ZUZvck9mSXRlcmF0b3JIZWxwZXIoYWFjRnJhbWVzKSwKICAgICAgICAgIF9zdGVwOwogICAgICAgIHRyeSB7CiAgICAgICAgICBmb3IgKF9pdGVyYXRvci5zKCk7ICEoX3N0ZXAgPSBfaXRlcmF0b3IubigpKS5kb25lOykgewogICAgICAgICAgICB2YXIgdW5pdHMgPSBfc3RlcC52YWx1ZTsKICAgICAgICAgICAgZnJhbWVzLnB1c2goewogICAgICAgICAgICAgIHVuaXRzOiB1bml0cwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIF9pdGVyYXRvci5lKGVycik7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIF9pdGVyYXRvci5mKCk7CiAgICAgICAgfQogICAgICAgIGZkID0gZHVyYXRpb24gPyBkdXJhdGlvbiAvIGZyYW1lcy5sZW5ndGggfCAwIDogdGhpcy5mcmFtZUR1cmF0aW9uOwogICAgICAgIHR0ID0gZHVyYXRpb24gPyBkdXJhdGlvbiAtIGZkICogZnJhbWVzLmxlbmd0aCA6IDA7CiAgICAgICAgZnJhbWVzLm1hcChmdW5jdGlvbiAoZnJhbWUpIHsKICAgICAgICAgIGZyYW1lLmR1cmF0aW9uID0gZmQ7CiAgICAgICAgICBpZiAodHQgPiAwKSB7CiAgICAgICAgICAgIGZyYW1lLmR1cmF0aW9uKys7CiAgICAgICAgICAgIHR0LS07CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGZyYW1lczsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZW11eCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW11eChmcmFtZXMpIHsKICAgICAgICBpZiAoZnJhbWVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZnJhbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBmcmFtZSA9IGZyYW1lc1tpXTsKICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBmcmFtZS51bml0czsKICAgICAgICAgICAgdmFyIHNpemUgPSBwYXlsb2FkLmJ5dGVMZW5ndGg7CiAgICAgICAgICAgIHRoaXMuc2FtcGxlcy5wdXNoKHsKICAgICAgICAgICAgICB1bml0czogcGF5bG9hZCwKICAgICAgICAgICAgICBzaXplOiBzaXplLAogICAgICAgICAgICAgIGR1cmF0aW9uOiBmcmFtZS5kdXJhdGlvbgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5tcDR0cmFjay5sZW4gKz0gc2l6ZTsKICAgICAgICAgICAgaWYgKCF0aGlzLnJlYWR5VG9EZWNvZGUpIHsKICAgICAgICAgICAgICB0aGlzLnNldEFBQ0NvbmZpZygpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldFBheWxvYWQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0UGF5bG9hZCgpIHsKICAgICAgICBpZiAoIXRoaXMuaXNSZWFkeSgpKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIHBheWxvYWQgPSBuZXcgVWludDhBcnJheSh0aGlzLm1wNHRyYWNrLmxlbik7CiAgICAgICAgdmFyIG9mZnNldCA9IDA7CiAgICAgICAgdmFyIHNhbXBsZXMgPSB0aGlzLm1wNHRyYWNrLnNhbXBsZXM7CiAgICAgICAgdmFyIG1wNFNhbXBsZSwgZHVyYXRpb247CiAgICAgICAgdGhpcy5kdHMgPSB0aGlzLm5leHREdHM7CiAgICAgICAgd2hpbGUgKHRoaXMuc2FtcGxlcy5sZW5ndGgpIHsKICAgICAgICAgIHZhciBzYW1wbGUgPSB0aGlzLnNhbXBsZXMuc2hpZnQoKTsKICAgICAgICAgICAgc2FtcGxlLnVuaXRzOwogICAgICAgICAgZHVyYXRpb24gPSBzYW1wbGUuZHVyYXRpb247CiAgICAgICAgICBpZiAoZHVyYXRpb24gPD0gMCkgewogICAgICAgICAgICBsb2coInJlbXV4ZXI6IGludmFsaWQgc2FtcGxlIGR1cmF0aW9uIGF0IERUUzogIi5jb25jYXQodGhpcy5uZXh0RHRzLCAiIDoiKS5jb25jYXQoZHVyYXRpb24pKTsKICAgICAgICAgICAgdGhpcy5tcDR0cmFjay5sZW4gLT0gc2FtcGxlLnNpemU7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5uZXh0RHRzICs9IGR1cmF0aW9uOwogICAgICAgICAgbXA0U2FtcGxlID0gewogICAgICAgICAgICBzaXplOiBzYW1wbGUuc2l6ZSwKICAgICAgICAgICAgZHVyYXRpb246IGR1cmF0aW9uLAogICAgICAgICAgICBjdHM6IDAsCiAgICAgICAgICAgIGZsYWdzOiB7CiAgICAgICAgICAgICAgaXNMZWFkaW5nOiAwLAogICAgICAgICAgICAgIGlzRGVwZW5kZWRPbjogMCwKICAgICAgICAgICAgICBoYXNSZWR1bmRhbmN5OiAwLAogICAgICAgICAgICAgIGRlZ3JhZFByaW86IDAsCiAgICAgICAgICAgICAgZGVwZW5kc09uOiAxCiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBwYXlsb2FkLnNldChzYW1wbGUudW5pdHMsIG9mZnNldCk7CiAgICAgICAgICBvZmZzZXQgKz0gc2FtcGxlLnNpemU7CiAgICAgICAgICBzYW1wbGVzLnB1c2gobXA0U2FtcGxlKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFzYW1wbGVzLmxlbmd0aCkgcmV0dXJuIG51bGw7CiAgICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KHBheWxvYWQuYnVmZmVyLCAwLCB0aGlzLm1wNHRyYWNrLmxlbik7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAic2V0QUFDQ29uZmlnIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNldEFBQ0NvbmZpZygpIHsKICAgICAgICB2YXIgb2JqZWN0VHlwZSwKICAgICAgICAgIHNhbXBsZUluZGV4LAogICAgICAgICAgY2hhbm5lbENvdW50LAogICAgICAgICAgY29uZmlnID0gbmV3IFVpbnQ4QXJyYXkoMik7CiAgICAgICAgaWYgKCF0aGlzLmhlYWRlcikgcmV0dXJuOwogICAgICAgIG9iamVjdFR5cGUgPSAoKHRoaXMuaGVhZGVyWzJdICYgMHhDMCkgPj4+IDYpICsgMTsKICAgICAgICBzYW1wbGVJbmRleCA9ICh0aGlzLmhlYWRlclsyXSAmIDB4M0MpID4+PiAyOwogICAgICAgIGNoYW5uZWxDb3VudCA9ICh0aGlzLmhlYWRlclsyXSAmIDB4MDEpIDw8IDI7CiAgICAgICAgY2hhbm5lbENvdW50IHw9ICh0aGlzLmhlYWRlclszXSAmIDB4QzApID4+PiA2OwoKICAgICAgICAvKiByZWZlciB0byBodHRwOi8vd2lraS5tdWx0aW1lZGlhLmN4L2luZGV4LnBocD90aXRsZT1NUEVHLTRfQXVkaW8jQXVkaW9fU3BlY2lmaWNfQ29uZmlnICovCiAgICAgICAgY29uZmlnWzBdID0gb2JqZWN0VHlwZSA8PCAzOwogICAgICAgIGNvbmZpZ1swXSB8PSAoc2FtcGxlSW5kZXggJiAweDBFKSA+PiAxOwogICAgICAgIGNvbmZpZ1sxXSB8PSAoc2FtcGxlSW5kZXggJiAweDAxKSA8PCA3OwogICAgICAgIGNvbmZpZ1sxXSB8PSBjaGFubmVsQ291bnQgPDwgMzsKICAgICAgICB0aGlzLm1wNHRyYWNrLmNvZGVjID0gJ21wNGEuNDAuJyArIG9iamVjdFR5cGU7CiAgICAgICAgdGhpcy5tcDR0cmFjay5jaGFubmVsQ291bnQgPSBjaGFubmVsQ291bnQ7CiAgICAgICAgdGhpcy5tcDR0cmFjay5jb25maWcgPSBjb25maWc7CiAgICAgICAgdGhpcy5yZWFkeVRvRGVjb2RlID0gdHJ1ZTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEFBQ1JlbXV4ZXI7CiAgfShCYXNlUmVtdXhlcik7CgogIC8qKgogICAqIFBhcnNlciBmb3IgZXhwb25lbnRpYWwgR29sb21iIGNvZGVzLCBhIHZhcmlhYmxlLWJpdHdpZHRoIG51bWJlciBlbmNvZGluZyBzY2hlbWUgdXNlZCBieSBoMjY0LgogICovCgogIHZhciBFeHBHb2xvbWIgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gRXhwR29sb21iKGRhdGEpIHsKICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIEV4cEdvbG9tYik7CiAgICAgIHRoaXMuZGF0YSA9IGRhdGE7CiAgICAgIHRoaXMuaW5kZXggPSAwOwogICAgICB0aGlzLmJpdExlbmd0aCA9IGRhdGEuYnl0ZUxlbmd0aCAqIDg7CiAgICB9CiAgICBfY3JlYXRlQ2xhc3MoRXhwR29sb21iLCBbewogICAgICBrZXk6ICJzZXREYXRhIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNldERhdGEoZGF0YSkgewogICAgICAgIHRoaXMuZGF0YSA9IGRhdGE7CiAgICAgICAgdGhpcy5pbmRleCA9IDA7CiAgICAgICAgdGhpcy5iaXRMZW5ndGggPSBkYXRhLmJ5dGVMZW5ndGggKiA4OwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImJpdHNBdmFpbGFibGUiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5iaXRMZW5ndGggLSB0aGlzLmluZGV4OwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInNraXBCaXRzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNraXBCaXRzKHNpemUpIHsKICAgICAgICAvLyBjb25zb2xlLmxvZyhgICBza2lwIGJpdHM6IHNpemU9JHtzaXplfSwgJHt0aGlzLmluZGV4fS5gKTsKICAgICAgICBpZiAodGhpcy5iaXRzQXZhaWxhYmxlIDwgc2l6ZSkgewogICAgICAgICAgLy90aHJvdyBuZXcgRXJyb3IoJ25vIGJ5dGVzIGF2YWlsYWJsZScpOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICB0aGlzLmluZGV4ICs9IHNpemU7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVhZEJpdHMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVhZEJpdHMoc2l6ZSkgewogICAgICAgIHZhciBtb3ZlSW5kZXggPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IHRydWU7CiAgICAgICAgLy8gY29uc29sZS5sb2coYCAgcmVhZCBiaXRzOiBzaXplPSR7c2l6ZX0sICR7dGhpcy5pbmRleH0uYCk7CiAgICAgICAgdmFyIHJlc3VsdCA9IHRoaXMuZ2V0Qml0cyhzaXplLCB0aGlzLmluZGV4LCBtb3ZlSW5kZXgpOwogICAgICAgIC8vIGNvbnNvbGUubG9nKGAgICAgcmVhZCBiaXRzOiByZXN1bHQ9JHtyZXN1bHR9YCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJnZXRCaXRzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldEJpdHMoc2l6ZSwgb2Zmc2V0Qml0cykgewogICAgICAgIHZhciBtb3ZlSW5kZXggPSBhcmd1bWVudHMubGVuZ3RoID4gMiAmJiBhcmd1bWVudHNbMl0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1syXSA6IHRydWU7CiAgICAgICAgaWYgKHRoaXMuYml0c0F2YWlsYWJsZSA8IHNpemUpIHsKICAgICAgICAgIC8vdGhyb3cgbmV3IEVycm9yKCdubyBieXRlcyBhdmFpbGFibGUnKTsKICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KICAgICAgICB2YXIgb2Zmc2V0ID0gb2Zmc2V0Qml0cyAlIDg7CiAgICAgICAgdmFyIF9ieXRlID0gdGhpcy5kYXRhW29mZnNldEJpdHMgLyA4IHwgMF0gJiAweGZmID4+PiBvZmZzZXQ7CiAgICAgICAgdmFyIGJpdHMgPSA4IC0gb2Zmc2V0OwogICAgICAgIGlmIChiaXRzID49IHNpemUpIHsKICAgICAgICAgIGlmIChtb3ZlSW5kZXgpIHsKICAgICAgICAgICAgdGhpcy5pbmRleCArPSBzaXplOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIF9ieXRlID4+IGJpdHMgLSBzaXplOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAobW92ZUluZGV4KSB7CiAgICAgICAgICAgIHRoaXMuaW5kZXggKz0gYml0czsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0U2l6ZSA9IHNpemUgLSBiaXRzOwogICAgICAgICAgcmV0dXJuIF9ieXRlIDw8IG5leHRTaXplIHwgdGhpcy5nZXRCaXRzKG5leHRTaXplLCBvZmZzZXRCaXRzICsgYml0cywgbW92ZUluZGV4KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAic2tpcExaIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNraXBMWigpIHsKICAgICAgICB2YXIgbGVhZGluZ1plcm9Db3VudDsKICAgICAgICBmb3IgKGxlYWRpbmdaZXJvQ291bnQgPSAwOyBsZWFkaW5nWmVyb0NvdW50IDwgdGhpcy5iaXRMZW5ndGggLSB0aGlzLmluZGV4OyArK2xlYWRpbmdaZXJvQ291bnQpIHsKICAgICAgICAgIGlmICh0aGlzLmdldEJpdHMoMSwgdGhpcy5pbmRleCArIGxlYWRpbmdaZXJvQ291bnQsIGZhbHNlKSAhPT0gMCkgewogICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhgICBza2lwIExaICA6IHNpemU9JHtsZWFkaW5nWmVyb0NvdW50fSwgJHt0aGlzLmluZGV4fS5gKTsKICAgICAgICAgICAgdGhpcy5pbmRleCArPSBsZWFkaW5nWmVyb0NvdW50OwogICAgICAgICAgICByZXR1cm4gbGVhZGluZ1plcm9Db3VudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGxlYWRpbmdaZXJvQ291bnQ7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAic2tpcFVFRyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBza2lwVUVHKCkgewogICAgICAgIHRoaXMuc2tpcEJpdHMoMSArIHRoaXMuc2tpcExaKCkpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInNraXBFRyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBza2lwRUcoKSB7CiAgICAgICAgdGhpcy5za2lwQml0cygxICsgdGhpcy5za2lwTFooKSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVhZFVFRyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZWFkVUVHKCkgewogICAgICAgIHZhciBwcmVmaXggPSB0aGlzLnNraXBMWigpOwogICAgICAgIHJldHVybiB0aGlzLnJlYWRCaXRzKHByZWZpeCArIDEpIC0gMTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZWFkRUciLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVhZEVHKCkgewogICAgICAgIHZhciB2YWx1ZSA9IHRoaXMucmVhZFVFRygpOwogICAgICAgIGlmICgweDAxICYgdmFsdWUpIHsKICAgICAgICAgIC8vIHRoZSBudW1iZXIgaXMgb2RkIGlmIHRoZSBsb3cgb3JkZXIgYml0IGlzIHNldAogICAgICAgICAgcmV0dXJuIDEgKyB2YWx1ZSA+Pj4gMTsgLy8gYWRkIDEgdG8gbWFrZSBpdCBldmVuLCBhbmQgZGl2aWRlIGJ5IDIKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIC0xICogKHZhbHVlID4+PiAxKTsgLy8gZGl2aWRlIGJ5IHR3byB0aGVuIG1ha2UgaXQgbmVnYXRpdmUKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVhZEJvb2xlYW4iLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVhZEJvb2xlYW4oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucmVhZEJpdHMoMSkgPT09IDE7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVhZFVCeXRlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlYWRVQnl0ZSgpIHsKICAgICAgICB2YXIgbnVtYmVyT2ZCeXRlcyA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzBdIDogMTsKICAgICAgICByZXR1cm4gdGhpcy5yZWFkQml0cyhudW1iZXJPZkJ5dGVzICogOCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVhZFVTaG9ydCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZWFkVVNob3J0KCkgewogICAgICAgIHJldHVybiB0aGlzLnJlYWRCaXRzKDE2KTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZWFkVUludCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZWFkVUludCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5yZWFkQml0cygzMik7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBFeHBHb2xvbWI7CiAgfSgpOwoKICAvLyBzcGVjIGh0dHBzOi8vd3d3Lml0dS5pbnQvcmVjL1QtUkVDLUguMjY0LwoKICB2YXIgSDI2NFBhcnNlciA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBIMjY0UGFyc2VyKCkgewogICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgSDI2NFBhcnNlcik7CiAgICB9CiAgICBfY3JlYXRlQ2xhc3MoSDI2NFBhcnNlciwgbnVsbCwgW3sKICAgICAga2V5OiAiZXh0cmFjdE5BTHUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZXh0cmFjdE5BTHUoYnVmZmVyKSB7CiAgICAgICAgdmFyIGkgPSAwLAogICAgICAgICAgbGVuZ3RoID0gYnVmZmVyLmJ5dGVMZW5ndGgsCiAgICAgICAgICByZXN1bHQgPSBbXSwKICAgICAgICAgIGxhc3RJbmRleCA9IDAsCiAgICAgICAgICB6ZXJvQ291bnQgPSAwOwogICAgICAgIHdoaWxlIChpIDwgbGVuZ3RoKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSBidWZmZXJbaSsrXTsKICAgICAgICAgIGlmICh2YWx1ZSA9PT0gMCkgewogICAgICAgICAgICB6ZXJvQ291bnQrKzsKICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWUgPT09IDEgJiYgemVyb0NvdW50ID49IDIpIHsKICAgICAgICAgICAgdmFyIHN0YXJ0Q29kZUxlbmd0aCA9IHplcm9Db3VudCArIDE7CiAgICAgICAgICAgIGlmIChsYXN0SW5kZXggIT09IGkgLSBzdGFydENvZGVMZW5ndGgpIHsKICAgICAgICAgICAgICByZXN1bHQucHVzaChidWZmZXIuc3ViYXJyYXkobGFzdEluZGV4LCBpIC0gc3RhcnRDb2RlTGVuZ3RoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFzdEluZGV4ID0gaTsKICAgICAgICAgICAgemVyb0NvdW50ID0gMDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHplcm9Db3VudCA9IDA7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBSZW1haW5pbmcgZGF0YSBhZnRlciBsYXN0IHN0YXJ0IGNvZGUKICAgICAgICB2YXIgbGVmdCA9IG51bGw7CiAgICAgICAgaWYgKGxhc3RJbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgbGVmdCA9IGJ1ZmZlci5zdWJhcnJheShsYXN0SW5kZXgsIGxlbmd0aCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBbcmVzdWx0LCBsZWZ0XTsKICAgICAgfQoKICAgICAgLyoqCiAgICAgICAqIEFkdmFuY2UgdGhlIEV4cEdvbG9tYiBkZWNvZGVyIHBhc3QgYSBzY2FsaW5nIGxpc3QuIFRoZSBzY2FsaW5nCiAgICAgICAqIGxpc3QgaXMgb3B0aW9uYWxseSB0cmFuc21pdHRlZCBhcyBwYXJ0IG9mIGEgc2VxdWVuY2UgcGFyYW1ldGVyCiAgICAgICAqIHNldCBhbmQgaXMgbm90IHJlbGV2YW50IHRvIHRyYW5zbXV4aW5nLgogICAgICAgKiBAcGFyYW0gZGVjb2RlciB7RXhwR29sb21ifSBleHAgZ29sb21iIGRlY29kZXIKICAgICAgICogQHBhcmFtIGNvdW50IHtudW1iZXJ9IHRoZSBudW1iZXIgb2YgZW50cmllcyBpbiB0aGlzIHNjYWxpbmcgbGlzdAogICAgICAgKiBAc2VlIFJlY29tbWVuZGF0aW9uIElUVS1UIEguMjY0LCBTZWN0aW9uIDcuMy4yLjEuMS4xCiAgICAgICAqLwogICAgfSwgewogICAgICBrZXk6ICJza2lwU2NhbGluZ0xpc3QiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc2tpcFNjYWxpbmdMaXN0KGRlY29kZXIsIGNvdW50KSB7CiAgICAgICAgdmFyIGxhc3RTY2FsZSA9IDgsCiAgICAgICAgICBuZXh0U2NhbGUgPSA4LAogICAgICAgICAgZGVsdGFTY2FsZTsKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGNvdW50OyBqKyspIHsKICAgICAgICAgIGlmIChuZXh0U2NhbGUgIT09IDApIHsKICAgICAgICAgICAgZGVsdGFTY2FsZSA9IGRlY29kZXIucmVhZEVHKCk7CiAgICAgICAgICAgIG5leHRTY2FsZSA9IChsYXN0U2NhbGUgKyBkZWx0YVNjYWxlICsgMjU2KSAlIDI1NjsKICAgICAgICAgIH0KICAgICAgICAgIGxhc3RTY2FsZSA9IG5leHRTY2FsZSA9PT0gMCA/IGxhc3RTY2FsZSA6IG5leHRTY2FsZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8qKgogICAgICAgKiBSZWFkIGEgc2VxdWVuY2UgcGFyYW1ldGVyIHNldCBhbmQgcmV0dXJuIHNvbWUgaW50ZXJlc3RpbmcgdmlkZW8KICAgICAgICogcHJvcGVydGllcy4gQSBzZXF1ZW5jZSBwYXJhbWV0ZXIgc2V0IGlzIHRoZSBIMjY0IG1ldGFkYXRhIHRoYXQKICAgICAgICogZGVzY3JpYmVzIHRoZSBwcm9wZXJ0aWVzIG9mIHVwY29taW5nIHZpZGVvIGZyYW1lcy4KICAgICAgICogQHBhcmFtIGRhdGEge1VpbnQ4QXJyYXl9IHRoZSBieXRlcyBvZiBhIHNlcXVlbmNlIHBhcmFtZXRlciBzZXQKICAgICAgICogQHJldHVybiB7b2JqZWN0fSBhbiBvYmplY3Qgd2l0aCBjb25maWd1cmF0aW9uIHBhcnNlZCBmcm9tIHRoZQogICAgICAgKiBzZXF1ZW5jZSBwYXJhbWV0ZXIgc2V0LCBpbmNsdWRpbmcgdGhlIGRpbWVuc2lvbnMgb2YgdGhlCiAgICAgICAqIGFzc29jaWF0ZWQgdmlkZW8gZnJhbWVzLgogICAgICAgKi8KICAgIH0sIHsKICAgICAga2V5OiAicmVhZFNQUyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZWFkU1BTKGRhdGEpIHsKICAgICAgICB2YXIgZGVjb2RlciA9IG5ldyBFeHBHb2xvbWIoZGF0YSk7CiAgICAgICAgdmFyIGZyYW1lQ3JvcExlZnRPZmZzZXQgPSAwLAogICAgICAgICAgZnJhbWVDcm9wUmlnaHRPZmZzZXQgPSAwLAogICAgICAgICAgZnJhbWVDcm9wVG9wT2Zmc2V0ID0gMCwKICAgICAgICAgIGZyYW1lQ3JvcEJvdHRvbU9mZnNldCA9IDAsCiAgICAgICAgICBzYXJTY2FsZSA9IDEsCiAgICAgICAgICBwcm9maWxlSWRjLAogICAgICAgICAgbnVtUmVmRnJhbWVzSW5QaWNPcmRlckNudEN5Y2xlLAogICAgICAgICAgcGljV2lkdGhJbk1ic01pbnVzMSwKICAgICAgICAgIHBpY0hlaWdodEluTWFwVW5pdHNNaW51czEsCiAgICAgICAgICBmcmFtZU1ic09ubHlGbGFnLAogICAgICAgICAgc2NhbGluZ0xpc3RDb3VudCwKICAgICAgICAgIGZwcyA9IDA7CiAgICAgICAgZGVjb2Rlci5yZWFkVUJ5dGUoKTsgLy8gc2tpcCBOQUwgaGVhZGVyCgogICAgICAgIC8vIHJld3JpdGUgTkFMCiAgICAgICAgdmFyIHJic3AgPSBbXSwKICAgICAgICAgIGhkcl9ieXRlcyA9IDEsCiAgICAgICAgICBuYWxfYnl0ZXMgPSBkYXRhLmJ5dGVMZW5ndGg7CiAgICAgICAgZm9yICh2YXIgaSA9IGhkcl9ieXRlczsgaSA8IG5hbF9ieXRlczsgaSsrKSB7CiAgICAgICAgICBpZiAoaSArIDIgPCBuYWxfYnl0ZXMgJiYgZGVjb2Rlci5yZWFkQml0cygyNCwgZmFsc2UpID09PSAweDAwMDAwMykgewogICAgICAgICAgICByYnNwLnB1c2goZGVjb2Rlci5yZWFkQml0cyg4KSk7CiAgICAgICAgICAgIHJic3AucHVzaChkZWNvZGVyLnJlYWRCaXRzKDgpKTsKICAgICAgICAgICAgaSArPSAyOwoKICAgICAgICAgICAgLy8gZW11bGF0aW9uX3ByZXZlbnRpb25fdGhyZWVfYnl0ZQogICAgICAgICAgICBkZWNvZGVyLnJlYWRCaXRzKDgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmJzcC5wdXNoKGRlY29kZXIucmVhZEJpdHMoOCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBkZWNvZGVyLnNldERhdGEobmV3IFVpbnQ4QXJyYXkocmJzcCkpOwogICAgICAgIC8vIGVuZCBvZiByZXdyaXRlIGRhdGEKCiAgICAgICAgcHJvZmlsZUlkYyA9IGRlY29kZXIucmVhZFVCeXRlKCk7IC8vIHByb2ZpbGVfaWRjCiAgICAgICAgZGVjb2Rlci5yZWFkQml0cyg1KTsgLy8gY29uc3RyYWludF9zZXRbMC00XV9mbGFnLCB1KDUpCiAgICAgICAgZGVjb2Rlci5za2lwQml0cygzKTsgLy8gcmVzZXJ2ZWRfemVyb18zYml0cyB1KDMpLAogICAgICAgIGRlY29kZXIucmVhZFVCeXRlKCk7IC8vIGxldmVsX2lkYyB1KDgpCiAgICAgICAgZGVjb2Rlci5za2lwVUVHKCk7IC8vIHNlcV9wYXJhbWV0ZXJfc2V0X2lkCiAgICAgICAgLy8gc29tZSBwcm9maWxlcyBoYXZlIG1vcmUgb3B0aW9uYWwgZGF0YSB3ZSBkb24ndCBuZWVkCiAgICAgICAgaWYgKHByb2ZpbGVJZGMgPT09IDEwMCB8fCBwcm9maWxlSWRjID09PSAxMTAgfHwgcHJvZmlsZUlkYyA9PT0gMTIyIHx8IHByb2ZpbGVJZGMgPT09IDI0NCB8fCBwcm9maWxlSWRjID09PSA0NCB8fCBwcm9maWxlSWRjID09PSA4MyB8fCBwcm9maWxlSWRjID09PSA4NiB8fCBwcm9maWxlSWRjID09PSAxMTggfHwgcHJvZmlsZUlkYyA9PT0gMTI4KSB7CiAgICAgICAgICB2YXIgY2hyb21hRm9ybWF0SWRjID0gZGVjb2Rlci5yZWFkVUVHKCk7CiAgICAgICAgICBpZiAoY2hyb21hRm9ybWF0SWRjID09PSAzKSB7CiAgICAgICAgICAgIGRlY29kZXIuc2tpcEJpdHMoMSk7IC8vIHNlcGFyYXRlX2NvbG91cl9wbGFuZV9mbGFnCiAgICAgICAgICB9CiAgICAgICAgICBkZWNvZGVyLnNraXBVRUcoKTsgLy8gYml0X2RlcHRoX2x1bWFfbWludXM4CiAgICAgICAgICBkZWNvZGVyLnNraXBVRUcoKTsgLy8gYml0X2RlcHRoX2Nocm9tYV9taW51czgKICAgICAgICAgIGRlY29kZXIuc2tpcEJpdHMoMSk7IC8vIHFwcHJpbWVfeV96ZXJvX3RyYW5zZm9ybV9ieXBhc3NfZmxhZwogICAgICAgICAgaWYgKGRlY29kZXIucmVhZEJvb2xlYW4oKSkgewogICAgICAgICAgICAvLyBzZXFfc2NhbGluZ19tYXRyaXhfcHJlc2VudF9mbGFnCiAgICAgICAgICAgIHNjYWxpbmdMaXN0Q291bnQgPSBjaHJvbWFGb3JtYXRJZGMgIT09IDMgPyA4IDogMTI7CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBzY2FsaW5nTGlzdENvdW50OyArK19pKSB7CiAgICAgICAgICAgICAgaWYgKGRlY29kZXIucmVhZEJvb2xlYW4oKSkgewogICAgICAgICAgICAgICAgLy8gc2VxX3NjYWxpbmdfbGlzdF9wcmVzZW50X2ZsYWdbIGkgXQogICAgICAgICAgICAgICAgaWYgKF9pIDwgNikgewogICAgICAgICAgICAgICAgICBIMjY0UGFyc2VyLnNraXBTY2FsaW5nTGlzdChkZWNvZGVyLCAxNik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBIMjY0UGFyc2VyLnNraXBTY2FsaW5nTGlzdChkZWNvZGVyLCA2NCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGRlY29kZXIuc2tpcFVFRygpOyAvLyBsb2cyX21heF9mcmFtZV9udW1fbWludXM0CiAgICAgICAgdmFyIHBpY09yZGVyQ250VHlwZSA9IGRlY29kZXIucmVhZFVFRygpOwogICAgICAgIGlmIChwaWNPcmRlckNudFR5cGUgPT09IDApIHsKICAgICAgICAgIGRlY29kZXIucmVhZFVFRygpOyAvLyBsb2cyX21heF9waWNfb3JkZXJfY250X2xzYl9taW51czQKICAgICAgICB9IGVsc2UgaWYgKHBpY09yZGVyQ250VHlwZSA9PT0gMSkgewogICAgICAgICAgZGVjb2Rlci5za2lwQml0cygxKTsgLy8gZGVsdGFfcGljX29yZGVyX2Fsd2F5c196ZXJvX2ZsYWcKICAgICAgICAgIGRlY29kZXIuc2tpcEVHKCk7IC8vIG9mZnNldF9mb3Jfbm9uX3JlZl9waWMKICAgICAgICAgIGRlY29kZXIuc2tpcEVHKCk7IC8vIG9mZnNldF9mb3JfdG9wX3RvX2JvdHRvbV9maWVsZAogICAgICAgICAgbnVtUmVmRnJhbWVzSW5QaWNPcmRlckNudEN5Y2xlID0gZGVjb2Rlci5yZWFkVUVHKCk7CiAgICAgICAgICBmb3IgKHZhciBfaTIgPSAwOyBfaTIgPCBudW1SZWZGcmFtZXNJblBpY09yZGVyQ250Q3ljbGU7ICsrX2kyKSB7CiAgICAgICAgICAgIGRlY29kZXIuc2tpcEVHKCk7IC8vIG9mZnNldF9mb3JfcmVmX2ZyYW1lWyBpIF0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZGVjb2Rlci5za2lwVUVHKCk7IC8vIG1heF9udW1fcmVmX2ZyYW1lcwogICAgICAgIGRlY29kZXIuc2tpcEJpdHMoMSk7IC8vIGdhcHNfaW5fZnJhbWVfbnVtX3ZhbHVlX2FsbG93ZWRfZmxhZwogICAgICAgIHBpY1dpZHRoSW5NYnNNaW51czEgPSBkZWNvZGVyLnJlYWRVRUcoKTsKICAgICAgICBwaWNIZWlnaHRJbk1hcFVuaXRzTWludXMxID0gZGVjb2Rlci5yZWFkVUVHKCk7CiAgICAgICAgZnJhbWVNYnNPbmx5RmxhZyA9IGRlY29kZXIucmVhZEJpdHMoMSk7CiAgICAgICAgaWYgKGZyYW1lTWJzT25seUZsYWcgPT09IDApIHsKICAgICAgICAgIGRlY29kZXIuc2tpcEJpdHMoMSk7IC8vIG1iX2FkYXB0aXZlX2ZyYW1lX2ZpZWxkX2ZsYWcKICAgICAgICB9CiAgICAgICAgZGVjb2Rlci5za2lwQml0cygxKTsgLy8gZGlyZWN0Xzh4OF9pbmZlcmVuY2VfZmxhZwogICAgICAgIGlmIChkZWNvZGVyLnJlYWRCb29sZWFuKCkpIHsKICAgICAgICAgIC8vIGZyYW1lX2Nyb3BwaW5nX2ZsYWcKICAgICAgICAgIGZyYW1lQ3JvcExlZnRPZmZzZXQgPSBkZWNvZGVyLnJlYWRVRUcoKTsKICAgICAgICAgIGZyYW1lQ3JvcFJpZ2h0T2Zmc2V0ID0gZGVjb2Rlci5yZWFkVUVHKCk7CiAgICAgICAgICBmcmFtZUNyb3BUb3BPZmZzZXQgPSBkZWNvZGVyLnJlYWRVRUcoKTsKICAgICAgICAgIGZyYW1lQ3JvcEJvdHRvbU9mZnNldCA9IGRlY29kZXIucmVhZFVFRygpOwogICAgICAgIH0KICAgICAgICBpZiAoZGVjb2Rlci5yZWFkQm9vbGVhbigpKSB7CiAgICAgICAgICAvLyB2dWlfcGFyYW1ldGVyc19wcmVzZW50X2ZsYWcKICAgICAgICAgIGlmIChkZWNvZGVyLnJlYWRCb29sZWFuKCkpIHsKICAgICAgICAgICAgLy8gYXNwZWN0X3JhdGlvX2luZm9fcHJlc2VudF9mbGFnCiAgICAgICAgICAgIHZhciBzYXJSYXRpbzsKICAgICAgICAgICAgdmFyIGFzcGVjdFJhdGlvSWRjID0gZGVjb2Rlci5yZWFkVUJ5dGUoKTsKICAgICAgICAgICAgc3dpdGNoIChhc3BlY3RSYXRpb0lkYykgewogICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICAgIHNhclJhdGlvID0gWzEsIDFdOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgc2FyUmF0aW8gPSBbMTIsIDExXTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgIHNhclJhdGlvID0gWzEwLCAxMV07CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICBzYXJSYXRpbyA9IFsxNiwgMTFdOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgICAgc2FyUmF0aW8gPSBbNDAsIDMzXTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICAgIHNhclJhdGlvID0gWzI0LCAxMV07CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICAgICAgICBzYXJSYXRpbyA9IFsyMCwgMTFdOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgICAgc2FyUmF0aW8gPSBbMzIsIDExXTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgOToKICAgICAgICAgICAgICAgIHNhclJhdGlvID0gWzgwLCAzM107CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDEwOgogICAgICAgICAgICAgICAgc2FyUmF0aW8gPSBbMTgsIDExXTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgMTE6CiAgICAgICAgICAgICAgICBzYXJSYXRpbyA9IFsxNSwgMTFdOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAxMjoKICAgICAgICAgICAgICAgIHNhclJhdGlvID0gWzY0LCAzM107CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDEzOgogICAgICAgICAgICAgICAgc2FyUmF0aW8gPSBbMTYwLCA5OV07CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDE0OgogICAgICAgICAgICAgICAgc2FyUmF0aW8gPSBbNCwgM107CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDE1OgogICAgICAgICAgICAgICAgc2FyUmF0aW8gPSBbMywgMl07CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDE2OgogICAgICAgICAgICAgICAgc2FyUmF0aW8gPSBbMiwgMV07CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDI1NToKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgc2FyUmF0aW8gPSBbZGVjb2Rlci5yZWFkVUJ5dGUoKSA8PCA4IHwgZGVjb2Rlci5yZWFkVUJ5dGUoKSwgZGVjb2Rlci5yZWFkVUJ5dGUoKSA8PCA4IHwgZGVjb2Rlci5yZWFkVUJ5dGUoKV07CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzYXJSYXRpbyAmJiBzYXJSYXRpb1swXSA+IDAgJiYgc2FyUmF0aW9bMV0gPiAwKSB7CiAgICAgICAgICAgICAgc2FyU2NhbGUgPSBzYXJSYXRpb1swXSAvIHNhclJhdGlvWzFdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGVjb2Rlci5yZWFkQm9vbGVhbigpKSB7CiAgICAgICAgICAgIGRlY29kZXIuc2tpcEJpdHMoMSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGVjb2Rlci5yZWFkQm9vbGVhbigpKSB7CiAgICAgICAgICAgIGRlY29kZXIuc2tpcEJpdHMoNCk7CiAgICAgICAgICAgIGlmIChkZWNvZGVyLnJlYWRCb29sZWFuKCkpIHsKICAgICAgICAgICAgICBkZWNvZGVyLnNraXBCaXRzKDI0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGRlY29kZXIucmVhZEJvb2xlYW4oKSkgewogICAgICAgICAgICBkZWNvZGVyLnNraXBVRUcoKTsKICAgICAgICAgICAgZGVjb2Rlci5za2lwVUVHKCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGVjb2Rlci5yZWFkQm9vbGVhbigpKSB7CiAgICAgICAgICAgIHZhciB1bml0c0luVGljayA9IGRlY29kZXIucmVhZFVJbnQoKTsKICAgICAgICAgICAgdmFyIHRpbWVTY2FsZSA9IGRlY29kZXIucmVhZFVJbnQoKTsKICAgICAgICAgICAgdmFyIGZpeGVkRnJhbWVSYXRlID0gZGVjb2Rlci5yZWFkQm9vbGVhbigpOwogICAgICAgICAgICB2YXIgZnJhbWVEdXJhdGlvbiA9IHRpbWVTY2FsZSAvICgyICogdW5pdHNJblRpY2spOwogICAgICAgICAgICBpZiAoZml4ZWRGcmFtZVJhdGUpIHsKICAgICAgICAgICAgICBmcHMgPSBmcmFtZUR1cmF0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICBmcHM6IGZwcyA+IDAgPyBmcHMgOiB1bmRlZmluZWQsCiAgICAgICAgICB3aWR0aDogTWF0aC5jZWlsKCgocGljV2lkdGhJbk1ic01pbnVzMSArIDEpICogMTYgLSBmcmFtZUNyb3BMZWZ0T2Zmc2V0ICogMiAtIGZyYW1lQ3JvcFJpZ2h0T2Zmc2V0ICogMikgKiBzYXJTY2FsZSksCiAgICAgICAgICBoZWlnaHQ6ICgyIC0gZnJhbWVNYnNPbmx5RmxhZykgKiAocGljSGVpZ2h0SW5NYXBVbml0c01pbnVzMSArIDEpICogMTYgLSAoZnJhbWVNYnNPbmx5RmxhZyA/IDIgOiA0KSAqIChmcmFtZUNyb3BUb3BPZmZzZXQgKyBmcmFtZUNyb3BCb3R0b21PZmZzZXQpCiAgICAgICAgfTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEgyNjRQYXJzZXI7CiAgfSgpOwogIHZhciBOQUxVMjY0ID0gLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIE5BTFUyNjQoZGF0YSkgewogICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgTkFMVTI2NCk7CiAgICAgIHRoaXMucGF5bG9hZCA9IGRhdGE7CiAgICAgIHRoaXMubnJpID0gKHRoaXMucGF5bG9hZFswXSAmIDB4NjApID4+IDU7IC8vIG5hbF9yZWZfaWRjCiAgICAgIHRoaXMubmFsVW5pdFR5cGUgPSB0aGlzLnBheWxvYWRbMF0gJiAweDFmOwogICAgICB0aGlzLl9zbGljZVR5cGUgPSBudWxsOwogICAgICB0aGlzLl9pc0ZpcnN0U2xpY2UgPSBmYWxzZTsKICAgIH0KICAgIF9jcmVhdGVDbGFzcyhOQUxVMjY0LCBbewogICAgICBrZXk6ICJ0b1N0cmluZyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiB0b1N0cmluZygpIHsKICAgICAgICByZXR1cm4gIiIuY29uY2F0KE5BTFUyNjQuVFlQRVNbdGhpcy50eXBlKCldIHx8ICdVTktOT1dOJywgIjogTlJJOiAiKS5jb25jYXQodGhpcy5nZXROcmkoKSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0TnJpIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldE5yaSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5ucmk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAidHlwZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiB0eXBlKCkgewogICAgICAgIHJldHVybiB0aGlzLm5hbFVuaXRUeXBlOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImlzS2V5ZnJhbWUiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5uYWxVbml0VHlwZSA9PT0gTkFMVTI2NC5JRFI7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiaXNWQ0wiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5uYWxVbml0VHlwZSA9PSBOQUxVMjY0LklEUiB8fCB0aGlzLm5hbFVuaXRUeXBlID09IE5BTFUyNjQuTkRSOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInBhcnNlSGVhZGVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHBhcnNlSGVhZGVyKCkgewogICAgICAgIHZhciBkZWNvZGVyID0gbmV3IEV4cEdvbG9tYih0aGlzLmdldFBheWxvYWQoKSk7CiAgICAgICAgLy8gc2tpcCBOQUx1IHR5cGUKICAgICAgICBkZWNvZGVyLnJlYWRVQnl0ZSgpOwogICAgICAgIHRoaXMuX2lzRmlyc3RTbGljZSA9IGRlY29kZXIucmVhZFVFRygpID09PSAwOwogICAgICAgIHRoaXMuX3NsaWNlVHlwZSA9IGRlY29kZXIucmVhZFVFRygpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImlzRmlyc3RTbGljZSIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIGlmICghdGhpcy5faXNGaXJzdFNsaWNlKSB7CiAgICAgICAgICB0aGlzLnBhcnNlSGVhZGVyKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLl9pc0ZpcnN0U2xpY2U7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAic2xpY2VUeXBlIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgaWYgKCF0aGlzLl9zbGljZVR5cGUpIHsKICAgICAgICAgIHRoaXMucGFyc2VIZWFkZXIoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuX3NsaWNlVHlwZTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJnZXRQYXlsb2FkIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldFBheWxvYWQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucGF5bG9hZDsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJnZXRQYXlsb2FkU2l6ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRQYXlsb2FkU2l6ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5wYXlsb2FkLmJ5dGVMZW5ndGg7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0U2l6ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRTaXplKCkgewogICAgICAgIHJldHVybiA0ICsgdGhpcy5nZXRQYXlsb2FkU2l6ZSgpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldERhdGEiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0RGF0YSgpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gbmV3IFVpbnQ4QXJyYXkodGhpcy5nZXRTaXplKCkpOwogICAgICAgIHZhciB2aWV3ID0gbmV3IERhdGFWaWV3KHJlc3VsdC5idWZmZXIpOwogICAgICAgIHZpZXcuc2V0VWludDMyKDAsIHRoaXMuZ2V0U2l6ZSgpIC0gNCk7CiAgICAgICAgcmVzdWx0LnNldCh0aGlzLmdldFBheWxvYWQoKSwgNCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgfV0sIFt7CiAgICAgIGtleTogIk5EUiIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiAxOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIklEUiIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiA1OwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIlNFSSIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiA2OwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIlNQUyIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiA3OwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIlBQUyIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiA4OwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIkFVRCIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiA5OwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIlRZUEVTIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgdmFyIF9yZWY7CiAgICAgICAgcmV0dXJuIF9yZWYgPSB7fSwgX2RlZmluZVByb3BlcnR5KF9yZWYsIE5BTFUyNjQuSURSLCAnSURSJyksIF9kZWZpbmVQcm9wZXJ0eShfcmVmLCBOQUxVMjY0LlNFSSwgJ1NFSScpLCBfZGVmaW5lUHJvcGVydHkoX3JlZiwgTkFMVTI2NC5TUFMsICdTUFMnKSwgX2RlZmluZVByb3BlcnR5KF9yZWYsIE5BTFUyNjQuUFBTLCAnUFBTJyksIF9kZWZpbmVQcm9wZXJ0eShfcmVmLCBOQUxVMjY0Lk5EUiwgJ05EUicpLCBfZGVmaW5lUHJvcGVydHkoX3JlZiwgTkFMVTI2NC5BVUQsICdBVUQnKSwgX3JlZjsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIE5BTFUyNjQ7CiAgfSgpOwoKICBmdW5jdGlvbiBhcHBlbmRCeXRlQXJyYXkoYnVmZmVyMSwgYnVmZmVyMikgewogICAgdmFyIHRtcCA9IG5ldyBVaW50OEFycmF5KChidWZmZXIxLmJ5dGVMZW5ndGggfCAwKSArIChidWZmZXIyLmJ5dGVMZW5ndGggfCAwKSk7CiAgICB0bXAuc2V0KGJ1ZmZlcjEsIDApOwogICAgdG1wLnNldChidWZmZXIyLCBidWZmZXIxLmJ5dGVMZW5ndGggfCAwKTsKICAgIHJldHVybiB0bXA7CiAgfQogIGZ1bmN0aW9uIHNlY1RvVGltZShzZWMpIHsKICAgIHZhciBzZWNvbmRzLAogICAgICBob3VycywKICAgICAgbWludXRlcywKICAgICAgcmVzdWx0ID0gJyc7CiAgICBzZWNvbmRzID0gTWF0aC5mbG9vcihzZWMpOwogICAgaG91cnMgPSBwYXJzZUludChzZWNvbmRzIC8gMzYwMCwgMTApICUgMjQ7CiAgICBtaW51dGVzID0gcGFyc2VJbnQoc2Vjb25kcyAvIDYwLCAxMCkgJSA2MDsKICAgIHNlY29uZHMgPSBzZWNvbmRzIDwgMCA/IDAgOiBzZWNvbmRzICUgNjA7CiAgICBpZiAoaG91cnMgPiAwKSB7CiAgICAgIHJlc3VsdCArPSAoaG91cnMgPCAxMCA/ICcwJyArIGhvdXJzIDogaG91cnMpICsgJzonOwogICAgfQogICAgcmVzdWx0ICs9IChtaW51dGVzIDwgMTAgPyAnMCcgKyBtaW51dGVzIDogbWludXRlcykgKyAnOicgKyAoc2Vjb25kcyA8IDEwID8gJzAnICsgc2Vjb25kcyA6IHNlY29uZHMpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIHZhciBIMjY0UmVtdXhlciA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoX0Jhc2VSZW11eGVyKSB7CiAgICBfaW5oZXJpdHMoSDI2NFJlbXV4ZXIsIF9CYXNlUmVtdXhlcik7CiAgICB2YXIgX3N1cGVyID0gX2NyZWF0ZVN1cGVyKEgyNjRSZW11eGVyKTsKICAgIGZ1bmN0aW9uIEgyNjRSZW11eGVyKHRpbWVzY2FsZSwgZHVyYXRpb24sIGZyYW1lRHVyYXRpb24pIHsKICAgICAgdmFyIF90aGlzOwogICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgSDI2NFJlbXV4ZXIpOwogICAgICBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMsICdIMjY0UmVtdXhlcicpOwogICAgICBfdGhpcy5mcmFtZUR1cmF0aW9uID0gZnJhbWVEdXJhdGlvbjsKICAgICAgX3RoaXMucmVhZHlUb0RlY29kZSA9IGZhbHNlOwogICAgICBfdGhpcy5uZXh0RHRzID0gMDsKICAgICAgX3RoaXMuZHRzID0gMDsKICAgICAgX3RoaXMubXA0dHJhY2sgPSB7CiAgICAgICAgaWQ6IEJhc2VSZW11eGVyLmdldFRyYWNrSUQoKSwKICAgICAgICB0eXBlOiAndmlkZW8nLAogICAgICAgIGxlbjogMCwKICAgICAgICBmcmFnbWVudGVkOiB0cnVlLAogICAgICAgIHNwczogJycsCiAgICAgICAgcHBzOiAnJywKICAgICAgICBmcHM6IDMwLAogICAgICAgIHdpZHRoOiAwLAogICAgICAgIGhlaWdodDogMCwKICAgICAgICB0aW1lc2NhbGU6IHRpbWVzY2FsZSwKICAgICAgICBkdXJhdGlvbjogZHVyYXRpb24sCiAgICAgICAgc2FtcGxlczogW10KICAgICAgfTsKICAgICAgX3RoaXMuc2FtcGxlcyA9IFtdOwogICAgICBfdGhpcy5yZW1haW5pbmdEYXRhID0gbmV3IFVpbnQ4QXJyYXkoKTsKICAgICAgX3RoaXMua2ZDb3VudGVyID0gMDsKICAgICAgX3RoaXMucGVuZGluZ1VuaXRzID0ge307CiAgICAgIHJldHVybiBfdGhpczsKICAgIH0KICAgIF9jcmVhdGVDbGFzcyhIMjY0UmVtdXhlciwgW3sKICAgICAga2V5OiAicmVzZXRUcmFjayIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZXNldFRyYWNrKCkgewogICAgICAgIHRoaXMucmVhZHlUb0RlY29kZSA9IGZhbHNlOwogICAgICAgIHRoaXMubXA0dHJhY2suc3BzID0gJyc7CiAgICAgICAgdGhpcy5tcDR0cmFjay5wcHMgPSAnJzsKICAgICAgICB0aGlzLm5leHREdHMgPSAwOwogICAgICAgIHRoaXMuZHRzID0gMDsKICAgICAgICB0aGlzLnJlbWFpbmluZ0RhdGEgPSBuZXcgVWludDhBcnJheSgpOwogICAgICAgIHRoaXMua2ZDb3VudGVyID0gMDsKICAgICAgICB0aGlzLnBlbmRpbmdVbml0cyA9IHt9OwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImZlZWQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZmVlZChkYXRhLCBkdXJhdGlvbiwgY29tcG9zaXRpb25UaW1lT2Zmc2V0KSB7CiAgICAgICAgdmFyIHNsaWNlcyA9IFtdOwogICAgICAgIHZhciBsZWZ0OwogICAgICAgIGRhdGEgPSBhcHBlbmRCeXRlQXJyYXkodGhpcy5yZW1haW5pbmdEYXRhLCBkYXRhKTsKICAgICAgICB2YXIgX0gyNjRQYXJzZXIkZXh0cmFjdE5BID0gSDI2NFBhcnNlci5leHRyYWN0TkFMdShkYXRhKTsKICAgICAgICB2YXIgX0gyNjRQYXJzZXIkZXh0cmFjdE5BMiA9IF9zbGljZWRUb0FycmF5KF9IMjY0UGFyc2VyJGV4dHJhY3ROQSwgMik7CiAgICAgICAgc2xpY2VzID0gX0gyNjRQYXJzZXIkZXh0cmFjdE5BMlswXTsKICAgICAgICBsZWZ0ID0gX0gyNjRQYXJzZXIkZXh0cmFjdE5BMlsxXTsKICAgICAgICB0aGlzLnJlbWFpbmluZ0RhdGEgPSBsZWZ0IHx8IG5ldyBVaW50OEFycmF5KCk7CiAgICAgICAgaWYgKHNsaWNlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICB0aGlzLnJlbXV4KHRoaXMuZ2V0VmlkZW9GcmFtZXMoc2xpY2VzLCBkdXJhdGlvbiwgY29tcG9zaXRpb25UaW1lT2Zmc2V0KSk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZXJyb3IoJ0ZhaWxlZCB0byBleHRyYWN0IGFueSBOQUwgdW5pdHMgZnJvbSB2aWRlbyBkYXRhOicsIGxlZnQpOwogICAgICAgICAgdGhpcy5kaXNwYXRjaCgnb3V0T2ZEYXRhJyk7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldFZpZGVvRnJhbWVzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldFZpZGVvRnJhbWVzKG5hbHVzLCBkdXJhdGlvbiwgY29tcG9zaXRpb25UaW1lT2Zmc2V0KSB7CiAgICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CiAgICAgICAgdmFyIHVuaXRzID0gW10sCiAgICAgICAgICBmcmFtZXMgPSBbXSwKICAgICAgICAgIGZkID0gMCwKICAgICAgICAgIC8vIGZyYW1lIGR1cmF0aW9uCiAgICAgICAgICB0dCA9IDAsCiAgICAgICAgICAvLyB0aW1lIHRpY2tzIChyZW1haW5kZXIgYWRqdXN0bWVudCBjb3VudGVyKQogICAgICAgICAga2V5RnJhbWUgPSBmYWxzZSwKICAgICAgICAgIHZjbCA9IGZhbHNlOyAvLyBWaWRlbyBDb2RpbmcgTGF5ZXIgZGF0YSAoaS5lLiwgYSAicmVhbCIgZnJhbWUpCiAgICAgICAgaWYgKHRoaXMucGVuZGluZ1VuaXRzLnVuaXRzKSB7CiAgICAgICAgICB1bml0cyA9IHRoaXMucGVuZGluZ1VuaXRzLnVuaXRzOwogICAgICAgICAgdmNsID0gdGhpcy5wZW5kaW5nVW5pdHMudmNsOwogICAgICAgICAga2V5RnJhbWUgPSB0aGlzLnBlbmRpbmdVbml0cy5rZXlGcmFtZTsKICAgICAgICAgIHRoaXMucGVuZGluZ1VuaXRzID0ge307CiAgICAgICAgfQogICAgICAgIHZhciBfaXRlcmF0b3IgPSBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlcihuYWx1cyksCiAgICAgICAgICBfc3RlcDsKICAgICAgICB0cnkgewogICAgICAgICAgZm9yIChfaXRlcmF0b3IucygpOyAhKF9zdGVwID0gX2l0ZXJhdG9yLm4oKSkuZG9uZTspIHsKICAgICAgICAgICAgdmFyIG5hbHUgPSBfc3RlcC52YWx1ZTsKICAgICAgICAgICAgdmFyIHVuaXQgPSBuZXcgTkFMVTI2NChuYWx1KTsKCiAgICAgICAgICAgIC8vIGZyYW1lIGJvdW5kYXJ5IGRldGVjdGlvbgogICAgICAgICAgICBpZiAodW5pdHMubGVuZ3RoICYmIHZjbCAmJiAodW5pdC5pc0ZpcnN0U2xpY2UgfHwgIXVuaXQuaXNWQ0wpKSB7CiAgICAgICAgICAgICAgZnJhbWVzLnB1c2goewogICAgICAgICAgICAgICAgdW5pdHM6IHVuaXRzLAogICAgICAgICAgICAgICAga2V5RnJhbWU6IGtleUZyYW1lCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgdW5pdHMgPSBbXTsKICAgICAgICAgICAgICBrZXlGcmFtZSA9IGZhbHNlOwogICAgICAgICAgICAgIHZjbCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVuaXRzLnB1c2godW5pdCk7CiAgICAgICAgICAgIGtleUZyYW1lID0ga2V5RnJhbWUgfHwgdW5pdC5pc0tleWZyYW1lOwogICAgICAgICAgICB2Y2wgPSB2Y2wgfHwgdW5pdC5pc1ZDTDsKICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIF9pdGVyYXRvci5lKGVycik7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIF9pdGVyYXRvci5mKCk7CiAgICAgICAgfQogICAgICAgIGlmICh1bml0cy5sZW5ndGgpIHsKICAgICAgICAgIC8vIGxldHMga2VlcCBpbmRlY2lzaXZlIG5hbHVzIGFzIHBlbmRpbmcgaW4gY2FzZSBvZiBmaXhlZCBmcHMKICAgICAgICAgIGlmICghZHVyYXRpb24pIHsKICAgICAgICAgICAgdGhpcy5wZW5kaW5nVW5pdHMgPSB7CiAgICAgICAgICAgICAgdW5pdHM6IHVuaXRzLAogICAgICAgICAgICAgIGtleUZyYW1lOiBrZXlGcmFtZSwKICAgICAgICAgICAgICB2Y2w6IHZjbAogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIGlmICh2Y2wpIHsKICAgICAgICAgICAgZnJhbWVzLnB1c2goewogICAgICAgICAgICAgIHVuaXRzOiB1bml0cywKICAgICAgICAgICAgICBrZXlGcmFtZToga2V5RnJhbWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgbGFzdCA9IGZyYW1lcy5sZW5ndGggLSAxOwogICAgICAgICAgICBpZiAobGFzdCA+PSAwKSB7CiAgICAgICAgICAgICAgZnJhbWVzW2xhc3RdLnVuaXRzID0gZnJhbWVzW2xhc3RdLnVuaXRzLmNvbmNhdCh1bml0cyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZmQgPSBkdXJhdGlvbiA/IGR1cmF0aW9uIC8gZnJhbWVzLmxlbmd0aCB8IDAgOiB0aGlzLmZyYW1lRHVyYXRpb247CiAgICAgICAgdHQgPSBkdXJhdGlvbiA/IGR1cmF0aW9uIC0gZmQgKiBmcmFtZXMubGVuZ3RoIDogMDsKICAgICAgICBmcmFtZXMubWFwKGZ1bmN0aW9uIChmcmFtZSkgewogICAgICAgICAgZnJhbWUuZHVyYXRpb24gPSBmZDsKICAgICAgICAgIGZyYW1lLmNvbXBvc2l0aW9uVGltZU9mZnNldCA9IGNvbXBvc2l0aW9uVGltZU9mZnNldDsKICAgICAgICAgIGlmICh0dCA+IDApIHsKICAgICAgICAgICAgZnJhbWUuZHVyYXRpb24rKzsKICAgICAgICAgICAgdHQtLTsKICAgICAgICAgIH0KICAgICAgICAgIF90aGlzMi5rZkNvdW50ZXIrKzsKICAgICAgICAgIGlmIChmcmFtZS5rZXlGcmFtZSkgewogICAgICAgICAgICBfdGhpczIuZGlzcGF0Y2goJ2tleWZyYW1lUG9zaXRpb24nLCBfdGhpczIua2ZDb3VudGVyICogZmQgLyAxMDAwKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBsb2coImptdXhlcjogTm8uIG9mIEgyNjQgZnJhbWVzIG9mIHRoZSBsYXN0IGNodW5rOiAiLmNvbmNhdChmcmFtZXMubGVuZ3RoKSk7CiAgICAgICAgcmV0dXJuIGZyYW1lczsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZW11eCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW11eChmcmFtZXMpIHsKICAgICAgICB2YXIgX2l0ZXJhdG9yMiA9IF9jcmVhdGVGb3JPZkl0ZXJhdG9ySGVscGVyKGZyYW1lcyksCiAgICAgICAgICBfc3RlcDI7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGZvciAoX2l0ZXJhdG9yMi5zKCk7ICEoX3N0ZXAyID0gX2l0ZXJhdG9yMi5uKCkpLmRvbmU7KSB7CiAgICAgICAgICAgIHZhciBmcmFtZSA9IF9zdGVwMi52YWx1ZTsKICAgICAgICAgICAgdmFyIHVuaXRzID0gW107CiAgICAgICAgICAgIHZhciBzaXplID0gMDsKICAgICAgICAgICAgdmFyIF9pdGVyYXRvcjMgPSBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlcihmcmFtZS51bml0cyksCiAgICAgICAgICAgICAgX3N0ZXAzOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGZvciAoX2l0ZXJhdG9yMy5zKCk7ICEoX3N0ZXAzID0gX2l0ZXJhdG9yMy5uKCkpLmRvbmU7KSB7CiAgICAgICAgICAgICAgICB2YXIgdW5pdCA9IF9zdGVwMy52YWx1ZTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcnNlTkFMKHVuaXQpKSB7CiAgICAgICAgICAgICAgICAgIHVuaXRzLnB1c2godW5pdCk7CiAgICAgICAgICAgICAgICAgIHNpemUgKz0gdW5pdC5nZXRTaXplKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICBfaXRlcmF0b3IzLmUoZXJyKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBfaXRlcmF0b3IzLmYoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodW5pdHMubGVuZ3RoID4gMCAmJiB0aGlzLnJlYWR5VG9EZWNvZGUpIHsKICAgICAgICAgICAgICB0aGlzLm1wNHRyYWNrLmxlbiArPSBzaXplOwogICAgICAgICAgICAgIHRoaXMuc2FtcGxlcy5wdXNoKHsKICAgICAgICAgICAgICAgIHVuaXRzOiB1bml0cywKICAgICAgICAgICAgICAgIHNpemU6IHNpemUsCiAgICAgICAgICAgICAgICBrZXlGcmFtZTogZnJhbWUua2V5RnJhbWUsCiAgICAgICAgICAgICAgICBkdXJhdGlvbjogZnJhbWUuZHVyYXRpb24sCiAgICAgICAgICAgICAgICBjb21wb3NpdGlvblRpbWVPZmZzZXQ6IGZyYW1lLmNvbXBvc2l0aW9uVGltZU9mZnNldAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICBfaXRlcmF0b3IyLmUoZXJyKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgX2l0ZXJhdG9yMi5mKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldFBheWxvYWQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0UGF5bG9hZCgpIHsKICAgICAgICBpZiAoIXRoaXMuaXNSZWFkeSgpKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIHBheWxvYWQgPSBuZXcgVWludDhBcnJheSh0aGlzLm1wNHRyYWNrLmxlbik7CiAgICAgICAgdmFyIG9mZnNldCA9IDA7CiAgICAgICAgdmFyIHNhbXBsZXMgPSB0aGlzLm1wNHRyYWNrLnNhbXBsZXM7CiAgICAgICAgdmFyIG1wNFNhbXBsZSwgZHVyYXRpb247CiAgICAgICAgdGhpcy5kdHMgPSB0aGlzLm5leHREdHM7CiAgICAgICAgd2hpbGUgKHRoaXMuc2FtcGxlcy5sZW5ndGgpIHsKICAgICAgICAgIHZhciBzYW1wbGUgPSB0aGlzLnNhbXBsZXMuc2hpZnQoKSwKICAgICAgICAgICAgdW5pdHMgPSBzYW1wbGUudW5pdHM7CiAgICAgICAgICBkdXJhdGlvbiA9IHNhbXBsZS5kdXJhdGlvbjsKICAgICAgICAgIGlmIChkdXJhdGlvbiA8PSAwKSB7CiAgICAgICAgICAgIGxvZygicmVtdXhlcjogaW52YWxpZCBzYW1wbGUgZHVyYXRpb24gYXQgRFRTOiAiLmNvbmNhdCh0aGlzLm5leHREdHMsICIgOiIpLmNvbmNhdChkdXJhdGlvbikpOwogICAgICAgICAgICB0aGlzLm1wNHRyYWNrLmxlbiAtPSBzYW1wbGUuc2l6ZTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLm5leHREdHMgKz0gZHVyYXRpb247CiAgICAgICAgICBtcDRTYW1wbGUgPSB7CiAgICAgICAgICAgIHNpemU6IHNhbXBsZS5zaXplLAogICAgICAgICAgICBkdXJhdGlvbjogZHVyYXRpb24sCiAgICAgICAgICAgIGN0czogc2FtcGxlLmNvbXBvc2l0aW9uVGltZU9mZnNldCB8fCAwLAogICAgICAgICAgICBmbGFnczogewogICAgICAgICAgICAgIGlzTGVhZGluZzogMCwKICAgICAgICAgICAgICBpc0RlcGVuZGVkT246IDAsCiAgICAgICAgICAgICAgaGFzUmVkdW5kYW5jeTogMCwKICAgICAgICAgICAgICBkZWdyYWRQcmlvOiAwLAogICAgICAgICAgICAgIGlzTm9uU3luYzogc2FtcGxlLmtleUZyYW1lID8gMCA6IDEsCiAgICAgICAgICAgICAgZGVwZW5kc09uOiBzYW1wbGUua2V5RnJhbWUgPyAyIDogMQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIF9pdGVyYXRvcjQgPSBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlcih1bml0cyksCiAgICAgICAgICAgIF9zdGVwNDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGZvciAoX2l0ZXJhdG9yNC5zKCk7ICEoX3N0ZXA0ID0gX2l0ZXJhdG9yNC5uKCkpLmRvbmU7KSB7CiAgICAgICAgICAgICAgdmFyIHVuaXQgPSBfc3RlcDQudmFsdWU7CiAgICAgICAgICAgICAgcGF5bG9hZC5zZXQodW5pdC5nZXREYXRhKCksIG9mZnNldCk7CiAgICAgICAgICAgICAgb2Zmc2V0ICs9IHVuaXQuZ2V0U2l6ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgX2l0ZXJhdG9yNC5lKGVycik7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBfaXRlcmF0b3I0LmYoKTsKICAgICAgICAgIH0KICAgICAgICAgIHNhbXBsZXMucHVzaChtcDRTYW1wbGUpOwogICAgICAgIH0KICAgICAgICBpZiAoIXNhbXBsZXMubGVuZ3RoKSByZXR1cm4gbnVsbDsKICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkocGF5bG9hZC5idWZmZXIsIDAsIHRoaXMubXA0dHJhY2subGVuKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJwYXJzZVNQUyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBwYXJzZVNQUyhzcHMpIHsKICAgICAgICB2YXIgY29uZmlnID0gSDI2NFBhcnNlci5yZWFkU1BTKG5ldyBVaW50OEFycmF5KHNwcykpOwogICAgICAgIHRoaXMubXA0dHJhY2suZnBzID0gY29uZmlnLmZwcyB8fCB0aGlzLm1wNHRyYWNrLmZwczsKICAgICAgICB0aGlzLm1wNHRyYWNrLndpZHRoID0gY29uZmlnLndpZHRoOwogICAgICAgIHRoaXMubXA0dHJhY2suaGVpZ2h0ID0gY29uZmlnLmhlaWdodDsKICAgICAgICB0aGlzLm1wNHRyYWNrLnNwcyA9IFtuZXcgVWludDhBcnJheShzcHMpXTsKICAgICAgICB0aGlzLm1wNHRyYWNrLmNvZGVjID0gJ2F2YzEuJzsKICAgICAgICB2YXIgY29kZWNhcnJheSA9IG5ldyBEYXRhVmlldyhzcHMuYnVmZmVyLCBzcHMuYnl0ZU9mZnNldCArIDEsIDQpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgMzsgKytpKSB7CiAgICAgICAgICB2YXIgaCA9IGNvZGVjYXJyYXkuZ2V0VWludDgoaSkudG9TdHJpbmcoMTYpOwogICAgICAgICAgaWYgKGgubGVuZ3RoIDwgMikgewogICAgICAgICAgICBoID0gJzAnICsgaDsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMubXA0dHJhY2suY29kZWMgKz0gaDsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicGFyc2VQUFMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcGFyc2VQUFMocHBzKSB7CiAgICAgICAgdGhpcy5tcDR0cmFjay5wcHMgPSBbbmV3IFVpbnQ4QXJyYXkocHBzKV07CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicGFyc2VOQUwiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcGFyc2VOQUwodW5pdCkgewogICAgICAgIGlmICghdW5pdCkgcmV0dXJuIGZhbHNlOwogICAgICAgIGlmICh1bml0LmlzVkNMKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgdmFyIHB1c2ggPSBmYWxzZTsKICAgICAgICBzd2l0Y2ggKHVuaXQudHlwZSgpKSB7CiAgICAgICAgICBjYXNlIE5BTFUyNjQuUFBTOgogICAgICAgICAgICBpZiAoIXRoaXMubXA0dHJhY2sucHBzKSB7CiAgICAgICAgICAgICAgdGhpcy5wYXJzZVBQUyh1bml0LmdldFBheWxvYWQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHVzaCA9IHRydWU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBOQUxVMjY0LlNQUzoKICAgICAgICAgICAgaWYgKCF0aGlzLm1wNHRyYWNrLnNwcykgewogICAgICAgICAgICAgIHRoaXMucGFyc2VTUFModW5pdC5nZXRQYXlsb2FkKCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHB1c2ggPSB0cnVlOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgTkFMVTI2NC5BVUQ6CiAgICAgICAgICAgIGxvZygnQVVEIC0gaWdub2luZycpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgTkFMVTI2NC5TRUk6CiAgICAgICAgICAgIGxvZygnU0VJIC0gaWdub2luZycpOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLnJlYWR5VG9EZWNvZGUgJiYgdGhpcy5tcDR0cmFjay5wcHMgJiYgdGhpcy5tcDR0cmFjay5zcHMpIHsKICAgICAgICAgIHRoaXMucmVhZHlUb0RlY29kZSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwdXNoOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gSDI2NFJlbXV4ZXI7CiAgfShCYXNlUmVtdXhlcik7CgogIC8vIHNwZWMgaHR0cHM6Ly93d3cuaXR1LmludC9yZWMvVC1SRUMtSC4yNjUvCgogIHZhciBIMjY1UGFyc2VyID0gLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIEgyNjVQYXJzZXIoKSB7CiAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBIMjY1UGFyc2VyKTsKICAgIH0KICAgIF9jcmVhdGVDbGFzcyhIMjY1UGFyc2VyLCBudWxsLCBbewogICAgICBrZXk6ICJleHRyYWN0TkFMdSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBleHRyYWN0TkFMdShidWZmZXIpIHsKICAgICAgICB2YXIgaSA9IDAsCiAgICAgICAgICBsZW5ndGggPSBidWZmZXIuYnl0ZUxlbmd0aCwKICAgICAgICAgIHJlc3VsdCA9IFtdLAogICAgICAgICAgbGFzdEluZGV4ID0gMCwKICAgICAgICAgIHplcm9Db3VudCA9IDA7CiAgICAgICAgd2hpbGUgKGkgPCBsZW5ndGgpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IGJ1ZmZlcltpKytdOwogICAgICAgICAgaWYgKHZhbHVlID09PSAwKSB7CiAgICAgICAgICAgIHplcm9Db3VudCsrOwogICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gMSAmJiB6ZXJvQ291bnQgPj0gMikgewogICAgICAgICAgICB2YXIgc3RhcnRDb2RlTGVuZ3RoID0gemVyb0NvdW50ICsgMTsKICAgICAgICAgICAgaWYgKGxhc3RJbmRleCAhPT0gaSAtIHN0YXJ0Q29kZUxlbmd0aCkgewogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGJ1ZmZlci5zdWJhcnJheShsYXN0SW5kZXgsIGkgLSBzdGFydENvZGVMZW5ndGgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYXN0SW5kZXggPSBpOwogICAgICAgICAgICB6ZXJvQ291bnQgPSAwOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgemVyb0NvdW50ID0gMDsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFJlbWFpbmluZyBkYXRhIGFmdGVyIGxhc3Qgc3RhcnQgY29kZQogICAgICAgIHZhciBsZWZ0ID0gbnVsbDsKICAgICAgICBpZiAobGFzdEluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICBsZWZ0ID0gYnVmZmVyLnN1YmFycmF5KGxhc3RJbmRleCwgbGVuZ3RoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFtyZXN1bHQsIGxlZnRdOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlbW92ZUVtdWxhdGlvblByZXZlbnRpb25CeXRlcyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW1vdmVFbXVsYXRpb25QcmV2ZW50aW9uQnl0ZXMobmFsKSB7CiAgICAgICAgdmFyIHJic3AgPSBbXTsKICAgICAgICB2YXIgemVyb0NvdW50ID0gMDsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5hbC5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIHZhbHVlID0gbmFsW2ldOwogICAgICAgICAgaWYgKHplcm9Db3VudCA9PT0gMiAmJiB2YWx1ZSA9PT0gMHgwMykgewogICAgICAgICAgICAvLyBTa2lwIHRoaXMgZW11bGF0aW9uIHByZXZlbnRpb24gYnl0ZQogICAgICAgICAgICB6ZXJvQ291bnQgPSAwOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJic3AucHVzaCh2YWx1ZSk7CiAgICAgICAgICBpZiAodmFsdWUgPT09IDB4MDApIHsKICAgICAgICAgICAgemVyb0NvdW50Kys7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB6ZXJvQ291bnQgPSAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkocmJzcCk7CiAgICAgIH0KCiAgICAgIC8qKgogICAgICAgKiBSZWFkIGEgc2VxdWVuY2UgcGFyYW1ldGVyIHNldCBhbmQgcmV0dXJuIHNvbWUgaW50ZXJlc3RpbmcgdmlkZW8KICAgICAgICogcHJvcGVydGllcy4gQSBzZXF1ZW5jZSBwYXJhbWV0ZXIgc2V0IGlzIHRoZSBIMjY1IG1ldGFkYXRhIHRoYXQKICAgICAgICogZGVzY3JpYmVzIHRoZSBwcm9wZXJ0aWVzIG9mIHVwY29taW5nIHZpZGVvIGZyYW1lcy4KICAgICAgICogQHBhcmFtIGRhdGEge1VpbnQ4QXJyYXl9IHRoZSBieXRlcyBvZiBhIHNlcXVlbmNlIHBhcmFtZXRlciBzZXQKICAgICAgICogQHJldHVybiB7b2JqZWN0fSBhbiBvYmplY3Qgd2l0aCBjb25maWd1cmF0aW9uIHBhcnNlZCBmcm9tIHRoZQogICAgICAgKiBzZXF1ZW5jZSBwYXJhbWV0ZXIgc2V0LCBpbmNsdWRpbmcgdGhlIGRpbWVuc2lvbnMgb2YgdGhlCiAgICAgICAqIGFzc29jaWF0ZWQgdmlkZW8gZnJhbWVzLgogICAgICAgKi8KICAgIH0sIHsKICAgICAga2V5OiAicmVhZFNQUyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZWFkU1BTKGRhdGEpIHsKICAgICAgICB2YXIgZGVjb2RlciA9IG5ldyBFeHBHb2xvbWIoZGF0YSk7CgogICAgICAgIC8vIFNraXAgTkFMVSBoZWFkZXIgKDIgYnl0ZXMgZm9yIEhFVkMpCiAgICAgICAgZGVjb2Rlci5yZWFkVUJ5dGUoKTsKICAgICAgICBkZWNvZGVyLnJlYWRVQnl0ZSgpOwogICAgICAgIGRlY29kZXIucmVhZEJpdHMoNCk7IC8vIHNwc192aWRlb19wYXJhbWV0ZXJfc2V0X2lkCiAgICAgICAgZGVjb2Rlci5yZWFkQml0cygzKTsgLy8gc3BzX21heF9zdWJfbGF5ZXJzX21pbnVzMQogICAgICAgIGRlY29kZXIucmVhZEJpdHMoMSk7IC8vIHNwc190ZW1wb3JhbF9pZF9uZXN0aW5nX2ZsYWcKCiAgICAgICAgLy8gLS0tIHByb2ZpbGVfdGllcl9sZXZlbCgpIC0tLQogICAgICAgIHZhciBwcm9maWxlX3NwYWNlID0gZGVjb2Rlci5yZWFkQml0cygyKTsKICAgICAgICB2YXIgdGllcl9mbGFnID0gZGVjb2Rlci5yZWFkQml0cygxKTsKICAgICAgICB2YXIgcHJvZmlsZV9pZGMgPSBkZWNvZGVyLnJlYWRCaXRzKDUpOwogICAgICAgIHZhciBwcm9maWxlX2NvbXBhdGliaWxpdHlfZmxhZ3MgPSBkZWNvZGVyLnJlYWRVSW50KCk7IC8vIDMyIGJpdHMKICAgICAgICB2YXIgY29uc3RyYWludF9pbmRpY2F0b3JfZmxhZ3MgPSBuZXcgVWludDhBcnJheSg2KTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDY7IGkrKykgewogICAgICAgICAgY29uc3RyYWludF9pbmRpY2F0b3JfZmxhZ3NbaV0gPSBkZWNvZGVyLnJlYWRVQnl0ZSgpOwogICAgICAgIH0KICAgICAgICB2YXIgbGV2ZWxfaWRjID0gZGVjb2Rlci5yZWFkVUJ5dGUoKTsKICAgICAgICBkZWNvZGVyLnJlYWRVRUcoKTsgLy8gc2VxX3BhcmFtZXRlcl9zZXRfaWQKCiAgICAgICAgdmFyIGNocm9tYV9mb3JtYXRfaWRjID0gZGVjb2Rlci5yZWFkVUVHKCk7CiAgICAgICAgaWYgKGNocm9tYV9mb3JtYXRfaWRjID09PSAzKSB7CiAgICAgICAgICBkZWNvZGVyLnJlYWRCaXRzKDEpOyAvLyBzZXBhcmF0ZV9jb2xvdXJfcGxhbmVfZmxhZwogICAgICAgIH0KICAgICAgICB2YXIgcGljX3dpZHRoX2luX2x1bWFfc2FtcGxlcyA9IGRlY29kZXIucmVhZFVFRygpOwogICAgICAgIHZhciBwaWNfaGVpZ2h0X2luX2x1bWFfc2FtcGxlcyA9IGRlY29kZXIucmVhZFVFRygpOwoKICAgICAgICAvLyBDcm9wcGluZwogICAgICAgIHZhciBjb25mb3JtYW5jZV93aW5kb3dfZmxhZyA9IGRlY29kZXIucmVhZEJvb2xlYW4oKTsKICAgICAgICB2YXIgY29uZl93aW5fbGVmdF9vZmZzZXQgPSAwLAogICAgICAgICAgY29uZl93aW5fcmlnaHRfb2Zmc2V0ID0gMCwKICAgICAgICAgIGNvbmZfd2luX3RvcF9vZmZzZXQgPSAwLAogICAgICAgICAgY29uZl93aW5fYm90dG9tX29mZnNldCA9IDA7CiAgICAgICAgaWYgKGNvbmZvcm1hbmNlX3dpbmRvd19mbGFnKSB7CiAgICAgICAgICBjb25mX3dpbl9sZWZ0X29mZnNldCA9IGRlY29kZXIucmVhZFVFRygpOwogICAgICAgICAgY29uZl93aW5fcmlnaHRfb2Zmc2V0ID0gZGVjb2Rlci5yZWFkVUVHKCk7CiAgICAgICAgICBjb25mX3dpbl90b3Bfb2Zmc2V0ID0gZGVjb2Rlci5yZWFkVUVHKCk7CiAgICAgICAgICBjb25mX3dpbl9ib3R0b21fb2Zmc2V0ID0gZGVjb2Rlci5yZWFkVUVHKCk7CiAgICAgICAgfQogICAgICAgIHZhciBmcHMgPSBudWxsOwogICAgICAgIHZhciB2dWlfcGFyYW1ldGVyc19wcmVzZW50X2ZsYWcgPSBkZWNvZGVyLnJlYWRCb29sZWFuKCk7CiAgICAgICAgaWYgKHZ1aV9wYXJhbWV0ZXJzX3ByZXNlbnRfZmxhZykgewogICAgICAgICAgdmFyIGFzcGVjdF9yYXRpb19pbmZvX3ByZXNlbnRfZmxhZyA9IGRlY29kZXIucmVhZEJvb2xlYW4oKTsKICAgICAgICAgIGlmIChhc3BlY3RfcmF0aW9faW5mb19wcmVzZW50X2ZsYWcpIHsKICAgICAgICAgICAgdmFyIGFzcGVjdF9yYXRpb19pZGMgPSBkZWNvZGVyLnJlYWRVQnl0ZSgpOwogICAgICAgICAgICBpZiAoYXNwZWN0X3JhdGlvX2lkYyA9PT0gMjU1KSB7CiAgICAgICAgICAgICAgLy8gRXh0ZW5kZWRfU0FSCiAgICAgICAgICAgICAgZGVjb2Rlci5yZWFkVVNob3J0KCk7IC8vIHNhcl93aWR0aAogICAgICAgICAgICAgIGRlY29kZXIucmVhZFVTaG9ydCgpOyAvLyBzYXJfaGVpZ2h0CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBvdmVyc2Nhbl9pbmZvX3ByZXNlbnRfZmxhZyA9IGRlY29kZXIucmVhZEJvb2xlYW4oKTsKICAgICAgICAgIGlmIChvdmVyc2Nhbl9pbmZvX3ByZXNlbnRfZmxhZykgewogICAgICAgICAgICBkZWNvZGVyLnJlYWRCb29sZWFuKCk7IC8vIG92ZXJzY2FuX2FwcHJvcHJpYXRlX2ZsYWcKICAgICAgICAgIH0KICAgICAgICAgIHZhciB2aWRlb19zaWduYWxfdHlwZV9wcmVzZW50X2ZsYWcgPSBkZWNvZGVyLnJlYWRCb29sZWFuKCk7CiAgICAgICAgICBpZiAodmlkZW9fc2lnbmFsX3R5cGVfcHJlc2VudF9mbGFnKSB7CiAgICAgICAgICAgIGRlY29kZXIucmVhZEJpdHMoMyk7IC8vIHZpZGVvX2Zvcm1hdAogICAgICAgICAgICBkZWNvZGVyLnJlYWRCb29sZWFuKCk7IC8vIHZpZGVvX2Z1bGxfcmFuZ2VfZmxhZwogICAgICAgICAgICB2YXIgY29sb3VyX2Rlc2NyaXB0aW9uX3ByZXNlbnRfZmxhZyA9IGRlY29kZXIucmVhZEJvb2xlYW4oKTsKICAgICAgICAgICAgaWYgKGNvbG91cl9kZXNjcmlwdGlvbl9wcmVzZW50X2ZsYWcpIHsKICAgICAgICAgICAgICBkZWNvZGVyLnJlYWRVQnl0ZSgpOyAvLyBjb2xvdXJfcHJpbWFyaWVzCiAgICAgICAgICAgICAgZGVjb2Rlci5yZWFkVUJ5dGUoKTsgLy8gdHJhbnNmZXJfY2hhcmFjdGVyaXN0aWNzCiAgICAgICAgICAgICAgZGVjb2Rlci5yZWFkVUJ5dGUoKTsgLy8gbWF0cml4X2NvZWZmcwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY2hyb21hX2xvY19pbmZvX3ByZXNlbnRfZmxhZyA9IGRlY29kZXIucmVhZEJvb2xlYW4oKTsKICAgICAgICAgIGlmIChjaHJvbWFfbG9jX2luZm9fcHJlc2VudF9mbGFnKSB7CiAgICAgICAgICAgIGRlY29kZXIucmVhZFVFRygpOyAvLyBjaHJvbWFfc2FtcGxlX2xvY190eXBlX3RvcF9maWVsZAogICAgICAgICAgICBkZWNvZGVyLnJlYWRVRUcoKTsgLy8gY2hyb21hX3NhbXBsZV9sb2NfdHlwZV9ib3R0b21fZmllbGQKICAgICAgICAgIH0KICAgICAgICAgIGRlY29kZXIucmVhZEJvb2xlYW4oKTsgLy8gbmV1dHJhbF9jaHJvbWFfaW5kaWNhdGlvbl9mbGFnCiAgICAgICAgICBkZWNvZGVyLnJlYWRCb29sZWFuKCk7IC8vIGZpZWxkX3NlcV9mbGFnCiAgICAgICAgICBkZWNvZGVyLnJlYWRCb29sZWFuKCk7IC8vIGZyYW1lX2ZpZWxkX2luZm9fcHJlc2VudF9mbGFnCgogICAgICAgICAgLy8gVGltaW5nIGluZm8KICAgICAgICAgIHZhciB0aW1pbmdfaW5mb19wcmVzZW50X2ZsYWcgPSBkZWNvZGVyLnJlYWRCb29sZWFuKCk7CiAgICAgICAgICBpZiAodGltaW5nX2luZm9fcHJlc2VudF9mbGFnKSB7CiAgICAgICAgICAgIHZhciBudW1fdW5pdHNfaW5fdGljayA9IGRlY29kZXIucmVhZFVJbnQoKTsKICAgICAgICAgICAgdmFyIHRpbWVfc2NhbGUgPSBkZWNvZGVyLnJlYWRVSW50KCk7CiAgICAgICAgICAgIGRlY29kZXIucmVhZEJvb2xlYW4oKTsgLy8gcG9jX3Byb3BvcnRpb25hbF90b190aW1pbmdfZmxhZwogICAgICAgICAgICBpZiAobnVtX3VuaXRzX2luX3RpY2spIHsKICAgICAgICAgICAgICBmcHMgPSB0aW1lX3NjYWxlIC8gKDIgKiBudW1fdW5pdHNfaW5fdGljayk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEZpbmFsIHdpZHRoL2hlaWdodAogICAgICAgIHZhciBzdWJfd2lkdGhfYyA9IGNocm9tYV9mb3JtYXRfaWRjID09PSAxIHx8IGNocm9tYV9mb3JtYXRfaWRjID09PSAyID8gMiA6IDE7CiAgICAgICAgdmFyIHN1Yl9oZWlnaHRfYyA9IGNocm9tYV9mb3JtYXRfaWRjID09PSAxID8gMiA6IDE7CiAgICAgICAgdmFyIHdpZHRoID0gcGljX3dpZHRoX2luX2x1bWFfc2FtcGxlcyAtIHN1Yl93aWR0aF9jICogKGNvbmZfd2luX3JpZ2h0X29mZnNldCArIGNvbmZfd2luX2xlZnRfb2Zmc2V0KTsKICAgICAgICB2YXIgaGVpZ2h0ID0gcGljX2hlaWdodF9pbl9sdW1hX3NhbXBsZXMgLSBzdWJfaGVpZ2h0X2MgKiAoY29uZl93aW5fdG9wX29mZnNldCArIGNvbmZfd2luX2JvdHRvbV9vZmZzZXQpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICB3aWR0aDogd2lkdGgsCiAgICAgICAgICBoZWlnaHQ6IGhlaWdodCwKICAgICAgICAgIHByb2ZpbGVfc3BhY2U6IHByb2ZpbGVfc3BhY2UsCiAgICAgICAgICB0aWVyX2ZsYWc6IHRpZXJfZmxhZywKICAgICAgICAgIHByb2ZpbGVfaWRjOiBwcm9maWxlX2lkYywKICAgICAgICAgIHByb2ZpbGVfY29tcGF0aWJpbGl0eV9mbGFnczogcHJvZmlsZV9jb21wYXRpYmlsaXR5X2ZsYWdzLAogICAgICAgICAgY29uc3RyYWludF9pbmRpY2F0b3JfZmxhZ3M6IGNvbnN0cmFpbnRfaW5kaWNhdG9yX2ZsYWdzLAogICAgICAgICAgbGV2ZWxfaWRjOiBsZXZlbF9pZGMsCiAgICAgICAgICBjaHJvbWFfZm9ybWF0X2lkYzogY2hyb21hX2Zvcm1hdF9pZGMsCiAgICAgICAgICBmcHM6IGZwcwogICAgICAgIH07CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBIMjY1UGFyc2VyOwogIH0oKTsKICB2YXIgTkFMVTI2NSA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBOQUxVMjY1KGRhdGEpIHsKICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIE5BTFUyNjUpOwogICAgICB0aGlzLnBheWxvYWQgPSBkYXRhOwogICAgICB0aGlzLm5hbFVuaXRUeXBlID0gKGRhdGFbMF0gJiAxMjYpID4+IDE7CiAgICAgIHRoaXMubnVoTGF5ZXJJZCA9IChkYXRhWzBdICYgMSkgPDwgNSB8IChkYXRhWzFdICYgMjQ4KSA+PiAzOwogICAgICB0aGlzLm51aFRlbXBvcmFsSWRQbHVzMSA9IGRhdGFbMV0gJiA3OwogICAgICB0aGlzLl9pc0ZpcnN0U2xpY2UgPSBudWxsOwogICAgICB0aGlzLl9zbGljZVR5cGUgPSBudWxsOwogICAgfQogICAgX2NyZWF0ZUNsYXNzKE5BTFUyNjUsIFt7CiAgICAgIGtleTogInRvU3RyaW5nIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHRvU3RyaW5nKCkgewogICAgICAgIHJldHVybiAiIi5jb25jYXQoTkFMVTI2NS5UWVBFU1t0aGlzLnR5cGUoKV0gfHwgJ1VOS05PV04gKCcgKyB0aGlzLnR5cGUoKSArICcpJywgIjogTGF5ZXI6ICIpLmNvbmNhdCh0aGlzLm51aExheWVySWQsICIsIFRlbXBvcmFsIElkOiAiKS5jb25jYXQodGhpcy5udWhUZW1wb3JhbElkUGx1czEpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInR5cGUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gdHlwZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5uYWxVbml0VHlwZTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJpc0tleWZyYW1lIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIFtOQUxVMjY1LklEUl9XX1JBREwsIE5BTFUyNjUuSURSX05fTFAsIE5BTFUyNjUuQ1JBXS5pbmNsdWRlcyh0aGlzLm5hbFVuaXRUeXBlKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJpc1ZDTCIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLm5hbFVuaXRUeXBlIDw9IDMxOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInBhcnNlSGVhZGVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHBhcnNlSGVhZGVyKCkgewogICAgICAgIHZhciBkZWNvZGVyID0gbmV3IEV4cEdvbG9tYih0aGlzLmdldFBheWxvYWQoKSk7CiAgICAgICAgLy8gc2tpcCBOQUx1IHR5cGUKICAgICAgICBkZWNvZGVyLnJlYWRVQnl0ZSgpOwogICAgICAgIGRlY29kZXIucmVhZFVCeXRlKCk7CgogICAgICAgIC8vIGZpcnN0X3NsaWNlX3NlZ21lbnRfaW5fcGljX2ZsYWcKICAgICAgICB0aGlzLl9pc0ZpcnN0U2xpY2UgPSBkZWNvZGVyLnJlYWRCb29sZWFuKCk7CgogICAgICAgIC8vIGlmIE5BTFUgaXMgbm90IElEUi9DUkEvb3RoZXIgSVJBUCwgbmV4dCBjb21lcyBub19vdXRwdXRfb2ZfcHJpb3JfcGljc19mbGFnCiAgICAgICAgaWYgKHRoaXMuaXNLZXlmcmFtZSkgewogICAgICAgICAgZGVjb2Rlci5yZWFkQml0cygxKTsgLy8gbm9fb3V0cHV0X29mX3ByaW9yX3BpY3NfZmxhZwogICAgICAgIH0KCiAgICAgICAgLy8gc2xpY2VfcGljX3BhcmFtZXRlcl9zZXRfaWQKICAgICAgICBkZWNvZGVyLnJlYWRVRUcoKTsKCiAgICAgICAgLy8gc2xpY2VfdHlwZSAob25seSBmb3Igc29tZSBOQUxVIHR5cGVzLCBidXQgdXNlZnVsIGZvciBkZWJ1Z2dpbmcpCiAgICAgICAgdGhpcy5fc2xpY2VUeXBlID0gZGVjb2Rlci5yZWFkVUVHKCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiaXNGaXJzdFNsaWNlIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgaWYgKCF0aGlzLl9pc0ZpcnN0U2xpY2UpIHsKICAgICAgICAgIHRoaXMucGFyc2VIZWFkZXIoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuX2lzRmlyc3RTbGljZTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzbGljZVR5cGUiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICBpZiAoIXRoaXMuX3NsaWNlVHlwZSkgewogICAgICAgICAgdGhpcy5wYXJzZUhlYWRlcigpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5fc2xpY2VUeXBlOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldFBheWxvYWQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0UGF5bG9hZCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5wYXlsb2FkOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldFBheWxvYWRTaXplIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldFBheWxvYWRTaXplKCkgewogICAgICAgIHJldHVybiB0aGlzLnBheWxvYWQuYnl0ZUxlbmd0aDsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJnZXRTaXplIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldFNpemUoKSB7CiAgICAgICAgcmV0dXJuIDQgKyB0aGlzLmdldFBheWxvYWRTaXplKCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0RGF0YSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBnZXREYXRhKCkgewogICAgICAgIHZhciByZXN1bHQgPSBuZXcgVWludDhBcnJheSh0aGlzLmdldFNpemUoKSk7CiAgICAgICAgdmFyIHZpZXcgPSBuZXcgRGF0YVZpZXcocmVzdWx0LmJ1ZmZlcik7CiAgICAgICAgdmlldy5zZXRVaW50MzIoMCwgdGhpcy5nZXRTaXplKCkgLSA0KTsKICAgICAgICByZXN1bHQuc2V0KHRoaXMuZ2V0UGF5bG9hZCgpLCA0KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICB9XSwgW3sKICAgICAga2V5OiAiVFJBSUxfTiIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiAwOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIlRSQUlMX1IiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gMTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJJRFJfV19SQURMIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIDE5OwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIklEUl9OX0xQIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIDIwOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIkNSQSIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiAyMTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJWUFMiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gMzI7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiU1BTIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIDMzOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIlBQUyIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiAzNDsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJBVUQiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gMzU7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiU0VJIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIDM5OwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIlNFSTIiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gNDA7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiVFlQRVMiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICB2YXIgX3JlZjsKICAgICAgICByZXR1cm4gX3JlZiA9IHt9LCBfZGVmaW5lUHJvcGVydHkoX3JlZiwgTkFMVTI2NS5UUkFJTF9OLCAnVFJBSUxfTicpLCBfZGVmaW5lUHJvcGVydHkoX3JlZiwgTkFMVTI2NS5UUkFJTF9SLCAnVFJBSUxfUicpLCBfZGVmaW5lUHJvcGVydHkoX3JlZiwgTkFMVTI2NS5JRFJfV19SQURMLCAnSURSJyksIF9kZWZpbmVQcm9wZXJ0eShfcmVmLCBOQUxVMjY1LklEUl9OX0xQLCAnSURSMicpLCBfZGVmaW5lUHJvcGVydHkoX3JlZiwgTkFMVTI2NS5DUkEsICdDUkEnKSwgX2RlZmluZVByb3BlcnR5KF9yZWYsIE5BTFUyNjUuVlBTLCAnVlBTJyksIF9kZWZpbmVQcm9wZXJ0eShfcmVmLCBOQUxVMjY1LlNQUywgJ1NQUycpLCBfZGVmaW5lUHJvcGVydHkoX3JlZiwgTkFMVTI2NS5QUFMsICdQUFMnKSwgX2RlZmluZVByb3BlcnR5KF9yZWYsIE5BTFUyNjUuQVVELCAnQVVEJyksIF9kZWZpbmVQcm9wZXJ0eShfcmVmLCBOQUxVMjY1LlNFSSwgJ1NFSScpLCBfZGVmaW5lUHJvcGVydHkoX3JlZiwgTkFMVTI2NS5TRUkyLCAnU0VJMicpLCBfcmVmOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gTkFMVTI2NTsKICB9KCk7CgogIHZhciBIMjY1UmVtdXhlciA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoX0Jhc2VSZW11eGVyKSB7CiAgICBfaW5oZXJpdHMoSDI2NVJlbXV4ZXIsIF9CYXNlUmVtdXhlcik7CiAgICB2YXIgX3N1cGVyID0gX2NyZWF0ZVN1cGVyKEgyNjVSZW11eGVyKTsKICAgIGZ1bmN0aW9uIEgyNjVSZW11eGVyKHRpbWVzY2FsZSwgZHVyYXRpb24sIGZyYW1lRHVyYXRpb24pIHsKICAgICAgdmFyIF90aGlzOwogICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgSDI2NVJlbXV4ZXIpOwogICAgICBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMsICdIMjY0UmVtdXhlcicpOwogICAgICBfdGhpcy5mcmFtZUR1cmF0aW9uID0gZnJhbWVEdXJhdGlvbjsKICAgICAgX3RoaXMucmVhZHlUb0RlY29kZSA9IGZhbHNlOwogICAgICBfdGhpcy5uZXh0RHRzID0gMDsKICAgICAgX3RoaXMuZHRzID0gMDsKICAgICAgX3RoaXMubXA0dHJhY2sgPSB7CiAgICAgICAgaWQ6IEJhc2VSZW11eGVyLmdldFRyYWNrSUQoKSwKICAgICAgICB0eXBlOiAndmlkZW8nLAogICAgICAgIGxlbjogMCwKICAgICAgICBmcmFnbWVudGVkOiB0cnVlLAogICAgICAgIHZwczogJycsCiAgICAgICAgc3BzOiAnJywKICAgICAgICBwcHM6ICcnLAogICAgICAgIGh2Y0M6IHt9LAogICAgICAgIGZwczogMzAsCiAgICAgICAgd2lkdGg6IDAsCiAgICAgICAgaGVpZ2h0OiAwLAogICAgICAgIHRpbWVzY2FsZTogdGltZXNjYWxlLAogICAgICAgIGR1cmF0aW9uOiBkdXJhdGlvbiwKICAgICAgICBzYW1wbGVzOiBbXQogICAgICB9OwogICAgICBfdGhpcy5zYW1wbGVzID0gW107CiAgICAgIF90aGlzLnJlbWFpbmluZ0RhdGEgPSBuZXcgVWludDhBcnJheSgpOwogICAgICBfdGhpcy5rZkNvdW50ZXIgPSAwOwogICAgICBfdGhpcy5wZW5kaW5nVW5pdHMgPSB7fTsKICAgICAgcmV0dXJuIF90aGlzOwogICAgfQogICAgX2NyZWF0ZUNsYXNzKEgyNjVSZW11eGVyLCBbewogICAgICBrZXk6ICJyZXNldFRyYWNrIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlc2V0VHJhY2soKSB7CiAgICAgICAgdGhpcy5yZWFkeVRvRGVjb2RlID0gZmFsc2U7CiAgICAgICAgdGhpcy5tcDR0cmFjay52cHMgPSAnJzsKICAgICAgICB0aGlzLm1wNHRyYWNrLnNwcyA9ICcnOwogICAgICAgIHRoaXMubXA0dHJhY2sucHBzID0gJyc7CiAgICAgICAgdGhpcy5tcDR0cmFjay5odmNDID0ge307CiAgICAgICAgdGhpcy5uZXh0RHRzID0gMDsKICAgICAgICB0aGlzLmR0cyA9IDA7CiAgICAgICAgdGhpcy5yZW1haW5pbmdEYXRhID0gbmV3IFVpbnQ4QXJyYXkoKTsKICAgICAgICB0aGlzLmtmQ291bnRlciA9IDA7CiAgICAgICAgdGhpcy5wZW5kaW5nVW5pdHMgPSB7fTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJmZWVkIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGZlZWQoZGF0YSwgZHVyYXRpb24sIGNvbXBvc2l0aW9uVGltZU9mZnNldCkgewogICAgICAgIHZhciBzbGljZXMgPSBbXTsKICAgICAgICB2YXIgbGVmdDsKICAgICAgICBkYXRhID0gYXBwZW5kQnl0ZUFycmF5KHRoaXMucmVtYWluaW5nRGF0YSwgZGF0YSk7CiAgICAgICAgdmFyIF9IMjY1UGFyc2VyJGV4dHJhY3ROQSA9IEgyNjVQYXJzZXIuZXh0cmFjdE5BTHUoZGF0YSk7CiAgICAgICAgdmFyIF9IMjY1UGFyc2VyJGV4dHJhY3ROQTIgPSBfc2xpY2VkVG9BcnJheShfSDI2NVBhcnNlciRleHRyYWN0TkEsIDIpOwogICAgICAgIHNsaWNlcyA9IF9IMjY1UGFyc2VyJGV4dHJhY3ROQTJbMF07CiAgICAgICAgbGVmdCA9IF9IMjY1UGFyc2VyJGV4dHJhY3ROQTJbMV07CiAgICAgICAgdGhpcy5yZW1haW5pbmdEYXRhID0gbGVmdCB8fCBuZXcgVWludDhBcnJheSgpOwogICAgICAgIGlmIChzbGljZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgdGhpcy5yZW11eCh0aGlzLmdldFZpZGVvRnJhbWVzKHNsaWNlcywgZHVyYXRpb24sIGNvbXBvc2l0aW9uVGltZU9mZnNldCkpOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGVycm9yKCdGYWlsZWQgdG8gZXh0cmFjdCBhbnkgTkFMIHVuaXRzIGZyb20gdmlkZW8gZGF0YTonLCBsZWZ0KTsKICAgICAgICAgIHRoaXMuZGlzcGF0Y2goJ291dE9mRGF0YScpOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJnZXRWaWRlb0ZyYW1lcyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRWaWRlb0ZyYW1lcyhuYWx1cywgZHVyYXRpb24sIGNvbXBvc2l0aW9uVGltZU9mZnNldCkgewogICAgICAgIHZhciBfdGhpczIgPSB0aGlzOwogICAgICAgIHZhciB1bml0cyA9IFtdLAogICAgICAgICAgZnJhbWVzID0gW10sCiAgICAgICAgICBmZCA9IDAsCiAgICAgICAgICB0dCA9IDAsCiAgICAgICAgICBrZXlGcmFtZSA9IGZhbHNlLAogICAgICAgICAgdmNsID0gZmFsc2U7CiAgICAgICAgaWYgKHRoaXMucGVuZGluZ1VuaXRzLnVuaXRzKSB7CiAgICAgICAgICB1bml0cyA9IHRoaXMucGVuZGluZ1VuaXRzLnVuaXRzOwogICAgICAgICAgdmNsID0gdGhpcy5wZW5kaW5nVW5pdHMudmNsOwogICAgICAgICAga2V5RnJhbWUgPSB0aGlzLnBlbmRpbmdVbml0cy5rZXlGcmFtZTsKICAgICAgICAgIHRoaXMucGVuZGluZ1VuaXRzID0ge307CiAgICAgICAgfQogICAgICAgIHZhciBfaXRlcmF0b3IgPSBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlcihuYWx1cyksCiAgICAgICAgICBfc3RlcDsKICAgICAgICB0cnkgewogICAgICAgICAgZm9yIChfaXRlcmF0b3IucygpOyAhKF9zdGVwID0gX2l0ZXJhdG9yLm4oKSkuZG9uZTspIHsKICAgICAgICAgICAgdmFyIG5hbHUgPSBfc3RlcC52YWx1ZTsKICAgICAgICAgICAgdmFyIHVuaXQgPSBuZXcgTkFMVTI2NShuYWx1KTsKCiAgICAgICAgICAgIC8vIGZyYW1lIGJvdW5kYXJ5IGRldGVjdGlvbgogICAgICAgICAgICBpZiAodW5pdHMubGVuZ3RoICYmIHZjbCAmJiAodW5pdC5pc0ZpcnN0U2xpY2UgfHwgIXVuaXQuaXNWQ0wpKSB7CiAgICAgICAgICAgICAgZnJhbWVzLnB1c2goewogICAgICAgICAgICAgICAgdW5pdHM6IHVuaXRzLAogICAgICAgICAgICAgICAga2V5RnJhbWU6IGtleUZyYW1lCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgdW5pdHMgPSBbXTsKICAgICAgICAgICAgICBrZXlGcmFtZSA9IGZhbHNlOwogICAgICAgICAgICAgIHZjbCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVuaXRzLnB1c2godW5pdCk7CiAgICAgICAgICAgIGtleUZyYW1lID0ga2V5RnJhbWUgfHwgdW5pdC5pc0tleWZyYW1lOwogICAgICAgICAgICB2Y2wgPSB2Y2wgfHwgdW5pdC5pc1ZDTDsKICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIF9pdGVyYXRvci5lKGVycik7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIF9pdGVyYXRvci5mKCk7CiAgICAgICAgfQogICAgICAgIGlmICh1bml0cy5sZW5ndGgpIHsKICAgICAgICAgIGlmICghZHVyYXRpb24pIHsKICAgICAgICAgICAgdGhpcy5wZW5kaW5nVW5pdHMgPSB7CiAgICAgICAgICAgICAgdW5pdHM6IHVuaXRzLAogICAgICAgICAgICAgIGtleUZyYW1lOiBrZXlGcmFtZSwKICAgICAgICAgICAgICB2Y2w6IHZjbAogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIGlmICh2Y2wpIHsKICAgICAgICAgICAgZnJhbWVzLnB1c2goewogICAgICAgICAgICAgIHVuaXRzOiB1bml0cywKICAgICAgICAgICAgICBrZXlGcmFtZToga2V5RnJhbWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgbGFzdCA9IGZyYW1lcy5sZW5ndGggLSAxOwogICAgICAgICAgICBpZiAobGFzdCA+PSAwKSB7CiAgICAgICAgICAgICAgZnJhbWVzW2xhc3RdLnVuaXRzID0gZnJhbWVzW2xhc3RdLnVuaXRzLmNvbmNhdCh1bml0cyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZmQgPSBkdXJhdGlvbiA/IGR1cmF0aW9uIC8gZnJhbWVzLmxlbmd0aCB8IDAgOiB0aGlzLmZyYW1lRHVyYXRpb247CiAgICAgICAgdHQgPSBkdXJhdGlvbiA/IGR1cmF0aW9uIC0gZmQgKiBmcmFtZXMubGVuZ3RoIDogMDsKICAgICAgICBmcmFtZXMubWFwKGZ1bmN0aW9uIChmcmFtZSkgewogICAgICAgICAgZnJhbWUuZHVyYXRpb24gPSBmZDsKICAgICAgICAgIGZyYW1lLmNvbXBvc2l0aW9uVGltZU9mZnNldCA9IGNvbXBvc2l0aW9uVGltZU9mZnNldDsKICAgICAgICAgIGlmICh0dCA+IDApIHsKICAgICAgICAgICAgZnJhbWUuZHVyYXRpb24rKzsKICAgICAgICAgICAgdHQtLTsKICAgICAgICAgIH0KICAgICAgICAgIF90aGlzMi5rZkNvdW50ZXIrKzsKICAgICAgICAgIGlmIChmcmFtZS5rZXlGcmFtZSkgewogICAgICAgICAgICBfdGhpczIuZGlzcGF0Y2goJ2tleWZyYW1lUG9zaXRpb24nLCBfdGhpczIua2ZDb3VudGVyICogZmQgLyAxMDAwKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBsb2coImptdXhlcjogTm8uIG9mIEgyNjUgZnJhbWVzIG9mIHRoZSBsYXN0IGNodW5rOiAiLmNvbmNhdChmcmFtZXMubGVuZ3RoKSk7CiAgICAgICAgcmV0dXJuIGZyYW1lczsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZW11eCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW11eChmcmFtZXMpIHsKICAgICAgICB2YXIgX2l0ZXJhdG9yMiA9IF9jcmVhdGVGb3JPZkl0ZXJhdG9ySGVscGVyKGZyYW1lcyksCiAgICAgICAgICBfc3RlcDI7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGZvciAoX2l0ZXJhdG9yMi5zKCk7ICEoX3N0ZXAyID0gX2l0ZXJhdG9yMi5uKCkpLmRvbmU7KSB7CiAgICAgICAgICAgIHZhciBmcmFtZSA9IF9zdGVwMi52YWx1ZTsKICAgICAgICAgICAgdmFyIHVuaXRzID0gW107CiAgICAgICAgICAgIHZhciBzaXplID0gMDsKICAgICAgICAgICAgdmFyIF9pdGVyYXRvcjMgPSBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlcihmcmFtZS51bml0cyksCiAgICAgICAgICAgICAgX3N0ZXAzOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGZvciAoX2l0ZXJhdG9yMy5zKCk7ICEoX3N0ZXAzID0gX2l0ZXJhdG9yMy5uKCkpLmRvbmU7KSB7CiAgICAgICAgICAgICAgICB2YXIgdW5pdCA9IF9zdGVwMy52YWx1ZTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcnNlTkFMKHVuaXQpKSB7CiAgICAgICAgICAgICAgICAgIHVuaXRzLnB1c2godW5pdCk7CiAgICAgICAgICAgICAgICAgIHNpemUgKz0gdW5pdC5nZXRTaXplKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICBfaXRlcmF0b3IzLmUoZXJyKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBfaXRlcmF0b3IzLmYoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodW5pdHMubGVuZ3RoID4gMCAmJiB0aGlzLnJlYWR5VG9EZWNvZGUpIHsKICAgICAgICAgICAgICB0aGlzLm1wNHRyYWNrLmxlbiArPSBzaXplOwogICAgICAgICAgICAgIHRoaXMuc2FtcGxlcy5wdXNoKHsKICAgICAgICAgICAgICAgIHVuaXRzOiB1bml0cywKICAgICAgICAgICAgICAgIHNpemU6IHNpemUsCiAgICAgICAgICAgICAgICBrZXlGcmFtZTogZnJhbWUua2V5RnJhbWUsCiAgICAgICAgICAgICAgICBkdXJhdGlvbjogZnJhbWUuZHVyYXRpb24sCiAgICAgICAgICAgICAgICBjb21wb3NpdGlvblRpbWVPZmZzZXQ6IGZyYW1lLmNvbXBvc2l0aW9uVGltZU9mZnNldAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICBfaXRlcmF0b3IyLmUoZXJyKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgX2l0ZXJhdG9yMi5mKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldFBheWxvYWQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0UGF5bG9hZCgpIHsKICAgICAgICBpZiAoIXRoaXMuaXNSZWFkeSgpKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIHBheWxvYWQgPSBuZXcgVWludDhBcnJheSh0aGlzLm1wNHRyYWNrLmxlbik7CiAgICAgICAgdmFyIG9mZnNldCA9IDA7CiAgICAgICAgdmFyIHNhbXBsZXMgPSB0aGlzLm1wNHRyYWNrLnNhbXBsZXM7CiAgICAgICAgdmFyIG1wNFNhbXBsZSwgZHVyYXRpb247CiAgICAgICAgdGhpcy5kdHMgPSB0aGlzLm5leHREdHM7CiAgICAgICAgd2hpbGUgKHRoaXMuc2FtcGxlcy5sZW5ndGgpIHsKICAgICAgICAgIHZhciBzYW1wbGUgPSB0aGlzLnNhbXBsZXMuc2hpZnQoKSwKICAgICAgICAgICAgdW5pdHMgPSBzYW1wbGUudW5pdHM7CiAgICAgICAgICBkdXJhdGlvbiA9IHNhbXBsZS5kdXJhdGlvbjsKICAgICAgICAgIGlmIChkdXJhdGlvbiA8PSAwKSB7CiAgICAgICAgICAgIGxvZygicmVtdXhlcjogaW52YWxpZCBzYW1wbGUgZHVyYXRpb24gYXQgRFRTOiAiLmNvbmNhdCh0aGlzLm5leHREdHMsICIgOiIpLmNvbmNhdChkdXJhdGlvbikpOwogICAgICAgICAgICB0aGlzLm1wNHRyYWNrLmxlbiAtPSBzYW1wbGUuc2l6ZTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLm5leHREdHMgKz0gZHVyYXRpb247CiAgICAgICAgICBtcDRTYW1wbGUgPSB7CiAgICAgICAgICAgIHNpemU6IHNhbXBsZS5zaXplLAogICAgICAgICAgICBkdXJhdGlvbjogZHVyYXRpb24sCiAgICAgICAgICAgIGN0czogc2FtcGxlLmNvbXBvc2l0aW9uVGltZU9mZnNldCB8fCAwLAogICAgICAgICAgICBmbGFnczogewogICAgICAgICAgICAgIGlzTGVhZGluZzogMCwKICAgICAgICAgICAgICBpc0RlcGVuZGVkT246IDAsCiAgICAgICAgICAgICAgaGFzUmVkdW5kYW5jeTogMCwKICAgICAgICAgICAgICBkZWdyYWRQcmlvOiAwLAogICAgICAgICAgICAgIGlzTm9uU3luYzogc2FtcGxlLmtleUZyYW1lID8gMCA6IDEsCiAgICAgICAgICAgICAgZGVwZW5kc09uOiBzYW1wbGUua2V5RnJhbWUgPyAyIDogMQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIF9pdGVyYXRvcjQgPSBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlcih1bml0cyksCiAgICAgICAgICAgIF9zdGVwNDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGZvciAoX2l0ZXJhdG9yNC5zKCk7ICEoX3N0ZXA0ID0gX2l0ZXJhdG9yNC5uKCkpLmRvbmU7KSB7CiAgICAgICAgICAgICAgdmFyIHVuaXQgPSBfc3RlcDQudmFsdWU7CiAgICAgICAgICAgICAgcGF5bG9hZC5zZXQodW5pdC5nZXREYXRhKCksIG9mZnNldCk7CiAgICAgICAgICAgICAgb2Zmc2V0ICs9IHVuaXQuZ2V0U2l6ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgX2l0ZXJhdG9yNC5lKGVycik7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBfaXRlcmF0b3I0LmYoKTsKICAgICAgICAgIH0KICAgICAgICAgIHNhbXBsZXMucHVzaChtcDRTYW1wbGUpOwogICAgICAgIH0KICAgICAgICBpZiAoIXNhbXBsZXMubGVuZ3RoKSByZXR1cm4gbnVsbDsKICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkocGF5bG9hZC5idWZmZXIsIDAsIHRoaXMubXA0dHJhY2subGVuKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJwYXJzZVNQUyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBwYXJzZVNQUyhzcHMpIHsKICAgICAgICB0aGlzLm1wNHRyYWNrLnNwcyA9IFtuZXcgVWludDhBcnJheShzcHMpXTsKICAgICAgICBzcHMgPSBIMjY1UGFyc2VyLnJlbW92ZUVtdWxhdGlvblByZXZlbnRpb25CeXRlcyhzcHMpOwogICAgICAgIHZhciBjb25maWcgPSBIMjY1UGFyc2VyLnJlYWRTUFMobmV3IFVpbnQ4QXJyYXkoc3BzKSk7CiAgICAgICAgdGhpcy5tcDR0cmFjay5mcHMgPSBjb25maWcuZnBzIHx8IHRoaXMubXA0dHJhY2suZnBzOwogICAgICAgIHRoaXMubXA0dHJhY2sud2lkdGggPSBjb25maWcud2lkdGg7CiAgICAgICAgdGhpcy5tcDR0cmFjay5oZWlnaHQgPSBjb25maWcuaGVpZ2h0OwogICAgICAgIHRoaXMubXA0dHJhY2suY29kZWMgPSAiaHZjMS4iLmNvbmNhdChjb25maWcucHJvZmlsZV9pZGMsICIuIikuY29uY2F0KGNvbmZpZy5wcm9maWxlX2NvbXBhdGliaWxpdHlfZmxhZ3MudG9TdHJpbmcoMTYpKSArICIuTCIuY29uY2F0KGNvbmZpZy5sZXZlbF9pZGMpLmNvbmNhdChjb25maWcudGllcl9mbGFnID8gJ0gnIDogJ0wnKSArICIuIi5jb25jYXQoY29uZmlnLmNvbnN0cmFpbnRfaW5kaWNhdG9yX2ZsYWdzLm1hcChmdW5jdGlvbiAoYikgewogICAgICAgICAgcmV0dXJuIGIudG9TdHJpbmcoMTYpOwogICAgICAgIH0pLmpvaW4oJy4nKS50b1VwcGVyQ2FzZSgpKTsKICAgICAgICB0aGlzLm1wNHRyYWNrLmh2Y0MgPSB7CiAgICAgICAgICBwcm9maWxlX3NwYWNlOiBjb25maWcucHJvZmlsZV9zcGFjZSwKICAgICAgICAgIHRpZXJfZmxhZzogY29uZmlnLnRpZXJfZmxhZywKICAgICAgICAgIHByb2ZpbGVfaWRjOiBjb25maWcucHJvZmlsZV9pZGMsCiAgICAgICAgICBwcm9maWxlX2NvbXBhdGliaWxpdHlfZmxhZ3M6IGNvbmZpZy5wcm9maWxlX2NvbXBhdGliaWxpdHlfZmxhZ3MsCiAgICAgICAgICBjb25zdHJhaW50X2luZGljYXRvcl9mbGFnczogY29uZmlnLmNvbnN0cmFpbnRfaW5kaWNhdG9yX2ZsYWdzLAogICAgICAgICAgbGV2ZWxfaWRjOiBjb25maWcubGV2ZWxfaWRjLAogICAgICAgICAgY2hyb21hX2Zvcm1hdF9pZGM6IGNvbmZpZy5jaHJvbWFfZm9ybWF0X2lkYwogICAgICAgIH07CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicGFyc2VQUFMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcGFyc2VQUFMocHBzKSB7CiAgICAgICAgdGhpcy5tcDR0cmFjay5wcHMgPSBbcHBzXTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJwYXJzZVZQUyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBwYXJzZVZQUyh2cHMpIHsKICAgICAgICB0aGlzLm1wNHRyYWNrLnZwcyA9IFt2cHNdOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInBhcnNlTkFMIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHBhcnNlTkFMKHVuaXQpIHsKICAgICAgICBpZiAoIXVuaXQpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAodW5pdC5pc1ZDTCkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHZhciBwdXNoID0gZmFsc2U7CiAgICAgICAgc3dpdGNoICh1bml0LnR5cGUoKSkgewogICAgICAgICAgY2FzZSBOQUxVMjY1LlZQUzoKICAgICAgICAgICAgaWYgKCF0aGlzLm1wNHRyYWNrLnZwcykgewogICAgICAgICAgICAgIHRoaXMucGFyc2VWUFModW5pdC5nZXRQYXlsb2FkKCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHB1c2ggPSB0cnVlOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgTkFMVTI2NS5TUFM6CiAgICAgICAgICAgIGlmICghdGhpcy5tcDR0cmFjay5zcHMpIHsKICAgICAgICAgICAgICB0aGlzLnBhcnNlU1BTKHVuaXQuZ2V0UGF5bG9hZCgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwdXNoID0gdHJ1ZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIE5BTFUyNjUuUFBTOgogICAgICAgICAgICBpZiAoIXRoaXMubXA0dHJhY2sucHBzKSB7CiAgICAgICAgICAgICAgdGhpcy5wYXJzZVBQUyh1bml0LmdldFBheWxvYWQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHVzaCA9IHRydWU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBOQUxVMjY1LkFVRDoKICAgICAgICAgICAgbG9nKCdBVUQgLSBpZ25vaW5nJyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBOQUxVMjY1LlNFSToKICAgICAgICAgIGNhc2UgTkFMVTI2NS5TRUkyOgogICAgICAgICAgICBsb2coJ1NFSSAtIGlnbm9pbmcnKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5yZWFkeVRvRGVjb2RlICYmIHRoaXMubXA0dHJhY2sudnBzICYmIHRoaXMubXA0dHJhY2suc3BzICYmIHRoaXMubXA0dHJhY2sucHBzKSB7CiAgICAgICAgICB0aGlzLnJlYWR5VG9EZWNvZGUgPSB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcHVzaDsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEgyNjVSZW11eGVyOwogIH0oQmFzZVJlbXV4ZXIpOwoKICB2YXIgUmVtdXhDb250cm9sbGVyID0gLyojX19QVVJFX18qL2Z1bmN0aW9uIChfRXZlbnQpIHsKICAgIF9pbmhlcml0cyhSZW11eENvbnRyb2xsZXIsIF9FdmVudCk7CiAgICB2YXIgX3N1cGVyID0gX2NyZWF0ZVN1cGVyKFJlbXV4Q29udHJvbGxlcik7CiAgICBmdW5jdGlvbiBSZW11eENvbnRyb2xsZXIoZW52LCBsaXZlLCB2aWRlb0NvZGVjLCBmcmFtZUR1cmF0aW9uKSB7CiAgICAgIHZhciBfdGhpczsKICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFJlbXV4Q29udHJvbGxlcik7CiAgICAgIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcywgJ3JlbXV4ZXInKTsKICAgICAgX3RoaXMudmlkZW9Db2RlYyA9IHZpZGVvQ29kZWM7CiAgICAgIF90aGlzLmZyYW1lRHVyYXRpb24gPSBmcmFtZUR1cmF0aW9uOwogICAgICBfdGhpcy5pbml0aWFsaXplZCA9IGZhbHNlOwogICAgICBfdGhpcy50cmFja3MgPSB7fTsKICAgICAgX3RoaXMuc2VxID0gMTsKICAgICAgX3RoaXMuZW52ID0gZW52OwogICAgICBfdGhpcy50aW1lc2NhbGUgPSAxMDAwOwogICAgICBfdGhpcy5tZWRpYUR1cmF0aW9uID0gbGl2ZSA/IDB4ZmZmZmZmZmYgOiAwOwogICAgICByZXR1cm4gX3RoaXM7CiAgICB9CiAgICBfY3JlYXRlQ2xhc3MoUmVtdXhDb250cm9sbGVyLCBbewogICAgICBrZXk6ICJhZGRUcmFjayIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBhZGRUcmFjayh0eXBlKSB7CiAgICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CiAgICAgICAgaWYgKHR5cGUgPT09ICd2aWRlbycgfHwgdHlwZSA9PT0gJ2JvdGgnKSB7CiAgICAgICAgICBpZiAodGhpcy52aWRlb0NvZGVjID09ICdIMjY1JykgewogICAgICAgICAgICB0aGlzLnRyYWNrcy52aWRlbyA9IG5ldyBIMjY1UmVtdXhlcih0aGlzLnRpbWVzY2FsZSwgdGhpcy5tZWRpYUR1cmF0aW9uLCB0aGlzLmZyYW1lRHVyYXRpb24pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy50cmFja3MudmlkZW8gPSBuZXcgSDI2NFJlbXV4ZXIodGhpcy50aW1lc2NhbGUsIHRoaXMubWVkaWFEdXJhdGlvbiwgdGhpcy5mcmFtZUR1cmF0aW9uKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMudHJhY2tzLnZpZGVvLm9uKCdvdXRPZkRhdGEnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIF90aGlzMi5kaXNwYXRjaCgnbWlzc2luZ1ZpZGVvRnJhbWVzJyk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHRoaXMudHJhY2tzLnZpZGVvLm9uKCdrZXlmcmFtZVBvc2l0aW9uJywgZnVuY3Rpb24gKHRpbWUpIHsKICAgICAgICAgICAgX3RoaXMyLmRpc3BhdGNoKCdrZXlmcmFtZVBvc2l0aW9uJywgdGltZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGUgPT09ICdhdWRpbycgfHwgdHlwZSA9PT0gJ2JvdGgnKSB7CiAgICAgICAgICB2YXIgYWFjUmVtdXhlciA9IG5ldyBBQUNSZW11eGVyKHRoaXMudGltZXNjYWxlLCB0aGlzLm1lZGlhRHVyYXRpb24sIHRoaXMuZnJhbWVEdXJhdGlvbik7CiAgICAgICAgICB0aGlzLnRyYWNrcy5hdWRpbyA9IGFhY1JlbXV4ZXI7CiAgICAgICAgICB0aGlzLnRyYWNrcy52aWRlby5vbignb3V0T2ZEYXRhJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBfdGhpczIuZGlzcGF0Y2goJ21pc3NpbmdBdWRpb0ZyYW1lcycpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlc2V0IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlc2V0KCkgewogICAgICAgIGZvciAodmFyIHR5cGUgaW4gdGhpcy50cmFja3MpIHsKICAgICAgICAgIHRoaXMudHJhY2tzW3R5cGVdLnJlc2V0VHJhY2soKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5pbml0aWFsaXplZCA9IGZhbHNlOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImRlc3Ryb3kiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgICB0aGlzLnRyYWNrcyA9IHt9OwogICAgICAgIHRoaXMub2ZmQWxsKCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZmx1c2giLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZmx1c2goKSB7CiAgICAgICAgaWYgKCF0aGlzLmluaXRpYWxpemVkKSB7CiAgICAgICAgICBpZiAoIXRoaXMuaXNSZWFkeSgpKSByZXR1cm47CiAgICAgICAgICB0aGlzLmRpc3BhdGNoKCdyZWFkeScpOwogICAgICAgICAgdGhpcy5pbml0U2VnbWVudCgpOwogICAgICAgICAgdGhpcy5pbml0aWFsaXplZCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIHR5cGUgaW4gdGhpcy50cmFja3MpIHsKICAgICAgICAgIHZhciB0cmFjayA9IHRoaXMudHJhY2tzW3R5cGVdOwogICAgICAgICAgdmFyIHBheSA9IHRyYWNrLmdldFBheWxvYWQoKTsKICAgICAgICAgIGlmIChwYXkgJiYgcGF5LmJ5dGVMZW5ndGgpIHsKICAgICAgICAgICAgdmFyIG1vb2YgPSBNUDQubW9vZih0aGlzLnNlcSwgdHJhY2suZHRzLCB0cmFjay5tcDR0cmFjayk7CiAgICAgICAgICAgIHZhciBtZGF0ID0gTVA0Lm1kYXQocGF5KTsKICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBhcHBlbmRCeXRlQXJyYXkobW9vZiwgbWRhdCk7CiAgICAgICAgICAgIHZhciBkYXRhID0gewogICAgICAgICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgICAgICAgcGF5bG9hZDogcGF5bG9hZCwKICAgICAgICAgICAgICBkdHM6IHRyYWNrLmR0cwogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3ZpZGVvJykgewogICAgICAgICAgICAgIGRhdGEuZnBzID0gdHJhY2subXA0dHJhY2suZnBzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2goJ2J1ZmZlcicsIGRhdGEpOwogICAgICAgICAgICB2YXIgZHVyYXRpb24gPSBzZWNUb1RpbWUodHJhY2suZHRzIC8gdGhpcy50aW1lc2NhbGUpOwogICAgICAgICAgICBsb2coInB1dCBzZWdtZW50ICgiLmNvbmNhdCh0eXBlLCAiKTogZHRzOiAiKS5jb25jYXQodHJhY2suZHRzLCAiIGZyYW1lczogIikuY29uY2F0KHRyYWNrLm1wNHRyYWNrLnNhbXBsZXMubGVuZ3RoLCAiIHNlY29uZDogIikuY29uY2F0KGR1cmF0aW9uKSk7CiAgICAgICAgICAgIHRyYWNrLmZsdXNoKCk7CiAgICAgICAgICAgIHRoaXMuc2VxKys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImluaXRTZWdtZW50IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGluaXRTZWdtZW50KCkgewogICAgICAgIHZhciB0cmFja3MgPSBbXTsKICAgICAgICBmb3IgKHZhciB0eXBlIGluIHRoaXMudHJhY2tzKSB7CiAgICAgICAgICB2YXIgdHJhY2sgPSB0aGlzLnRyYWNrc1t0eXBlXTsKICAgICAgICAgIGlmICh0aGlzLmVudiA9PSAnYnJvd3NlcicpIHsKICAgICAgICAgICAgdmFyIGRhdGEgPSB7CiAgICAgICAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICAgICAgICBwYXlsb2FkOiBNUDQuaW5pdFNlZ21lbnQoW3RyYWNrLm1wNHRyYWNrXSwgdGhpcy5tZWRpYUR1cmF0aW9uLCB0aGlzLnRpbWVzY2FsZSkKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5kaXNwYXRjaCgnYnVmZmVyJywgZGF0YSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0cmFja3MucHVzaCh0cmFjay5tcDR0cmFjayk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLmVudiA9PSAnbm9kZScpIHsKICAgICAgICAgIHZhciBfZGF0YSA9IHsKICAgICAgICAgICAgdHlwZTogJ2FsbCcsCiAgICAgICAgICAgIHBheWxvYWQ6IE1QNC5pbml0U2VnbWVudCh0cmFja3MsIHRoaXMubWVkaWFEdXJhdGlvbiwgdGhpcy50aW1lc2NhbGUpCiAgICAgICAgICB9OwogICAgICAgICAgdGhpcy5kaXNwYXRjaCgnYnVmZmVyJywgX2RhdGEpOwogICAgICAgIH0KICAgICAgICBsb2coJ0luaXRpYWwgc2VnbWVudCBnZW5lcmF0ZWQuJyk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiaXNSZWFkeSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBpc1JlYWR5KCkgewogICAgICAgIGZvciAodmFyIHR5cGUgaW4gdGhpcy50cmFja3MpIHsKICAgICAgICAgIGlmICghdGhpcy50cmFja3NbdHlwZV0ucmVhZHlUb0RlY29kZSB8fCAhdGhpcy50cmFja3NbdHlwZV0uc2FtcGxlcy5sZW5ndGgpIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZmVlZCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBmZWVkKGRhdGEpIHsKICAgICAgICB2YXIgcmVtdXggPSBmYWxzZTsKICAgICAgICBpZiAoZGF0YS52aWRlbyAmJiB0aGlzLnRyYWNrcy52aWRlbykgewogICAgICAgICAgcmVtdXggfD0gdGhpcy50cmFja3MudmlkZW8uZmVlZChkYXRhLnZpZGVvLCBkYXRhLmR1cmF0aW9uLCBkYXRhLmNvbXBvc2l0aW9uVGltZU9mZnNldCk7CiAgICAgICAgfQogICAgICAgIGlmIChkYXRhLmF1ZGlvICYmIHRoaXMudHJhY2tzLmF1ZGlvKSB7CiAgICAgICAgICByZW11eCB8PSB0aGlzLnRyYWNrcy5hdWRpby5mZWVkKGRhdGEuYXVkaW8sIGRhdGEuZHVyYXRpb24pOwogICAgICAgIH0KICAgICAgICBpZiAoIXJlbXV4KSB7CiAgICAgICAgICBlcnJvcignSW5wdXQgb2JqZWN0IG11c3QgaGF2ZSB2aWRlbyBhbmQvb3IgYXVkaW8gcHJvcGVydHkuIE1ha2Ugc3VyZSBpdCBpcyBhIHZhbGlkIHR5cGVkIGFycmF5Jyk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRoaXMuZmx1c2goKTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIFJlbXV4Q29udHJvbGxlcjsKICB9KEV2ZW50KTsKCiAgdmFyIEJ1ZmZlckNvbnRyb2xsZXIgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKF9FdmVudCkgewogICAgX2luaGVyaXRzKEJ1ZmZlckNvbnRyb2xsZXIsIF9FdmVudCk7CiAgICB2YXIgX3N1cGVyID0gX2NyZWF0ZVN1cGVyKEJ1ZmZlckNvbnRyb2xsZXIpOwogICAgZnVuY3Rpb24gQnVmZmVyQ29udHJvbGxlcihzb3VyY2VCdWZmZXIsIHR5cGUpIHsKICAgICAgdmFyIF90aGlzOwogICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgQnVmZmVyQ29udHJvbGxlcik7CiAgICAgIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcywgJ2J1ZmZlcicpOwogICAgICBfdGhpcy50eXBlID0gdHlwZTsKICAgICAgX3RoaXMucXVldWUgPSBuZXcgVWludDhBcnJheSgpOwogICAgICBfdGhpcy5jbGVhbmluZyA9IGZhbHNlOwogICAgICBfdGhpcy5wZW5kaW5nQ2xlYW5pbmcgPSAwOwogICAgICBfdGhpcy5jbGVhbk9mZnNldCA9IDMwOwogICAgICBfdGhpcy5jbGVhblJhbmdlcyA9IFtdOwogICAgICBfdGhpcy5zb3VyY2VCdWZmZXIgPSBzb3VyY2VCdWZmZXI7CiAgICAgIF90aGlzLnNvdXJjZUJ1ZmZlci5hZGRFdmVudExpc3RlbmVyKCd1cGRhdGVlbmQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKF90aGlzLnBlbmRpbmdDbGVhbmluZyA+IDApIHsKICAgICAgICAgIF90aGlzLmluaXRDbGVhbnVwKF90aGlzLnBlbmRpbmdDbGVhbmluZyk7CiAgICAgICAgICBfdGhpcy5wZW5kaW5nQ2xlYW5pbmcgPSAwOwogICAgICAgIH0KICAgICAgICBfdGhpcy5jbGVhbmluZyA9IGZhbHNlOwogICAgICAgIGlmIChfdGhpcy5jbGVhblJhbmdlcy5sZW5ndGgpIHsKICAgICAgICAgIF90aGlzLmRvQ2xlYW51cCgpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIF90aGlzLnNvdXJjZUJ1ZmZlci5hZGRFdmVudExpc3RlbmVyKCdlcnJvcicsIGZ1bmN0aW9uICgpIHsKICAgICAgICBfdGhpcy5kaXNwYXRjaCgnZXJyb3InLCB7CiAgICAgICAgICB0eXBlOiBfdGhpcy50eXBlLAogICAgICAgICAgbmFtZTogJ2J1ZmZlcicsCiAgICAgICAgICBlcnJvcjogJ2J1ZmZlciBlcnJvcicKICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgIHJldHVybiBfdGhpczsKICAgIH0KICAgIF9jcmVhdGVDbGFzcyhCdWZmZXJDb250cm9sbGVyLCBbewogICAgICBrZXk6ICJkZXN0cm95IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgICAgdGhpcy5xdWV1ZSA9IG51bGw7CiAgICAgICAgdGhpcy5zb3VyY2VCdWZmZXIgPSBudWxsOwogICAgICAgIHRoaXMub2ZmQWxsKCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZG9DbGVhbnVwIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGRvQ2xlYW51cCgpIHsKICAgICAgICBpZiAoIXRoaXMuY2xlYW5SYW5nZXMubGVuZ3RoKSB7CiAgICAgICAgICB0aGlzLmNsZWFuaW5nID0gZmFsc2U7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciByYW5nZSA9IHRoaXMuY2xlYW5SYW5nZXMuc2hpZnQoKTsKICAgICAgICBsb2coIiIuY29uY2F0KHRoaXMudHlwZSwgIiByZW1vdmUgcmFuZ2UgWyIpLmNvbmNhdChyYW5nZVswXSwgIiAtICIpLmNvbmNhdChyYW5nZVsxXSwgIikiKSk7CiAgICAgICAgdGhpcy5jbGVhbmluZyA9IHRydWU7CiAgICAgICAgdGhpcy5zb3VyY2VCdWZmZXIucmVtb3ZlKHJhbmdlWzBdLCByYW5nZVsxXSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiaW5pdENsZWFudXAiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gaW5pdENsZWFudXAoY2xlYW5NYXhMaW1pdCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBpZiAodGhpcy5zb3VyY2VCdWZmZXIudXBkYXRpbmcpIHsKICAgICAgICAgICAgdGhpcy5wZW5kaW5nQ2xlYW5pbmcgPSBjbGVhbk1heExpbWl0OwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy5zb3VyY2VCdWZmZXIuYnVmZmVyZWQgJiYgdGhpcy5zb3VyY2VCdWZmZXIuYnVmZmVyZWQubGVuZ3RoICYmICF0aGlzLmNsZWFuaW5nKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5zb3VyY2VCdWZmZXIuYnVmZmVyZWQubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLnNvdXJjZUJ1ZmZlci5idWZmZXJlZC5zdGFydChpKTsKICAgICAgICAgICAgICB2YXIgZW5kID0gdGhpcy5zb3VyY2VCdWZmZXIuYnVmZmVyZWQuZW5kKGkpOwogICAgICAgICAgICAgIGlmIChjbGVhbk1heExpbWl0IC0gc3RhcnQgPiB0aGlzLmNsZWFuT2Zmc2V0KSB7CiAgICAgICAgICAgICAgICBlbmQgPSBjbGVhbk1heExpbWl0IC0gdGhpcy5jbGVhbk9mZnNldDsKICAgICAgICAgICAgICAgIGlmIChzdGFydCA8IGVuZCkgewogICAgICAgICAgICAgICAgICB0aGlzLmNsZWFuUmFuZ2VzLnB1c2goW3N0YXJ0LCBlbmRdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5kb0NsZWFudXAoKTsKICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBlcnJvcigiRXJyb3Igb2NjdXJlZCB3aGlsZSBjbGVhbmluZyAiLmNvbmNhdCh0aGlzLnR5cGUsICIgYnVmZmVyIC0gIikuY29uY2F0KGUubmFtZSwgIjogIikuY29uY2F0KGUubWVzc2FnZSkpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJkb0FwcGVuZCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBkb0FwcGVuZCgpIHsKICAgICAgICBpZiAoIXRoaXMucXVldWUubGVuZ3RoKSByZXR1cm47CiAgICAgICAgaWYgKCF0aGlzLnNvdXJjZUJ1ZmZlciB8fCB0aGlzLnNvdXJjZUJ1ZmZlci51cGRhdGluZykgcmV0dXJuOwogICAgICAgIHRyeSB7CiAgICAgICAgICB0aGlzLnNvdXJjZUJ1ZmZlci5hcHBlbmRCdWZmZXIodGhpcy5xdWV1ZSk7CiAgICAgICAgICB0aGlzLnF1ZXVlID0gbmV3IFVpbnQ4QXJyYXkoKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICB2YXIgbmFtZSA9ICd1bmV4cGVjdGVkRXJyb3InOwogICAgICAgICAgaWYgKGUubmFtZSA9PT0gJ1F1b3RhRXhjZWVkZWRFcnJvcicpIHsKICAgICAgICAgICAgbG9nKCIiLmNvbmNhdCh0aGlzLnR5cGUsICIgYnVmZmVyIHF1b3RhIGZ1bGwiKSk7CiAgICAgICAgICAgIG5hbWUgPSAnUXVvdGFFeGNlZWRlZCc7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBlcnJvcigiRXJyb3Igb2NjdXJlZCB3aGlsZSBhcHBlbmRpbmcgIi5jb25jYXQodGhpcy50eXBlLCAiIGJ1ZmZlciAtICIpLmNvbmNhdChlLm5hbWUsICI6ICIpLmNvbmNhdChlLm1lc3NhZ2UpKTsKICAgICAgICAgICAgbmFtZSA9ICdJbnZhbGlkU3RhdGVFcnJvcic7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmRpc3BhdGNoKCdlcnJvcicsIHsKICAgICAgICAgICAgdHlwZTogdGhpcy50eXBlLAogICAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgICBlcnJvcjogJ2J1ZmZlciBlcnJvcicKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJmZWVkIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGZlZWQoZGF0YSkgewogICAgICAgIHRoaXMucXVldWUgPSBhcHBlbmRCeXRlQXJyYXkodGhpcy5xdWV1ZSwgZGF0YSk7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBCdWZmZXJDb250cm9sbGVyOwogIH0oRXZlbnQpOwoKICB2YXIgSk11eGVyID0gLyojX19QVVJFX18qL2Z1bmN0aW9uIChfRXZlbnQpIHsKICAgIF9pbmhlcml0cyhKTXV4ZXIsIF9FdmVudCk7CiAgICB2YXIgX3N1cGVyID0gX2NyZWF0ZVN1cGVyKEpNdXhlcik7CiAgICBmdW5jdGlvbiBKTXV4ZXIob3B0aW9ucykgewogICAgICB2YXIgX3RoaXM7CiAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBKTXV4ZXIpOwogICAgICBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMsICdqbXV4ZXInKTsKICAgICAgX3RoaXMuaXNSZXNldCA9IGZhbHNlOwogICAgICB2YXIgZGVmYXVsdHMgPSB7CiAgICAgICAgbm9kZTogJycsCiAgICAgICAgbW9kZTogJ2JvdGgnLAogICAgICAgIC8vIGJvdGgsIGF1ZGlvLCB2aWRlbwogICAgICAgIHZpZGVvQ29kZWM6ICdIMjY0JywKICAgICAgICAvLyBIMjY0LCBIMjY1CiAgICAgICAgZmx1c2hpbmdUaW1lOiA1MDAsCiAgICAgICAgbWF4RGVsYXk6IDUwMCwKICAgICAgICBjbGVhckJ1ZmZlcjogdHJ1ZSwKICAgICAgICBmcHM6IDMwLAogICAgICAgIHJlYWRGcHNGcm9tVHJhY2s6IGZhbHNlLAogICAgICAgIC8vIHNldCB0cnVlIHRvIGZldGNoIGZwcyB2YWx1ZSBmcm9tIE5BTHUKICAgICAgICBkZWJ1ZzogZmFsc2UsCiAgICAgICAgb25SZWFkeTogZnVuY3Rpb24gb25SZWFkeSgpIHt9LAogICAgICAgIC8vIGZ1bmN0aW9uIGNhbGxlZCB3aGVuIE1TRSBpcyByZWFkeSB0byBhY2NlcHQgZnJhbWVzCiAgICAgICAgb25EYXRhOiBmdW5jdGlvbiBvbkRhdGEoKSB7fSwKICAgICAgICAvLyBmdW5jdGlvbiBjYWxsZWQgd2hlbiBkYXRhIGlzIHJlYWR5IHRvIGJlIHNlbnQKICAgICAgICBvbkVycm9yOiBmdW5jdGlvbiBvbkVycm9yKCkge30sCiAgICAgICAgLy8gZnVuY3Rpb24gY2FsbGVkIHdoZW4gam11eGVyIGVuY291bnRlcnMgYW55IGJ1ZmZlciByZWxhdGVkIGVycm9ycwogICAgICAgIG9uVW5zdXBwb3J0ZWRDb2RlYzogZnVuY3Rpb24gb25VbnN1cHBvcnRlZENvZGVjKCkge30sCiAgICAgICAgLy8gZnVuY3Rpb24gY2FsbGVkIHdoZW4gYSBjb2RlYyBpcyBub3Qgc3VwcG9ydGVkIGJ5IHRoZSBicm93c2VyCiAgICAgICAgb25NaXNzaW5nVmlkZW9GcmFtZXM6IGZ1bmN0aW9uIG9uTWlzc2luZ1ZpZGVvRnJhbWVzKCkge30sCiAgICAgICAgLy8gZnVuY3Rpb24gY2FsbGVkIHdoZW4gam11eGVyIGVuY291bnRlcnMgYW55IG1pc3NpbmcgdmlkZW8gZnJhbWVzCiAgICAgICAgb25NaXNzaW5nQXVkaW9GcmFtZXM6IGZ1bmN0aW9uIG9uTWlzc2luZ0F1ZGlvRnJhbWVzKCkge30sCiAgICAgICAgLy8gZnVuY3Rpb24gY2FsbGVkIHdoZW4gam11eGVyIGVuY291bnRlcnMgYW55IG1pc3NpbmcgYXVkaW8gZnJhbWVzCiAgICAgICAgb25LZXlmcmFtZVBvc2l0aW9uOiBmdW5jdGlvbiBvbktleWZyYW1lUG9zaXRpb24oKSB7fSwKICAgICAgICAvLyBmdW5jdGlvbiBjYWxsZWQgd2hlbiBhIGtleWZyYW1lIGlzIGRldGVjdGVkIHRodXMgdGhlIHByb3ZpZGVkIHRpbWUgaXMgc2Vla2FibGUKICAgICAgICBvbkxvZ2dlckxvZzogY29uc29sZS5sb2csCiAgICAgICAgb25Mb2dnZXJFcnI6IGNvbnNvbGUuZXJyb3IKICAgICAgfTsKICAgICAgX3RoaXMub3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIGRlZmF1bHRzLCBvcHRpb25zKTsKICAgICAgX3RoaXMuZW52ID0gKHR5cGVvZiBwcm9jZXNzID09PSAidW5kZWZpbmVkIiA/ICJ1bmRlZmluZWQiIDogX3R5cGVvZihwcm9jZXNzKSkgPT09ICdvYmplY3QnICYmIHR5cGVvZiB3aW5kb3cgPT09ICd1bmRlZmluZWQnID8gJ25vZGUnIDogJ2Jyb3dzZXInOwogICAgICBpZiAoX3RoaXMub3B0aW9ucy5kZWJ1ZykgewogICAgICAgIHNldExvZ2dlcihfdGhpcy5vcHRpb25zLm9uTG9nZ2VyTG9nLCBfdGhpcy5vcHRpb25zLm9uTG9nZ2VyRXJyKTsKICAgICAgfQogICAgICBpZiAoIV90aGlzLm9wdGlvbnMuZnBzKSB7CiAgICAgICAgX3RoaXMub3B0aW9ucy5mcHMgPSAzMDsKICAgICAgfQogICAgICBfdGhpcy5mcmFtZUR1cmF0aW9uID0gMTAwMCAvIF90aGlzLm9wdGlvbnMuZnBzIHwgMDsKICAgICAgX3RoaXMucmVtdXhDb250cm9sbGVyID0gbmV3IFJlbXV4Q29udHJvbGxlcihfdGhpcy5lbnYsIG9wdGlvbnMubGl2ZSwgX3RoaXMub3B0aW9ucy52aWRlb0NvZGVjLCBfdGhpcy5mcmFtZUR1cmF0aW9uKTsKICAgICAgX3RoaXMucmVtdXhDb250cm9sbGVyLmFkZFRyYWNrKF90aGlzLm9wdGlvbnMubW9kZSk7CiAgICAgIF90aGlzLmluaXREYXRhKCk7CgogICAgICAvKiBldmVudHMgY2FsbGJhY2sgKi8KICAgICAgX3RoaXMucmVtdXhDb250cm9sbGVyLm9uKCdidWZmZXInLCBfdGhpcy5vbkJ1ZmZlci5iaW5kKF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpKSk7CiAgICAgIGlmIChfdGhpcy5lbnYgPT0gJ2Jyb3dzZXInKSB7CiAgICAgICAgX3RoaXMucmVtdXhDb250cm9sbGVyLm9uKCdyZWFkeScsIF90aGlzLmNyZWF0ZUJ1ZmZlci5iaW5kKF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpKSk7CiAgICAgICAgX3RoaXMuaW5pdEJyb3dzZXIoKTsKICAgICAgfQogICAgICBfdGhpcy5yZW11eENvbnRyb2xsZXIub24oJ21pc3NpbmdWaWRlb0ZyYW1lcycsIGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAodHlwZW9mIF90aGlzLm9wdGlvbnMub25NaXNzaW5nVmlkZW9GcmFtZXMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIF90aGlzLm9wdGlvbnMub25NaXNzaW5nVmlkZW9GcmFtZXMuY2FsbChudWxsKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBfdGhpcy5yZW11eENvbnRyb2xsZXIub24oJ21pc3NpbmdBdWRpb0ZyYW1lcycsIGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAodHlwZW9mIF90aGlzLm9wdGlvbnMub25NaXNzaW5nQXVkaW9GcmFtZXMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIF90aGlzLm9wdGlvbnMub25NaXNzaW5nQXVkaW9GcmFtZXMuY2FsbChudWxsKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBpZiAoX3RoaXMuY2xlYXJCdWZmZXIpIHsKICAgICAgICAvLyB0aGlzIGlzIHVzZWQgdG8ga25vdyB3aGVuIGtleWZyYW1lcyBhcmUsCiAgICAgICAgLy8gdG8gZXNzZW50aWFsbHkga25vdyB3aGljaCBzcGVjaWZpYyB0aW1lcyBhcmUgc2Vla2FibGUKICAgICAgICBfdGhpcy5yZW11eENvbnRyb2xsZXIub24oJ2tleWZyYW1lUG9zaXRpb24nLCBmdW5jdGlvbiAodGltZSkgewogICAgICAgICAgX3RoaXMua2ZQb3NpdGlvbi5wdXNoKHRpbWUpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgX3RoaXMub3B0aW9ucy5vbktleWZyYW1lUG9zaXRpb24gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBfdGhpcy5yZW11eENvbnRyb2xsZXIub24oJ2tleWZyYW1lUG9zaXRpb24nLCBmdW5jdGlvbiAodGltZSkgewogICAgICAgICAgX3RoaXMub3B0aW9ucy5vbktleWZyYW1lUG9zaXRpb24uY2FsbChudWxsLCB0aW1lKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gX3RoaXM7CiAgICB9CiAgICBfY3JlYXRlQ2xhc3MoSk11eGVyLCBbewogICAgICBrZXk6ICJpbml0RGF0YSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBpbml0RGF0YSgpIHsKICAgICAgICB0aGlzLmxhc3RDbGVhbmluZ1RpbWUgPSBEYXRlLm5vdygpOwogICAgICAgIHRoaXMua2ZQb3NpdGlvbiA9IFtdOwogICAgICAgIHRoaXMucGVuZGluZ1VuaXRzID0ge307CiAgICAgICAgdGhpcy5yZW1haW5pbmdEYXRhID0gbmV3IFVpbnQ4QXJyYXkoKTsKICAgICAgICB0aGlzLnN0YXJ0SW50ZXJ2YWwoKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJpbml0QnJvd3NlciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBpbml0QnJvd3NlcigpIHsKICAgICAgICBpZiAodHlwZW9mIHRoaXMub3B0aW9ucy5ub2RlID09PSAnc3RyaW5nJyAmJiB0aGlzLm9wdGlvbnMubm9kZSA9PSAnJykgewogICAgICAgICAgZXJyb3IoJ25vIHZpZGVvIGVsZW1lbnQgd2VyZSBmb3VuZCB0byByZW5kZXIsIHByb3ZpZGUgYSB2YWxpZCB2aWRlbyBlbGVtZW50Jyk7CiAgICAgICAgfQogICAgICAgIHRoaXMubm9kZSA9IHR5cGVvZiB0aGlzLm9wdGlvbnMubm9kZSA9PT0gJ3N0cmluZycgPyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0aGlzLm9wdGlvbnMubm9kZSkgOiB0aGlzLm9wdGlvbnMubm9kZTsKICAgICAgICB0aGlzLm1zZVJlYWR5ID0gZmFsc2U7CiAgICAgICAgdGhpcy5zZXR1cE1TRSgpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImNyZWF0ZVN0cmVhbSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGVTdHJlYW0oKSB7CiAgICAgICAgdmFyIGZlZWQgPSB0aGlzLmZlZWQuYmluZCh0aGlzKTsKICAgICAgICB2YXIgZGVzdHJveSA9IHRoaXMuZGVzdHJveS5iaW5kKHRoaXMpOwogICAgICAgIHRoaXMuc3RyZWFtID0gbmV3IHN0cmVhbS5EdXBsZXgoewogICAgICAgICAgd3JpdGFibGVPYmplY3RNb2RlOiB0cnVlLAogICAgICAgICAgcmVhZDogZnVuY3Rpb24gcmVhZChzaXplKSB7fSwKICAgICAgICAgIHdyaXRlOiBmdW5jdGlvbiB3cml0ZShkYXRhLCBlbmNvZGluZywgY2FsbGJhY2spIHsKICAgICAgICAgICAgZmVlZChkYXRhKTsKICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgIH0sCiAgICAgICAgICAiZmluYWwiOiBmdW5jdGlvbiBmaW5hbChjYWxsYmFjaykgewogICAgICAgICAgICBkZXN0cm95KCk7CiAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHRoaXMuc3RyZWFtOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInNldHVwTVNFIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNldHVwTVNFKCkgewogICAgICAgIHdpbmRvdy5NZWRpYVNvdXJjZSA9IHdpbmRvdy5NZWRpYVNvdXJjZSB8fCB3aW5kb3cuV2ViS2l0TWVkaWFTb3VyY2UgfHwgd2luZG93Lk1hbmFnZWRNZWRpYVNvdXJjZTsKICAgICAgICBpZiAoIXdpbmRvdy5NZWRpYVNvdXJjZSkgewogICAgICAgICAgdGhyb3cgJ09vcHMhIEJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBNZWRpYSBTb3VyY2UgRXh0ZW5zaW9uIG9yIE1hbmFnZWQgTWVkaWEgU291cmNlIChJT1MgMTcrKS4nOwogICAgICAgIH0KICAgICAgICB0aGlzLmlzTVNFU3VwcG9ydGVkID0gISF3aW5kb3cuTWVkaWFTb3VyY2U7CiAgICAgICAgdGhpcy5tZWRpYVNvdXJjZSA9IG5ldyB3aW5kb3cuTWVkaWFTb3VyY2UoKTsKICAgICAgICB0aGlzLnVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwodGhpcy5tZWRpYVNvdXJjZSk7CiAgICAgICAgaWYgKHdpbmRvdy5NZWRpYVNvdXJjZSA9PT0gd2luZG93Lk1hbmFnZWRNZWRpYVNvdXJjZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdGhpcy5ub2RlLnJlbW92ZUF0dHJpYnV0ZSgnc3JjJyk7CiAgICAgICAgICAgIC8vIE1hbmFnZWRNZWRpYVNvdXJjZSB3aWxsIG5vdCBvcGVuIHdpdGhvdXQgZGlzYWJsZVJlbW90ZVBsYXliYWNrIHNldCB0byBmYWxzZSBvciBzb3VyY2UgYWx0ZXJuYXRpdmVzCiAgICAgICAgICAgIHRoaXMubm9kZS5kaXNhYmxlUmVtb3RlUGxheWJhY2sgPSB0cnVlOwogICAgICAgICAgICB2YXIgc291cmNlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc291cmNlJyk7CiAgICAgICAgICAgIHNvdXJjZS50eXBlID0gJ3ZpZGVvL21wNCc7CiAgICAgICAgICAgIHNvdXJjZS5zcmMgPSB0aGlzLnVybDsKICAgICAgICAgICAgdGhpcy5ub2RlLmFwcGVuZENoaWxkKHNvdXJjZSk7CiAgICAgICAgICAgIHRoaXMubm9kZS5sb2FkKCk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICB0aGlzLm5vZGUuc3JjID0gdGhpcy51cmw7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMubm9kZS5zcmMgPSB0aGlzLnVybDsKICAgICAgICB9CiAgICAgICAgdGhpcy5tc2VFbmRlZCA9IGZhbHNlOwogICAgICAgIHRoaXMubWVkaWFTb3VyY2UuYWRkRXZlbnRMaXN0ZW5lcignc291cmNlb3BlbicsIHRoaXMub25NU0VPcGVuLmJpbmQodGhpcykpOwogICAgICAgIHRoaXMubWVkaWFTb3VyY2UuYWRkRXZlbnRMaXN0ZW5lcignc291cmNlY2xvc2UnLCB0aGlzLm9uTVNFQ2xvc2UuYmluZCh0aGlzKSk7CiAgICAgICAgdGhpcy5tZWRpYVNvdXJjZS5hZGRFdmVudExpc3RlbmVyKCd3ZWJraXRzb3VyY2VvcGVuJywgdGhpcy5vbk1TRU9wZW4uYmluZCh0aGlzKSk7CiAgICAgICAgdGhpcy5tZWRpYVNvdXJjZS5hZGRFdmVudExpc3RlbmVyKCd3ZWJraXRzb3VyY2VjbG9zZScsIHRoaXMub25NU0VDbG9zZS5iaW5kKHRoaXMpKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJlbmRNU0UiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZW5kTVNFKCkgewogICAgICAgIGlmICghdGhpcy5tc2VFbmRlZCkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdGhpcy5tc2VFbmRlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMubWVkaWFTb3VyY2UuZW5kT2ZTdHJlYW0oKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgZXJyb3IoJ21lZGlhc291cmNlIGlzIG5vdCBhdmFpbGFibGUgdG8gZW5kJyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImZlZWQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZmVlZChkYXRhKSB7CiAgICAgICAgaWYgKCFkYXRhIHx8ICF0aGlzLnJlbXV4Q29udHJvbGxlcikgcmV0dXJuOwogICAgICAgIGRhdGEuZHVyYXRpb24gPSBkYXRhLmR1cmF0aW9uID8gcGFyc2VJbnQoZGF0YS5kdXJhdGlvbikgOiAwOwogICAgICAgIHRoaXMucmVtdXhDb250cm9sbGVyLmZlZWQoZGF0YSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZGVzdHJveSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBkZXN0cm95KCkgewogICAgICAgIHRoaXMuc3RvcEludGVydmFsKCk7CiAgICAgICAgaWYgKHRoaXMuc3RyZWFtKSB7CiAgICAgICAgICB0aGlzLnJlbXV4Q29udHJvbGxlci5mbHVzaCgpOwogICAgICAgICAgdGhpcy5zdHJlYW0ucHVzaChudWxsKTsKICAgICAgICAgIHRoaXMuc3RyZWFtID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMucmVtdXhDb250cm9sbGVyKSB7CiAgICAgICAgICB0aGlzLnJlbXV4Q29udHJvbGxlci5kZXN0cm95KCk7CiAgICAgICAgICB0aGlzLnJlbXV4Q29udHJvbGxlciA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLmJ1ZmZlckNvbnRyb2xsZXJzKSB7CiAgICAgICAgICBmb3IgKHZhciB0eXBlIGluIHRoaXMuYnVmZmVyQ29udHJvbGxlcnMpIHsKICAgICAgICAgICAgdGhpcy5idWZmZXJDb250cm9sbGVyc1t0eXBlXS5kZXN0cm95KCk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmJ1ZmZlckNvbnRyb2xsZXJzID0gbnVsbDsKICAgICAgICAgIHRoaXMuZW5kTVNFKCk7CiAgICAgICAgfQogICAgICAgIHRoaXMubm9kZSA9IGZhbHNlOwogICAgICAgIHRoaXMubXNlUmVhZHkgPSBmYWxzZTsKICAgICAgICB0aGlzLnZpZGVvU3RhcnRlZCA9IGZhbHNlOwogICAgICAgIHRoaXMubWVkaWFTb3VyY2UgPSBudWxsOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlc2V0IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlc2V0KCkgewogICAgICAgIHRoaXMuc3RvcEludGVydmFsKCk7CiAgICAgICAgdGhpcy5pc1Jlc2V0ID0gdHJ1ZTsKICAgICAgICB0aGlzLm5vZGUucGF1c2UoKTsKICAgICAgICBpZiAodGhpcy5yZW11eENvbnRyb2xsZXIpIHsKICAgICAgICAgIHRoaXMucmVtdXhDb250cm9sbGVyLnJlc2V0KCk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLmJ1ZmZlckNvbnRyb2xsZXJzKSB7CiAgICAgICAgICBmb3IgKHZhciB0eXBlIGluIHRoaXMuYnVmZmVyQ29udHJvbGxlcnMpIHsKICAgICAgICAgICAgdGhpcy5idWZmZXJDb250cm9sbGVyc1t0eXBlXS5kZXN0cm95KCk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmJ1ZmZlckNvbnRyb2xsZXJzID0gbnVsbDsKICAgICAgICAgIHRoaXMuZW5kTVNFKCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuaW5pdERhdGEoKTsKICAgICAgICBpZiAodGhpcy5lbnYgPT0gJ2Jyb3dzZXInKSB7CiAgICAgICAgICB0aGlzLmluaXRCcm93c2VyKCk7CiAgICAgICAgfQogICAgICAgIGxvZygnSk11eGVyIHdhcyByZXNldCcpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImNyZWF0ZUJ1ZmZlciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGVCdWZmZXIoKSB7CiAgICAgICAgaWYgKCF0aGlzLm1zZVJlYWR5IHx8ICF0aGlzLnJlbXV4Q29udHJvbGxlciB8fCAhdGhpcy5yZW11eENvbnRyb2xsZXIuaXNSZWFkeSgpIHx8IHRoaXMuYnVmZmVyQ29udHJvbGxlcnMpIHJldHVybjsKICAgICAgICB0aGlzLmJ1ZmZlckNvbnRyb2xsZXJzID0ge307CiAgICAgICAgZm9yICh2YXIgdHlwZSBpbiB0aGlzLnJlbXV4Q29udHJvbGxlci50cmFja3MpIHsKICAgICAgICAgIHZhciB0cmFjayA9IHRoaXMucmVtdXhDb250cm9sbGVyLnRyYWNrc1t0eXBlXTsKICAgICAgICAgIGlmICghSk11eGVyLmlzU3VwcG9ydGVkKCIiLmNvbmNhdCh0eXBlLCAiL21wNDsgY29kZWNzPVwiIikuY29uY2F0KHRyYWNrLm1wNHRyYWNrLmNvZGVjLCAiXCIiKSkpIHsKICAgICAgICAgICAgZXJyb3IoIkJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBjb2RlYzogIi5jb25jYXQodHlwZSwgIi9tcDQ7IGNvZGVjcz1cIiIpLmNvbmNhdCh0cmFjay5tcDR0cmFjay5jb2RlYywgIlwiIikpOwogICAgICAgICAgICBpZiAodHlwZW9mIHRoaXMub3B0aW9ucy5vblVuc3VwcG9ydGVkQ29kZWMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMub25VbnN1cHBvcnRlZENvZGVjLmNhbGwobnVsbCwgdHJhY2subXA0dHJhY2suY29kZWMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzYiA9IHRoaXMubWVkaWFTb3VyY2UuYWRkU291cmNlQnVmZmVyKCIiLmNvbmNhdCh0eXBlLCAiL21wNDsgY29kZWNzPVwiIikuY29uY2F0KHRyYWNrLm1wNHRyYWNrLmNvZGVjLCAiXCIiKSk7CiAgICAgICAgICB0aGlzLmJ1ZmZlckNvbnRyb2xsZXJzW3R5cGVdID0gbmV3IEJ1ZmZlckNvbnRyb2xsZXIoc2IsIHR5cGUpOwogICAgICAgICAgdGhpcy5idWZmZXJDb250cm9sbGVyc1t0eXBlXS5vbignZXJyb3InLCB0aGlzLm9uQnVmZmVyRXJyb3IuYmluZCh0aGlzKSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInN0YXJ0SW50ZXJ2YWwiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc3RhcnRJbnRlcnZhbCgpIHsKICAgICAgICB2YXIgX3RoaXMyID0gdGhpczsKICAgICAgICB0aGlzLmludGVydmFsID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKF90aGlzMi5vcHRpb25zLmZsdXNoaW5nVGltZSkgewogICAgICAgICAgICBfdGhpczIuYXBwbHlBbmRDbGVhckJ1ZmZlcigpOwogICAgICAgICAgfSBlbHNlIGlmIChfdGhpczIuYnVmZmVyQ29udHJvbGxlcnMpIHsKICAgICAgICAgICAgX3RoaXMyLmNhbmNlbERlbGF5KCk7CiAgICAgICAgICB9CiAgICAgICAgfSwgdGhpcy5vcHRpb25zLmZsdXNoaW5nVGltZSB8fCAxMDAwKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzdG9wSW50ZXJ2YWwiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc3RvcEludGVydmFsKCkgewogICAgICAgIGlmICh0aGlzLmludGVydmFsKSB7CiAgICAgICAgICBjbGVhckludGVydmFsKHRoaXMuaW50ZXJ2YWwpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJjYW5jZWxEZWxheSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBjYW5jZWxEZWxheSgpIHsKICAgICAgICBpZiAodGhpcy5ub2RlLmJ1ZmZlcmVkICYmIHRoaXMubm9kZS5idWZmZXJlZC5sZW5ndGggPiAwICYmICF0aGlzLm5vZGUuc2Vla2luZykgewogICAgICAgICAgdmFyIGVuZCA9IHRoaXMubm9kZS5idWZmZXJlZC5lbmQoMCk7CiAgICAgICAgICBpZiAoZW5kIC0gdGhpcy5ub2RlLmN1cnJlbnRUaW1lID4gdGhpcy5vcHRpb25zLm1heERlbGF5IC8gMTAwMCkgewogICAgICAgICAgICBsb2coJ2RlbGF5Jyk7CiAgICAgICAgICAgIGlmICh0aGlzLm5vZGUucGF1c2VkKSB0aGlzLm5vZGUucGxheSgpWyJjYXRjaCJdKGVycm9yKTsKICAgICAgICAgICAgdGhpcy5ub2RlLmN1cnJlbnRUaW1lID0gZW5kIC0gMC4wMDE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlbGVhc2VCdWZmZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVsZWFzZUJ1ZmZlcigpIHsKICAgICAgICBmb3IgKHZhciB0eXBlIGluIHRoaXMuYnVmZmVyQ29udHJvbGxlcnMpIHsKICAgICAgICAgIHRoaXMuYnVmZmVyQ29udHJvbGxlcnNbdHlwZV0uZG9BcHBlbmQoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiYXBwbHlBbmRDbGVhckJ1ZmZlciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBhcHBseUFuZENsZWFyQnVmZmVyKCkgewogICAgICAgIGlmICh0aGlzLmJ1ZmZlckNvbnRyb2xsZXJzKSB7CiAgICAgICAgICB0aGlzLnJlbGVhc2VCdWZmZXIoKTsKICAgICAgICAgIHRoaXMuY2xlYXJCdWZmZXIoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0U2FmZUNsZWFyT2Zmc2V0T2ZCdWZmZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0U2FmZUNsZWFyT2Zmc2V0T2ZCdWZmZXIob2Zmc2V0KSB7CiAgICAgICAgdmFyIG1heExpbWl0ID0gdGhpcy5vcHRpb25zLm1vZGUgPT09ICdhdWRpbycgJiYgb2Zmc2V0IHx8IDAsCiAgICAgICAgICBhZGphY2VudE9mZnNldDsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMua2ZQb3NpdGlvbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKHRoaXMua2ZQb3NpdGlvbltpXSA+PSBvZmZzZXQpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBhZGphY2VudE9mZnNldCA9IHRoaXMua2ZQb3NpdGlvbltpXTsKICAgICAgICB9CiAgICAgICAgaWYgKGFkamFjZW50T2Zmc2V0KSB7CiAgICAgICAgICB0aGlzLmtmUG9zaXRpb24gPSB0aGlzLmtmUG9zaXRpb24uZmlsdGVyKGZ1bmN0aW9uIChrZkRlbGltaXRlcikgewogICAgICAgICAgICBpZiAoa2ZEZWxpbWl0ZXIgPCBhZGphY2VudE9mZnNldCkgewogICAgICAgICAgICAgIG1heExpbWl0ID0ga2ZEZWxpbWl0ZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGtmRGVsaW1pdGVyID49IGFkamFjZW50T2Zmc2V0OwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBtYXhMaW1pdDsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJjbGVhckJ1ZmZlciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBjbGVhckJ1ZmZlcigpIHsKICAgICAgICBpZiAodGhpcy5vcHRpb25zLmNsZWFyQnVmZmVyICYmIERhdGUubm93KCkgLSB0aGlzLmxhc3RDbGVhbmluZ1RpbWUgPiAxMDAwMCkgewogICAgICAgICAgZm9yICh2YXIgdHlwZSBpbiB0aGlzLmJ1ZmZlckNvbnRyb2xsZXJzKSB7CiAgICAgICAgICAgIHZhciBjbGVhbk1heExpbWl0ID0gdGhpcy5nZXRTYWZlQ2xlYXJPZmZzZXRPZkJ1ZmZlcih0aGlzLm5vZGUuY3VycmVudFRpbWUpOwogICAgICAgICAgICB0aGlzLmJ1ZmZlckNvbnRyb2xsZXJzW3R5cGVdLmluaXRDbGVhbnVwKGNsZWFuTWF4TGltaXQpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5sYXN0Q2xlYW5pbmdUaW1lID0gRGF0ZS5ub3coKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAib25CdWZmZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gb25CdWZmZXIoZGF0YSkgewogICAgICAgIGlmICh0aGlzLm9wdGlvbnMucmVhZEZwc0Zyb21UcmFjayAmJiB0eXBlb2YgZGF0YS5mcHMgIT09ICd1bmRlZmluZWQnICYmIHRoaXMub3B0aW9ucy5mcHMgIT0gZGF0YS5mcHMpIHsKICAgICAgICAgIHRoaXMub3B0aW9ucy5mcHMgPSBkYXRhLmZwczsKICAgICAgICAgIHRoaXMuZnJhbWVEdXJhdGlvbiA9IE1hdGguY2VpbCgxMDAwIC8gZGF0YS5mcHMpOwogICAgICAgICAgbG9nKCJKTXV4ZXIgY2hhbmdlZCBGUFMgdG8gIi5jb25jYXQoZGF0YS5mcHMsICIgZnJvbSB0cmFjayBkYXRhIikpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5lbnYgPT0gJ2Jyb3dzZXInKSB7CiAgICAgICAgICBpZiAodGhpcy5idWZmZXJDb250cm9sbGVycyAmJiB0aGlzLmJ1ZmZlckNvbnRyb2xsZXJzW2RhdGEudHlwZV0pIHsKICAgICAgICAgICAgdGhpcy5idWZmZXJDb250cm9sbGVyc1tkYXRhLnR5cGVdLmZlZWQoZGF0YS5wYXlsb2FkKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHRoaXMuc3RyZWFtKSB7CiAgICAgICAgICB0aGlzLnN0cmVhbS5wdXNoKGRhdGEucGF5bG9hZCk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLm9wdGlvbnMub25EYXRhKSB7CiAgICAgICAgICB0aGlzLm9wdGlvbnMub25EYXRhKGRhdGEucGF5bG9hZCk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLm9wdGlvbnMuZmx1c2hpbmdUaW1lID09PSAwKSB7CiAgICAgICAgICB0aGlzLmFwcGx5QW5kQ2xlYXJCdWZmZXIoKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8qIEV2ZW50cyBvbiBNU0UgKi8KICAgIH0sIHsKICAgICAga2V5OiAib25NU0VPcGVuIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIG9uTVNFT3BlbigpIHsKICAgICAgICB0aGlzLm1zZVJlYWR5ID0gdHJ1ZTsKICAgICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKHRoaXMudXJsKTsKICAgICAgICAvLyB0aGlzLmNyZWF0ZUJ1ZmZlcigpOwogICAgICAgIGlmICh0eXBlb2YgdGhpcy5vcHRpb25zLm9uUmVhZHkgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIHRoaXMub3B0aW9ucy5vblJlYWR5LmNhbGwobnVsbCwgdGhpcy5pc1Jlc2V0KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAib25NU0VDbG9zZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBvbk1TRUNsb3NlKCkgewogICAgICAgIHRoaXMubXNlUmVhZHkgPSBmYWxzZTsKICAgICAgICB0aGlzLnZpZGVvU3RhcnRlZCA9IGZhbHNlOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIm9uQnVmZmVyRXJyb3IiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gb25CdWZmZXJFcnJvcihkYXRhKSB7CiAgICAgICAgaWYgKGRhdGEubmFtZSA9PSAnUXVvdGFFeGNlZWRlZCcpIHsKICAgICAgICAgIGxvZygiSk11eGVyIGNsZWFuaW5nICIuY29uY2F0KGRhdGEudHlwZSwgIiBidWZmZXIgZHVlIHRvIFF1b3RhRXhjZWVkZWQgZXJyb3IiKSk7CiAgICAgICAgICB0aGlzLmJ1ZmZlckNvbnRyb2xsZXJzW2RhdGEudHlwZV0uaW5pdENsZWFudXAodGhpcy5ub2RlLmN1cnJlbnRUaW1lKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9IGVsc2UgaWYgKGRhdGEubmFtZSA9PSAnSW52YWxpZFN0YXRlRXJyb3InKSB7CiAgICAgICAgICBsb2coJ0pNdXhlciBpcyByZXNldGluZyBkdWUgdG8gSW52YWxpZFN0YXRlRXJyb3InKTsKICAgICAgICAgIHRoaXMucmVzZXQoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5lbmRNU0UoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLm9wdGlvbnMub25FcnJvciA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgdGhpcy5vcHRpb25zLm9uRXJyb3IuY2FsbChudWxsLCBkYXRhKTsKICAgICAgICB9CiAgICAgIH0KICAgIH1dLCBbewogICAgICBrZXk6ICJpc1N1cHBvcnRlZCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBpc1N1cHBvcnRlZChjb2RlYykgewogICAgICAgIHJldHVybiB3aW5kb3cuTWVkaWFTb3VyY2UgJiYgd2luZG93Lk1lZGlhU291cmNlLmlzVHlwZVN1cHBvcnRlZChjb2RlYyk7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBKTXV4ZXI7CiAgfShFdmVudCk7CgogIHJldHVybiBKTXV4ZXI7Cgp9KSk7Cg==";
    try {
        var decoded = atob(b64Data.replace(/\\s/g, ''));
        var script = document.createElement('script');
        script.textContent = decoded;
        document.head.appendChild(script);
        console.log("✅ JMuxer loaded success!");
    } catch (e) {
        console.error("❌ Error to loading JMuxer:", e);
    }
})();
</script>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="shortcut icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAASElEQVR42mOAgwlK/0FU2Ibs/8h8DAUMB3T/wzBMHF0BiknoChECD0z/gxSBaLg4TCeIA6TBmPG/LZhGEidoEkluIuw7osIJAOeBWtkwJEj3AAAAAElFTkSuQmCC" />
<title>SynchroGaea - SRV</title>
<style type="text/css">
:root{--g:#00ff9d;--d:#001a0f;--s:#003d1f;--r:#ff3c3c;--y:#ffd700;--panel:#0a1f14;--bdr:#1a4d2e}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--d);color:var(--g);font-family:'Share Tech Mono',monospace;
     display:flex;flex-direction:column;height:100vh;overflow:hidden}
header{display:flex;align-items:center;justify-content:space-between;
       padding:8px 16px;background:var(--panel);border-bottom:1px solid var(--bdr);flex-shrink:0}
header h1{font-family:'Orbitron',sans-serif;font-size:1rem;letter-spacing:.2em;color:var(--g)}
#st{font-size:.7rem;padding:3px 10px;border-radius:2px;background:#0d2b1a;border:1px solid var(--bdr)}
#st.ok{color:var(--g)}#st.err{color:var(--r)}#st.warn{color:var(--y)}
main{display:flex;flex:1;overflow:hidden}
#vw{flex:1;display:flex;align-items:center;justify-content:center;
    background:#000;position:relative;overflow:hidden}
#vid{width:100%;height:100%;display:block;object-fit:contain;will-change:transform;transition:width .15s,height .15s}
#ovl{position:absolute;top:8px;left:8px;font-size:.65rem;color:rgba(0,255,157,.45);
     pointer-events:none;line-height:1.7;text-shadow:0 0 6px #000}
aside{width:220px;background:var(--panel);border-left:1px solid var(--bdr);
      display:flex;flex-direction:column;padding:12px;gap:10px;overflow-y:auto;flex-shrink:0}
.card{background:var(--d);border:1px solid var(--bdr);border-radius:4px;padding:10px}
.card h2{font-family:'Orbitron',sans-serif;font-size:.6rem;letter-spacing:.15em;
         color:#4dff9e;margin-bottom:8px;border-bottom:1px solid var(--bdr);padding-bottom:4px}
.row{display:flex;align-items:center;justify-content:space-between;gap:6px;margin-bottom:6px}
label{font-size:.65rem;color:#7aff9e;white-space:nowrap}
input[type=range]{flex:1;accent-color:var(--g);height:4px;cursor:pointer}
span.v{font-size:.65rem;color:var(--y);min-width:28px;text-align:right}
button{width:100%;padding:7px;background:var(--s);border:1px solid var(--g);
       color:var(--g);font-family:'Orbitron',sans-serif;font-size:.6rem;letter-spacing:.1em;
       cursor:pointer;border-radius:3px;transition:background .12s,color .12s}
button:hover{background:var(--g);color:var(--d)}
button:active{filter:brightness(1.3)}
button.danger{border-color:var(--r);color:var(--r)}
button.danger:hover{background:var(--r);color:#000}
.trow{display:flex;gap:5px;margin-top:4px}
.trow button{flex:1;font-size:.55rem;padding:5px 2px}
.on{background:var(--g)!important;color:var(--d)!important}
select{background:var(--s);border:1px solid var(--bdr);color:var(--g);
       font-family:inherit;font-size:.65rem;padding:2px 4px;border-radius:2px;width:100%}
#log{flex:1;min-height:80px;background:#000;border:1px solid var(--bdr);
     border-radius:3px;padding:6px;font-size:.6rem;overflow-y:auto;color:#4dff7c;line-height:1.5}
#log p{border-bottom:1px solid #0a1f14;padding:1px 0}
@media(max-width:600px){
  aside{width:100%;border-left:none;border-top:1px solid var(--bdr);
        flex-direction:row;flex-wrap:wrap;max-height:50vh;overflow-y:auto}
  .card{flex:1;min-width:150px}
}
</style>
</head>
<body>
<header>
  <h1>&#x2BC3; SYNCHROGAEA - <span style="font-size: 12px;">webserver</span></h1>
  <div id="st" class="err">APP DISCONNECTED</div>
</header>
<main>
  <div id="vw">
   <video id="vid" autoplay muted playsinline style="max-width:100%; max-height:100%; object-fit:contain;"></video>
  </div>
  <aside>
    <div class="card">
      <h2>VIDEO</h2>
      <div class="row">
        <label>QUALITY</label>
        <input type="range" id="qs" min="1" max="100" value="30"
               oninput="document.getElementById('qv').textContent=this.value">
        <span class="v" id="qv">30</span>
      </div>
      <button onclick="sendQuality()">APPLY QUALITY</button>
<div style="margin-top: 15px; padding: 10px; border-top: 1px solid #444;">
    <label style="color: #00ff00; font-weight: bold;">📺 Resolution:</label>
    <select id="resSelect" onchange="sendRes(this.value)" style="background: #222; color: #fff; border: 1px solid #00ff00; border-radius: 4px; padding: 5px;">
        <optgroup label="HD & 4K (16:9)">
            <option value="3840x2160">4K Ultra HD (2160p)</option>
            <option value="1920x1080" selected>Full HD (1080p)</option>
            <option value="1280x720">HD (720p)</option>
            <option value="960x540">qHD (540p)</option>
        </optgroup>
        <optgroup label="Standard (4:3)">
            <option value="1440x1080">iPad Style (1080p 4:3)</option>
            <option value="1024x768">XGA (768p)</option>
            <option value="640x480">VGA (480p)</option>
        </optgroup>
        <optgroup label="Low Res / Data Saving">
            <option value="426x240">240p (Saving Mode)</option>
            <option value="352x288">CIF</option>
            <option value="320x240">QVGA</option>
        </optgroup>
    </select>
</div>
<div style="margin-top: 10px;">
    <button onclick="switchCam()" style="background: #00ff00; color: #000; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold;">
        🔄 Switch Camera (Front/Back)
    </button>
</div>
      <div style="margin-top:8px"><label>ROTATION</label>
        <div class="trow">
          <button id="r0"   class="on" onclick="setRot(0)">0&deg;</button>
          <button id="r90"  onclick="setRot(90)">90&deg;</button>
          <button id="r180" onclick="setRot(180)">180&deg;</button>
          <button id="r270" onclick="setRot(270)">270&deg;</button>
        </div>
      </div>
      <div class="trow" style="margin-top:8px">
        <button id="mh" onclick="toggleMirror('h')">&#x21C6; MIRROR H</button>
        <button id="mv" onclick="toggleMirror('v')">&#x21C5; MIRROR V</button>
      </div>
      <div style="margin-top:8px">
        <label>ASPECT RATIO</label>
        <div style="display:flex;gap:5px;margin-top:4px">
          <input id="arW" type="number" min="1" max="99" value="16"
                 style="width:44px;background:var(--s);border:1px solid var(--bdr);color:var(--g);
                        font-family:inherit;font-size:.65rem;padding:2px 4px;border-radius:2px;text-align:center">
          <span style="align-self:center;font-size:.7rem">:</span>
          <input id="arH" type="number" min="1" max="99" value="9"
                 style="width:44px;background:var(--s);border:1px solid var(--bdr);color:var(--g);
                        font-family:inherit;font-size:.65rem;padding:2px 4px;border-radius:2px;text-align:center">
          <button onclick="setAspectRatio()" style="flex:1;font-size:.55rem;padding:5px 2px">SET AR</button>
          <button onclick="resetAspectRatio()" style="flex:1;font-size:.55rem;padding:5px 2px">FREE</button>
        </div>
      </div>
      <div style="margin-top:8px">
        <div class="row">
          <label>WIDTH</label>
          <input type="range" id="vidW" min="10" max="100" value="100"
                 oninput="applyVidWidth(this.value)">
          <span class="v" id="vidWv">100%</span>
        </div>
        <div class="row">
          <label>HEIGHT</label>
          <input type="range" id="vidH" min="10" max="100" value="100"
                 oninput="applyVidHeight(this.value)">
          <span class="v" id="vidHv">100%</span>
        </div>
      </div>
    </div>
    <div class="card">
      <h2>AUDIO</h2>
      <div class="row">
        <label>SAMPLE RATE</label>
        <select id="sr">
          <option value="8000">8 kHz</option>
          <option value="16000" selected>16 kHz</option>
          <option value="22050">22 kHz</option>
          <option value="44100">44 kHz</option>
        </select>
      </div>
      <button onclick="syncRate()">SYNC RATE</button>
      <button id="btnA" onclick="toggleAudio()" style="margin-top:6px">&#128266; ENABLE AUDIO</button>
      <button id="btnM" onclick="toggleMic()" style="margin-top:6px">&#127897; ENABLE MIC</button>
    </div>
    <div class="card">
      <h2>COMMANDS</h2>
      <button class="danger" onclick="sendVibrate()">&#9889; VIBRATE</button>
      <button id="btnTorch" onclick="sendTorch()" style="margin-top:6px; border-color:var(--g); color:var(--g)">🔦 TORCH (ON/OFF)</button>
      <button id="btnRec" onclick="toggleWebRec()" style="margin-top:6px; border-color:var(--y); color:var(--y)">🔴 START WEB REC</button>
    </div>
    <div class="card" style="flex:1;display:flex;flex-direction:column;min-height:100px">
      <h2>LOG</h2>
      <div id="log"></div>
    </div>
  </aside>
</main>

<script type="text/javascript">
'use strict';
const WS = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.hostname + ':8765';
const img = document.getElementById('vid');
const ovl = document.getElementById('ovl');
const st  = document.getElementById('st');
const logEl = document.getElementById('log');
let ws;
let rot=0, mh=false, mv=false;
let fpsCnt=0, fpsT=performance.now(), fps=0;
let actx=null, audioOn=false, nextT=0;
let mediaRecorder;
let recordedChunks = [];
let recCanvas = document.createElement('canvas');
let recCtx = recCanvas.getContext('2d');
let audioDest;
let isRecording = false;
let jmuxer;
let lastBatt = "--";
let currentLens = 1;
const videoElement = document.getElementById('vid');
function toggleAudio(){
  if(!actx){
    actx = new (window.AudioContext||window.webkitAudioContext)(
      {sampleRate:+document.getElementById('sr').value, latencyHint:'playback'});
    nextT = actx.currentTime + 0.1;
  }
  audioOn = !audioOn;
  const b = document.getElementById('btnA');
  b.textContent = audioOn ? '(OFF) DISABLE AUDIO 🔇' : '(ON) ENABLE AUDIO 🔊';
  b.classList.toggle('on', audioOn);
  log('Audio '+(audioOn?'ON':'OFF'));
}
function playPCM(ab){
  if(!audioOn||!actx) return;
  const n = ab.byteLength>>1;
  if(!n) return;
  const buf = actx.createBuffer(1,n,actx.sampleRate);
  const ch  = buf.getChannelData(0);
  const dv  = new DataView(ab);
  for(let i=0;i<n;i++) ch[i]=dv.getInt16(i<<1,true)*3.0517578125e-5;
  const s=actx.createBufferSource(); s.buffer=buf; s.connect(actx.destination);
  if(isRecording && audioDest) s.connect(audioDest);
  const now=actx.currentTime;
  if(nextT<now+0.02) nextT=now+0.08;
  s.start(nextT); nextT+=buf.duration;
}
function toggleWebRec() {
    if (!isRecording) { startWebRec(); } else { stopWebRec(); }
}
function startWebRec() {
    recordedChunks = [];
    const nw = videoElement.videoWidth || 1280;
    const nh = videoElement.videoHeight || 720;
    const isPortrait = (rot === 90 || rot === 270);
    recCanvas.width = isPortrait ? nh : nw;
    recCanvas.height = isPortrait ? nw : nh;
    const videoStream = recCanvas.captureStream(30);
    let tracks = [videoStream.getVideoTracks()[0]];
    if (actx) {
        audioDest = actx.createMediaStreamDestination();
        tracks.push(audioDest.stream.getAudioTracks()[0]);
    }
    const combinedStream = new MediaStream(tracks);
    mediaRecorder = new MediaRecorder(combinedStream, { 
        mimeType: 'video/webm;codecs=vp8,opus', 
        bitsPerSecond: 5000000 
    });
    mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
    mediaRecorder.onstop = exportRec;
    function drawFrame() {
        if (!isRecording) return;
        recCtx.clearRect(0, 0, recCanvas.width, recCanvas.height);
        recCtx.save();
        recCtx.translate(recCanvas.width/2, recCanvas.height/2);
        recCtx.rotate(rot * Math.PI / 180);
        recCtx.scale(mh ? -1 : 1, mv ? -1 : 1);
        recCtx.drawImage(videoElement, -nw/2, -nh/2, nw, nh);
        recCtx.restore();
        requestAnimationFrame(drawFrame);
    }
    mediaRecorder.start();
    isRecording = true;
    drawFrame();
    document.getElementById('btnRec').textContent = "⏹ STOP & SAVE REC";
    document.getElementById('btnRec').classList.add('on');
    log("Web Recording started (AV)...");
}
function stopWebRec() {
    if(mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
    }
    isRecording = false;
    document.getElementById('btnRec').textContent = "🔴 START WEB REC";
    document.getElementById('btnRec').classList.remove('on');
}
function exportRec() {
    const blob = new Blob(recordedChunks, { type: 'video/webm' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Synchro_WebRec_${new Date().getTime()}.webm`;
    a.click();
    URL.revokeObjectURL(url);
    log("Recording saved to Downloads");
}
function connect(){
  ws = new WebSocket(WS);
  ws.binaryType='arraybuffer';
  ws.onopen  = ()=>{ log('WSS connected'); setS('warn','WAITING FOR APP...'); };
  ws.onclose = ()=>{ log('WSS closed — retrying...'); setS('err','DISCONNECTED'); setTimeout(connect,2000); };
  ws.onerror = ()=>{ log('WSS error'); };
  ws.onmessage = onMsg;
}
function onMsg(e){
  if(typeof e.data==='string'){
    try{ const d=JSON.parse(e.data); if(d.log) log(d.log); }catch(_){}
    return;
  }
  const ab = e.data;
  if(ab.byteLength<2) return;
  const type = new DataView(ab,0,1).getUint8(0);
  const payload = ab.slice(1);
  if(type===1){
    if (!jmuxer) {
        jmuxer = new JMuxer({
            node: 'vid',
            mode: 'video',
            flushingTime: 0,
            fps: 30,
            debug: false
        });
    }
    jmuxer.feed({ video: new Uint8Array(payload) });
    fpsCnt++;
    const now=performance.now();
    if(now-fpsT>=1000){ 
        fps=Math.round(fpsCnt*1000/(now-fpsT)); 
        fpsCnt=0; 
        fpsT=now; 
    }
    let bIcon = parseInt(lastBatt) <= 20 ? '🪫' : '🔋';
    setS('ok', 'H.264 STREAMING - ' + fps + ' FPS | BACT: ' + lastBatt + '% ' + bIcon);
  } else if(type===2){
    playPCM(payload);
  } else if(type===130){
    lastBatt = new TextDecoder().decode(payload);
  } else if(type===255){
    log(new TextDecoder().decode(payload));
  }
}
function send(o){ if(ws&&ws.readyState===1) ws.send(JSON.stringify(o)); }
function sendQuality(){ const q=+document.getElementById('qs').value; send({cmd:'SET_QUALITY',value:q}); log('SET_QUALITY '+q); }
function sendRes(val) { if(confirm("Changing resolution will restart the camera engine. Continue?")) { send({cmd: 'SET_RES', value: val}); log('Requesting resolution: ' + val); } }
function sendVibrate(){ send({cmd:'VIBRATE'}); log('VIBRATE sent'); }
function sendTorch(){ send({cmd:'TORCH'}); log('TORCH toggle sent'); }
function switchCam() { currentLens = (currentLens === 1) ? 0 : 1; send({cmd: 'SWITCH_CAM', value: currentLens}); log('Switching camera lens to: ' + (currentLens === 1 ? 'Back' : 'Front')); }
function syncRate(){
  const r=+document.getElementById('sr').value;
  send({cmd:'SET_RATE',value:r});
  if(actx){ actx.close(); actx=null; audioOn=false;
    document.getElementById('btnA').textContent='(ON) ENABLE AUDIO';
    document.getElementById('btnA').classList.remove('on'); }
  log('SET_RATE '+r);
}
function setRot(d){
  rot=d;
  ['r0','r90','r180','r270'].forEach(id=>document.getElementById(id).classList.remove('on'));
  document.getElementById('r'+d).classList.add('on');
  applyXform();
}
function toggleMirror(a){
  if(a==='h'){ mh=!mh; document.getElementById('mh').classList.toggle('on',mh); }
  else        { mv=!mv; document.getElementById('mv').classList.toggle('on',mv); }
  applyXform();
}
let scaleW=1, scaleH=1;
function applyVidWidth(val){
  document.getElementById('vidWv').textContent=val+'%';
  scaleW = val/100;
  applyXform();
}
function applyVidHeight(val){
  document.getElementById('vidHv').textContent=val+'%';
  scaleH = val/100;
  applyXform();
}
function setAspectRatio(){
  const w=+document.getElementById('arW').value;
  const h=+document.getElementById('arH').value;
  if(!w||!h||w<1||h<1){ log('Invalid aspect ratio'); return; }
  const vidW = videoElement.videoWidth||1280;
  const vidH = videoElement.videoHeight||720;
  const currentAR = vidW/vidH;
  const targetAR  = w/h;
  scaleH = scaleW * (currentAR / targetAR);
  document.getElementById('vidH').value = Math.min(100, Math.round(scaleH*100));
  document.getElementById('vidHv').textContent = document.getElementById('vidH').value+'%';
  applyXform();
  log('Aspect ratio set to '+w+':'+h);
}
function resetAspectRatio(){
  scaleW=1; scaleH=1;
  document.getElementById('vidW').value=100; document.getElementById('vidWv').textContent='100%';
  document.getElementById('vidH').value=100; document.getElementById('vidHv').textContent='100%';
  applyXform();
  log('Aspect ratio: free (original)');
}
function applyXform(){
  const sx = (mh?-1:1)*scaleW;
  const sy = (mv?-1:1)*scaleH;
  videoElement.style.transform='rotate('+rot+'deg) scale('+sx+','+sy+')';
}
function setS(c,t){ st.className=c; st.textContent=t; }
function log(m){
  const p=document.createElement('p');
  p.textContent='['+new Date().toLocaleTimeString()+'] '+m;
  logEl.appendChild(p);
  while(logEl.childElementCount>200) logEl.removeChild(logEl.firstChild);
  logEl.scrollTop=logEl.scrollHeight;
}
let micOn=false, micStream=null, micProc=null, micSrc=null, micCtx=null;
function toggleMic(){ if(!micOn){ startMic(); } else { stopMic(); } }
function startMic(){
  navigator.mediaDevices.getUserMedia({audio:{sampleRate:16000,channelCount:1,echoCancellation:true,noiseSuppression:true},video:false})
  .then(function(stream){
    micStream = stream;
    micCtx = new (window.AudioContext||window.webkitAudioContext)({sampleRate:16000});
    micSrc  = micCtx.createMediaStreamSource(stream);
    micProc = micCtx.createScriptProcessor(4096,1,1);
    micProc.onaudioprocess = function(ev){
      if(!micOn||!ws||ws.readyState!==1) return;
      const input = ev.inputBuffer.getChannelData(0);
      const pcm = new Int16Array(input.length);
      for(var i=0;i<input.length;i++){
        var s = Math.max(-1, Math.min(1, input[i]));
        pcm[i] = s < 0 ? s*32768 : s*32767;
      }
      const pkt = new Uint8Array(1 + pcm.byteLength);
      pkt[0] = 2;
      pkt.set(new Uint8Array(pcm.buffer), 1);
      ws.send(pkt.buffer);
    };
    micSrc.connect(micProc);
    micProc.connect(micCtx.destination);
    micOn = true;
    const b=document.getElementById('btnM');
    b.textContent='🎤 DISABLE MIC'; b.classList.add('on');
    log('Mic ON');
  })
  .catch(function(err){ log('Mic error: '+err.message); });
}
function stopMic(){
  micOn = false;
  try{ micProc.disconnect(); micSrc.disconnect(); micCtx.close(); }catch(_){}
  try{ micStream.getTracks().forEach(function(t){t.stop();}); }catch(_){}
  micStream=null; micProc=null; micSrc=null; micCtx=null;
  const b=document.getElementById('btnM');
  b.textContent='🎤 ENABLE MIC'; b.classList.remove('on');
  log('Mic OFF');
}
setInterval(function(){
  if(ws && ws.readyState===1) ws.send(JSON.stringify({cmd:'PING'}));
}, 15000);
connect();
log('UI ready');

</script>
<script type="text/javascript" id="sec-script" data-hash="">
async function securityCheck() {
    const serverHash = document.getElementById('sec-script').getAttribute('data-hash');
    if (!serverHash || serverHash.length < 64) {
        document.body.innerHTML = "<h1 style='color:red;text-align:center;margin-top:20%'>🚨 SECURITY BREACH: INVALID FINGERPRINT</h1>";
        if(ws) ws.close();
        return;
    }
    log("🔒 Session Fingerprint: " + serverHash.substring(0, 16) + "...");
}
securityCheck();
</script>
</body>
</html>"""
HTML      = HTML.encode("utf-8")
_HTML_LEN = str(len(HTML)).encode()
def check_or_create_password():
    file_path = "pasw.txt"
    if os.path.exists(file_path):
        with open(file_path, "r") as f:
            lines = f.read().splitlines()
            if len(lines) >= 2:
                return lines[0], lines[1]
    print(f"\n{MAGENTA}{BOLD}╔══════════════════════════════════════╗{RESET}")
    print(f"{MAGENTA}{BOLD}║         🔐 SERVER SECURITY SETUP      ║{RESET}")
    print(f"{MAGENTA}{BOLD}╚══════════════════════════════════════╝{RESET}\n")
    print(f"{CYAN}{BOLD}[SETUP]{RESET} Welcome! Configure your admin credentials.\n")
    while True:
        user = input(f"{YELLOW}➜ Enter new Username: {RESET}").strip()
        if not user:
            print(f"{RED}{BOLD}✖ Username cannot be empty!{RESET}\n")
            continue
        break
    while True:
        pwd = getpass.getpass(f"{YELLOW}➜ Enter new Password: {RESET}")
        confirm_pwd = getpass.getpass(f"{YELLOW}➜ Confirm Password: {RESET}")
        if not pwd:
            print(f"{RED}{BOLD}✖ Password cannot be empty!{RESET}\n")
            continue
        if pwd != confirm_pwd:
            print(f"{RED}{BOLD}✖ Passwords do not match. Try again.{RESET}\n")
            continue
        break
    salt = os.urandom(16).hex()
    user_hashed = hashlib.sha256(user.encode()).hexdigest()
    pass_with_salt = salt + pwd
    pass_hashed = hashlib.sha256(pass_with_salt.encode()).hexdigest()
    with open(file_path, "w") as f:
        f.write(f"{user_hashed}\n{salt}:{pass_hashed}")
    print(f"\n{GREEN}{BOLD}✔ Credentials successfully saved!{RESET}")
    print(f"{CYAN}[INFO]{RESET} Stored securely in {file_path} (Salted SHA-256).")
    print(f"{CYAN}[INFO]{RESET} You must use these credentials to access the Web UI.\n")
    return user_hashed, f"{salt}:{pass_hashed}"
class _Handler(BaseHTTPRequestHandler):
    def do_GET(self):
        global _EXPECTED_USER_HASH, _EXPECTED_PASS_HASH
        auth_header = self.headers.get('Authorization')
        client_address = self.client_address[0]
        now = time.time()
        if client_address in _BANNED_IPS:
            attempts, last_time = _BANNED_IPS[client_address]
            if attempts >= 3:
                if now - last_time < 60:
                    self.send_response(403)
                    self.end_headers()
                    self.wfile.write(
                b"<!DOCTYPE html>"
                b"<html lang='en'>"
                b"<head>"
                b"<meta charset='UTF-8'>"
                b"<link rel='shortcut icon' href='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAALklEQVR42mOAgf+MvP/RMQMyQBLAECeoAEaDCVwKcCnCysfUBQeYiih3PFHhBACeLztdzfuCpwAAAABJRU5ErkJggg=='>"
                b"<title>IP BANNED!</title>"
                b"</head>"
                b"<body bgcolor='#000' style='margin:0;padding:0;height:100vh;display:flex;align-items:center;justify-content:center;background:radial-gradient(circle at center,#1a0000,#000000 70%);font-family:Arial,sans-serif;'>"
                b"<div style='background:#0a0a0a;padding:50px;border-radius:8px;text-align:center;color:#bbbbbb;box-shadow:0 0 40px rgba(255,0,0,0.6);border:2px solid #550000;'>"
                b"<h1 style='margin:0 0 20px 0;font-size:38px;color:#ff0000;text-transform:uppercase;letter-spacing:3px;text-shadow:0 0 15px rgba(255,0,0,0.9);'><h1>IP TEMPORARILY BANNED</h1><p>Too many attempts. <h1>Try again in a minute.</h1>"
                b"<p style='margin:0;font-size:18px;color:#888888;'>Invalid credentials or access denied.<br>Reload and try again.</p>"
                b"</div>"
                b"</body>"
                b"</html>"
                    )
                    return
                else:
                    _BANNED_IPS.pop(client_address, None)
                    print(f"\033[91m{EVENT_TIME} >>> [AUTH] Failure {attempts}/3 for {client_address}\033[0m")
        authorized = False
        print(f"\n{EVENT_TIME} >>> [WEB] Incoming connection attempt from {client_address}")
        if auth_header and auth_header.startswith('Basic '):
            try:
                encoded_credentials = auth_header.split(' ')[1]
                decoded = base64.b64decode(encoded_credentials).decode('utf-8')
                input_user, input_pass = decoded.split(':', 1)
                input_user_hash = hashlib.sha256(input_user.encode()).hexdigest()
                saved_salt, saved_hash = _EXPECTED_PASS_HASH.split(":")
                test_pass_hash = hashlib.sha256((saved_salt + input_pass).encode()).hexdigest()
                if (input_user_hash == _EXPECTED_USER_HASH and test_pass_hash == saved_hash):
                    authorized = True
                    _BANNED_IPS.pop(client_address, None)
                    print(f"\033[92m{EVENT_TIME} >>> [AUTH] Access GRANTED for user: {input_user}\033[0m")
                else:
                    attempts = _BANNED_IPS.get(client_address, [0, 0])[0] + 1
                    _BANNED_IPS[client_address] = [attempts, time.time()]
                    print(f"\033[91m{EVENT_TIME} >>> [AUTH] Access DENIED: Wrong credentials\033[0m")
            except Exception as e:
                print(f"{EVENT_TIME} >>> [AUTH] Error decoding credentials: {e}")
        else:
            print(f"{EVENT_TIME} >>> [WEB] Request from {client_address} without Authorization header.")
        if authorized:
            try:
                html_dinamico = HTML.decode("utf-8").replace(
                    'data-hash=""', 
                    f'data-hash="{_CURRENT_FINGERPRINT}"'
                )
                payload_final = html_dinamico.encode("utf-8")
                self.send_response(200)
                self.send_header("Content-Type", "text/html; charset=utf-8")
                self.send_header("X-SHA256-Fingerprint", _CURRENT_FINGERPRINT)
                self.send_header("X-Frame-Options", "DENY")
                self.send_header("X-Content-Type-Options", "nosniff")
                self.send_header("Strict-Transport-Security", "max-age=31536000; includeSubDomains")
                self.send_header("Content-Security-Policy", "upgrade-insecure-requests")
                self.send_header("Content-Length", str(len(payload_final)))
                self.send_header("X-Server-Fingerprint", _CURRENT_FINGERPRINT)
                self.send_header("Cache-Control", "no-store")
                self.end_headers()
                self.wfile.write(payload_final)
            except BrokenPipeError:
                pass
        else:
            time.sleep(1)
            body = (
                b"<!DOCTYPE html>"
                b"<html lang='en'>"
                b"<head>"
                b"<meta charset='UTF-8'>"
                b"<link rel='shortcut icon' href='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAALklEQVR42mOAgf+MvP/RMQMyQBLAECeoAEaDCVwKcCnCysfUBQeYiih3PFHhBACeLztdzfuCpwAAAABJRU5ErkJggg=='>"
                b"<title>ACCESS DENIED!</title>"
                b"</head>"
                b"<body bgcolor='#000' style='margin:0;padding:0;height:100vh;display:flex;align-items:center;justify-content:center;background:radial-gradient(circle at center,#1a0000,#000000 70%);font-family:Arial,sans-serif;'>"
                b"<div style='background:#0a0a0a;padding:50px;border-radius:8px;text-align:center;color:#bbbbbb;box-shadow:0 0 40px rgba(255,0,0,0.6);border:2px solid #550000;'>"
                b"<h1 style='margin:0 0 20px 0;font-size:38px;color:#ff0000;text-transform:uppercase;letter-spacing:3px;text-shadow:0 0 15px rgba(255,0,0,0.9);'>401 - ACCESS DENIED</h1>"
                b"<p style='margin:0;font-size:18px;color:#888888;'>Invalid credentials or access denied.<br>Reload and try again.</p>"
                b"</div>"
                b"</body>"
                b"</html>"
            )
            try:
                self.send_response(401)
                self.send_header('WWW-Authenticate', 'Basic realm="SynchroGaea Secure Login"')
                self.send_header('Content-Type', 'text/html; charset=utf-8')
                self.send_header('Content-Length', str(len(body)))
                self.end_headers()
                self.wfile.write(body)
            except BrokenPipeError:
                pass
    def log_message(self, *_):
        pass
_EXPECTED_USER_HASH, _EXPECTED_PASS_HASH = check_or_create_password()
async def _broadcast_raw(data: bytes):
    if not _ws_clients:
        return
    clients = tuple(_ws_clients)
    results = await asyncio.gather(
        *[c.send(data) for c in clients],
        return_exceptions=True
    )
    for c, r in zip(clients, results):
        if isinstance(r, Exception):
            _ws_clients.discard(c)

async def _log(msg: str):
    print(msg, flush=True)
    await _broadcast_raw(_LOG_HDR + msg.encode("utf-8", "replace"))
async def _ws_handler(websocket):
    _ws_clients.add(websocket)
    await _log(f"{EVENT_TIME} >>> [WSS] Browser connected   {websocket.remote_address}")
    try:
        async for raw in websocket:
            if isinstance(raw, str):
                try:
                    d = json.loads(raw)
                    if d.get("cmd") == "PING":
                        pass
                    else:
                        await _handle_cmd(d)
                except Exception as ex:
                    await _log(f"{EVENT_TIME} >>> [CMD] Error: {ex}")
            elif isinstance(raw, bytes) and len(raw) > 1:
                ptype = raw[0]
                if ptype == 2:
                    w = _android_writer
                    if w:
                        payload = raw[1:]
                        await _to_app(w, 2, payload)
    except Exception:
        pass
    finally:
        _ws_clients.discard(websocket)
        await _log(f"{EVENT_TIME} >>> [WSS] Browser disconnected")
async def _handle_cmd(d: dict):
    w = _android_writer
    if w is None:
        await _log(f"{EVENT_TIME} >>> [CMD] No app connected")
        return
    cmd = d.get("cmd", "")
    if   cmd == "SET_QUALITY": await _to_app(w, 3, f"SET_QUALITY:{d['value']}".encode())
    elif cmd == "SET_RES":     await _to_app(w, 3, f"SET_RES:{d['value']}".encode())
    elif cmd == "VIBRATE":     await _to_app(w, 3, b"VIBRATE")
    elif cmd == "SET_RATE":    await _to_app(w, 3, f"SET_RATE:{d['value']}".encode())
    elif cmd == "SWITCH_CAM":  await _to_app(w, 3, f"SWITCH_CAM:{d['value']}".encode())
    elif cmd == "TORCH":       await _to_app(w, 3, b"TORCH")
async def _to_app(writer: asyncio.StreamWriter, ptype: int, payload: bytes):
    try:
        writer.write(bytes([ptype]) + struct.pack(">I", len(payload)) + payload)
        if writer.transport.get_write_buffer_size() > 65536:
            await writer.drain()
    except Exception as ex:
        await _log(f"{EVENT_TIME} >>> [APP] Send error: {ex}")
def get_fingerprint(crt_path):
    with open(crt_path, "rb") as f:
        cert_pem = f.read().decode()
        b64_data = "".join(cert_pem.splitlines()[1:-1])
        der_data = base64.b64decode(b64_data)
        return hashlib.sha256(der_data).hexdigest().lower()
def _build_ssl_ctx():
    try:
        from cryptography import x509
        from cryptography.x509.oid import NameOID
        from cryptography.hazmat.primitives import hashes, serialization
        from cryptography.hazmat.primitives.asymmetric import ec 
        from cryptography.hazmat.primitives.asymmetric import rsa
        import datetime
        key = ec.generate_private_key(ec.SECP256R1())
        name = x509.Name([x509.NameAttribute(NameOID.COMMON_NAME, u"synchrogaea")])
        now  = datetime.datetime.now(datetime.timezone.utc)
        cert = (x509.CertificateBuilder()
                .subject_name(name).issuer_name(name)
                .public_key(key.public_key())
                .serial_number(x509.random_serial_number())
                .not_valid_before(now)
                .not_valid_after(now + datetime.timedelta(days=3650))
                .sign(key, hashes.SHA256()))
        tmp      = tempfile.mkdtemp()
        crt_path = os.path.join(tmp, "srv.crt")
        key_path = os.path.join(tmp, "srv.key")
        with open(crt_path, "wb") as f:
            f.write(cert.public_bytes(serialization.Encoding.PEM))
        with open(key_path, "wb") as f:
            f.write(key.private_bytes(serialization.Encoding.PEM,
                    serialization.PrivateFormat.TraditionalOpenSSL,
                    serialization.NoEncryption()))
        ctx = ssl.SSLContext(ssl.PROTOCOL_TLS_SERVER)
        ctx.minimum_version = ssl.TLSVersion.TLSv1_3
        ctx.load_cert_chain(certfile=crt_path, keyfile=key_path)
        ctx.options |= ssl.OP_SINGLE_ECDH_USE
        ctx.options |= ssl.OP_NO_COMPRESSION
        return ctx, crt_path
    except Exception:
        return None, None #AnticrashSSL
_auth_failures = {}
async def _packet_loop(reader: asyncio.StreamReader,
                       writer: asyncio.StreamWriter, addr, mode: str):
    addr_ip = addr[0]
    now = time.time()
    if addr_ip in _auth_failures:
        fallimenti, ultimo_timestamp = _auth_failures[addr_ip]
        if fallimenti >= 3:
            if now - ultimo_timestamp < 60:
                print(f"{EVENT_TIME} >>> [SECURITY] IP {addr_ip} BANNED (Brute-force protection)")
                writer.close()
                return
            else:
                del _auth_failures[addr_ip]
    global _android_writer
    try:
        auth_hdr = await reader.readexactly(5)
        auth_type = auth_hdr[0]
        auth_len = struct.unpack_from(">I", auth_hdr, 1)[0]
        auth_payload = await reader.readexactly(auth_len)
        try:
            creds = auth_payload.decode('utf-8').split(':', 1)
            if len(creds) != 2: raise ValueError()
            u, p = creds
            u_hash = hashlib.sha256(u.encode()).hexdigest()
            s_salt, s_hash = _EXPECTED_PASS_HASH.split(":")
            p_hash = hashlib.sha256((s_salt + p).encode()).hexdigest()
            if u_hash != _EXPECTED_USER_HASH or p_hash != s_hash:
                fallimenti, _ = _auth_failures.get(addr_ip, (0, 0))
                _auth_failures[addr_ip] = [fallimenti + 1, time.time()]
                print(f"\033[91m{EVENT_TIME} >>> [APP] AUTH FAILED ({fallimenti + 1}/3): Invalid credentials from {addr}\033[0m")
                writer.write(bytes([255]))
                await writer.drain()
                return
        except Exception:
            print(f"\033[91m{EVENT_TIME} >>> [APP] AUTH ERROR: Malformed packet from {addr}\033[0m")
            return
        if addr_ip in _auth_failures: del _auth_failures[addr_ip]
        writer.write(b'\x00')
        await writer.drain()
        _android_writer = writer
        await _log(f"{EVENT_TIME} >>> [APP] Connected & Authorized ({mode}) {addr}")
        while True:
            hdr    = await reader.readexactly(5)
            ptype  = hdr[0]
            length = struct.unpack_from(">I", hdr, 1)[0]
            if length > MAX_PAYLOAD:
                await _log(f"{EVENT_TIME} >>> [APP] Oversized packet {length}B — dropping")
                break
            payload = await reader.readexactly(length) if length else b""
            if   ptype == 1 and payload: await _broadcast_raw(_FRAME_HDR + payload)
            elif ptype == 2 and payload: await _broadcast_raw(_AUDIO_HDR + payload)
            elif ptype == 130 and payload: await _broadcast_raw(bytes([130]) + payload)
            elif ptype == 3 and payload: await _log(f"{EVENT_TIME} >>> [APP] CMD: " + payload.decode("utf-8", "replace"))
            elif ptype == 4 and payload:
                global _video_counter
                _video_counter += 1
                import random
                mk_id = random.randint(1000000, 9999999)
                client_id = f"{addr[0]}_{addr[1]}"
                timestamp = time.strftime("%Y%m%d_%H%M%S")
                filename = f"GaeaSavedREC/REC_MK{mk_id}_{client_id}_{timestamp}_{_video_counter}.mp4"
                def _write_file(data, name):
                    with open(name, "wb") as f:
                        f.write(data)
                asyncio.create_task(asyncio.to_thread(_write_file, payload, filename))
                await _log(f"{EVENT_TIME} >>> [APP] BLACK_BOX: Video saved -> {filename} ({len(payload)} bytes)")
            elif ptype == 0:
                writer.write(b"\x00\x00\x00\x00\x05ALIVE")
                await writer.drain()
    except asyncio.IncompleteReadError:
        pass
    except Exception as ex:
        await _log(f"{EVENT_TIME} >>> [APP] Error: {ex}")
    finally:
        if _android_writer is writer:
            _android_writer = None
        try:
            writer.close()
            await writer.wait_closed()
        except Exception:
            pass
        await _log(f"{EVENT_TIME} >>> [APP] Disconnected {addr}")
async def _handler_tls(reader, writer):
    await _packet_loop(reader, writer, writer.get_extra_info("peername"), "TLS")
async def _handler_plain(reader, writer):
    await _packet_loop(reader, writer, writer.get_extra_info("peername"), "plain")
async def _main():
    try:
        from websockets.server import serve as ws_serve
    except ImportError:
        sys.exit("ERROR: run  pip install websockets  first")
    ssl_ctx, crt_path = _build_ssl_ctx()
    global _CURRENT_FINGERPRINT
    if crt_path:
        _CURRENT_FINGERPRINT = get_fingerprint(crt_path)
    else:
        _CURRENT_FINGERPRINT = "NO_TLS"
    print(f"  ")
    print(f"{MAGENTA}[SECURITY] Valid Fingerprint: {_CURRENT_FINGERPRINT}{RESET}")
    print(f"  ")
    os.makedirs("GaeaSavedREC", exist_ok=True)
    global _video_counter
    _video_counter = 0
    tls_port   = TCP_PORT
    plain_port = TCP_PORT + 1
    ws_srv = await ws_serve(_ws_handler, "0.0.0.0", WS_PORT,
                            ssl=ssl_ctx,
                            max_size=MAX_PAYLOAD, compression=None,
                            ping_interval=20, ping_timeout=60)
    httpd = HTTPServer(("0.0.0.0", HTTP_PORT), _Handler)
    web_proto = "http"
    if ssl_ctx:
        httpd.socket = ssl_ctx.wrap_socket(httpd.socket, server_side=True)
        web_proto = "https"
    threading.Thread(target=httpd.serve_forever, daemon=True, name="http").start()
    servers = []
    if ssl_ctx:
        tls_srv = await asyncio.start_server(
            _handler_tls, "0.0.0.0", tls_port,
            ssl=ssl_ctx, limit=TCP_READER_LIMIT, backlog=8
        )
        servers.append(tls_srv)
        tls_info = f"TLS  :9999  plain :10000"
    else:
        tls_info = "TLS disabled (pip install cryptography)"
    plain_srv = await asyncio.start_server(
        _handler_plain, "0.0.0.0", plain_port if ssl_ctx else tls_port,
        limit=TCP_READER_LIMIT, backlog=8
    )
    servers.append(plain_srv)
    import socket
    for srv in servers:
        for sock in srv.sockets:
            sock.setsockopt(socket.IPPROTO_TCP, socket.TCP_NODELAY, 1)
            sock.setsockopt(socket.SOL_SOCKET, socket.SO_SNDBUF, 65536)
    print("   ")
    print(f"{GREEN}{BOLD}╔══════════════════════════════════════════════════╗{RESET}")
    print(f"{GREEN}{BOLD}║           SynchroGaea Server  v4.4               ║{RESET}")
    print(f"{GREEN}{BOLD}╠══════════════════════════════════════════════════╣{RESET}")
    if ssl_ctx:
        print(f"{MAGENTA}║  Android TLS   →  0.0.0.0:{tls_port}  (try first)      ║{RESET}")
        print(f"{CYAN}║  Android plain →  0.0.0.0:{plain_port} (fallback)       ║{RESET}")
        print(f"{YELLOW}║  App field: YOUR_IP:{tls_port};YOUR_IP:{plain_port}           ║{RESET}")
    else:
        print(f"{CYAN}║  Android plain →  0.0.0.0:{tls_port}                   ║{RESET}")
    print(f"{CYAN}║  Web UI        →  https://0.0.0.0:{HTTP_PORT}           ║{RESET}")
    print(f"{CYAN}║  WebSocket     →  0.0.0.0:{WS_PORT}                   ║{RESET}")
    print(f"{GREEN}{BOLD}╠══════════════════════════════════════════════════╣{RESET}")
    print(f"{YELLOW}║  Open browser: https://127.0.0.1:{HTTP_PORT}            ║{RESET}")
    print(f"{GREEN}{BOLD}╚══════════════════════════════════════════════════╝{RESET}")
    print("   ")
    all_srv = [ws_srv] + servers
    for s in servers:
        await s.__aenter__()
    async with ws_srv:
        await asyncio.gather(
            ws_srv.serve_forever(),
            *[s.serve_forever() for s in servers]
        )
if __name__ == "__main__":
    try:
        asyncio.run(_main())
    except KeyboardInterrupt:
        print(f"\n{EVENT_TIME} >>> Server stopped.")